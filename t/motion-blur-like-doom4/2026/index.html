<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width">
    <title>Motion Blur like Doom4</title>
    <link rel="stylesheet" href="../../../archived.css" />
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']]}});
    </script>
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  </head>

  <body>
    <header class="header">
      <div class="title-span">
        <a href="../../../">
          <img src="../../../images/site-logo.png" height="40" alt="Urho3D" id="site-logo" />
        </a>
      </div>
    </header>

    <div class="main">
    <div class="archive-span">Archive 17/01/2023.</div>
    <h1 class="topic-title">Motion Blur like Doom4</h1>
            <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<p><a href="https://github.com/1vanK/Urho3DMotionBlur">github.com/1vanK/Urho3DMotionBlur</a></p>
<p>Use START_DEMO.bat for launch</p>
<p><img alt="" height="300" src="../../../images2/ec2854f03962bfe9ab67e4d898984d52.gif" width="400"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/222_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Bananaft</div>
          <div class="post_content">
<p>Looks really neat and smooth.<br/>
So it uses camera transform and only affected by camera motion? Or it uses full velocity vectors pass, and can blur many separated objects?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<p>[quote=“Bananaft”]Looks really neat and smooth.<br/>
So it uses camera transform and only affected by camera motion? Or it uses full velocity vectors pass, and can blur many separated objects?[/quote]</p>
<p>only camera motion</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/55_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rasteron</div>
          <div class="post_content">
<p>nice.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/87_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">sabotage3d</div>
          <div class="post_content">
<p>Its pretty cool. I am getting bugs on my OSX. The motion blur is jittering and there is motion blur only in some areas of the screen.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<aside class="quote">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/db4c02596e658dc9102b66ceb5fb9d80.png" width="20"/> sabotage3d:</div>
<blockquote>
<p>Its pretty cool. I am getting bugs on my OSX. The motion blur is jittering and there is motion blur only in some areas of the screen.</p>
</blockquote>
</aside>
<p>try to turn on vsync (options -v)</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<p>Also whether you are using the latest version of the engine?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/669_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Egorbo</div>
          <div class="post_content">
<p>Wow! looks nice, does it work on GLES iOS/Android?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<aside class="quote">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/dd5fc924d2032d28cd11f559a4c57f3c.png" width="20"/> Egorbo:</div>
<blockquote>
<p>Wow! looks nice, does it work on GLES iOS/Android?</p>
</blockquote>
</aside>
<p>I have not tested</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Cpl.Bator</div>
          <div class="post_content">
<p>Very nice ! ( with -v that work fine here ) , great job ! what the next ? dof ? <img alt=":smiley:" class="emoji" src="../../../images2/c16ddadcbd525aa6d219a1df596d362f.png" title=":smiley:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<aside class="quote no-group" data-username="Cpl.Bator">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/9ff884a7dba5557f3589863f85051340.png" width="20"/> Cpl.Bator:</div>
<blockquote>
<p>Very nice ! ( with -v that work fine here ) , great job ! what the next ? dof ? <img alt=":smiley:" class="emoji" src="../../../images2/7014497b1c97c810791a011290bda7f5.png" title=":smiley:"/></p>
</blockquote>
</aside>
<p>This shader is not finished yet (it uses an additional forward light pass for weapon and I can not solve a couple of issues). I have reworked version with mask for weapon, but additional texture affects performance</p>
<p>dof already implemented by monkeyfirst <a href="https://github.com/MonkeyFirst/urho3d-post-process-dof">github.com/MonkeyFirst/urho3d-post-process-dof</a> (but as far as I remember, there is need to improve)</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<p>Please test updated version. Whether there is a problems WITHOUT vsync? New version render scene to texture and blurs it there, but not just in the viewport</p>
<p>EDIT: for launch still use START_DEMO.bat</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Cpl.Bator</div>
          <div class="post_content">
<p>work fine without vsync.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<aside class="quote no-group" data-username="Cpl.Bator">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/9ff884a7dba5557f3589863f85051340.png" width="20"/> Cpl.Bator:</div>
<blockquote>
<p>work fine without vsync.</p>
</blockquote>
</aside>
<p>ok, but now it is impossible to turn off effect by tag, need use another renderpath without motion blur …</p>
<p>EDIT: although I have an idea</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/87_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">sabotage3d</div>
          <div class="post_content">
<p>It works properly with vsync it looks pretty cool.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<p>Have you problems with other shaders (Blur, Bloom) when VSync is disabled?</p>
<p>EDIT: a have a hypothesis that engine on some frames start showing viewport before bluring when vsync is disabled and fps is high<br/>
EDIT2: someone can test problem by using WithoutMask.bat in repo (u can change window size to 200x700 for increasing fps)</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3290_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Modanung</div>
          <div class="post_content">
<p>For some reason I had to use <span class="bbcode-i">-ap</span> flag for the Urho3DPlayer to locate the CoreData folder and then merge the Final folder into that one and the Data folder for it to find all the resources. Then I saw a baked room (Andrew Price’s right?) and a textured pistol, but <span class="bbcode-u">no blur</span>.<br/>
I’m on Xubuntu Linux 64-bit using the proprietary Nvidia drivers. Which - apart from the occasional heavy frame drops - tends to outperform the open Xorg drivers. Switching back to Xorg is a pain though, otherwise I’d be happy to test with those.<br/>
I’ve tried the <span class="bbcode-i">-v</span> option; no help.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<p>[quote=“Modanung”]For some reason I had to use <span class="bbcode-i">-ap</span> flag for the Urho3DPlayer to locate the CoreData folder and then merge the Final folder into that one and the Data folder for it to find all the resources. Then I saw a baked room (Andrew Price’s right?) and a textured pistol, but <span class="bbcode-u">no blur</span>.<br/>
I’m on Xubuntu Linux 64-bit using the proprietary Nvidia drivers. Which - apart from the occasional heavy frame drops - tends to outperform the open Xorg drivers. Switching back to Xorg is a pain though, otherwise I’d be happy to test with those.<br/>
I’ve tried the <span class="bbcode-i">-v</span> option; no help.[/quote]</p>
<p>Any warnings or errors in log?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3290_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Modanung</div>
          <div class="post_content">
<aside class="quote">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/ef19ff5c6f85c4920b8ebf7eda2e2ed6.png" width="20"/> 1vanK:</div>
<blockquote>
<p>Any warnings or errors in log?</p>
</blockquote>
</aside>
<p>None</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<p>I have no ideas. Try output in shader intermediate steps.</p>
<p>Weapon maskt:</p>
<p>[code]void PS()<br/>
{<br/>
float weaponmask = texture2DProj(sDiffMap, vScreenPos).a;</p>
<pre><code>gl_FragColor = vec4(weaponmask);
</code></pre>
<p>}<br/>
[/code]</p>
<p><a data-bbcode="true" href="http://savepic.ru/9855112.htm"><img alt="" height="" src="../../../images2/fe29df67fa871c218fb1ee029af5467f.png" width=""/></a></p>
<p>Depth:</p>
<p>[code]void PS()<br/>
{<br/>
float depth = ReconstructDepth(texture2DProj(sDepthBuffer, vScreenPos).r);</p>
<pre><code>gl_FragColor = vec4(depth * 20);
</code></pre>
<p>}<br/>
[/code]</p>
<p><a data-bbcode="true" href="http://savepic.ru/9849992.htm"><img alt="" height="" src="../../../images2/96b4562f71c47d93a4af459441b337a1.png" width=""/></a></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3290_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Modanung</div>
          <div class="post_content">
<p>I am getting identical result with those pixel shaders.</p>
<p>Also it turns out the path argument required to be enclosed in quotation marks to get all three folders across.</p>
<p>WithMask: Same as Final<br/>
WithoutMask: A screen filling flickering in tones of the room with the occasional contour of a window. The gun is rendered fine.<br/>
ViewportAlpha: Like Final, but with a pitch black gun.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<p>Try</p>
<p>[code]<br/>
void PS()<br/>
{<br/>
float weaponmask = texture2DProj(sDiffMap, vScreenPos).a;</p>
<pre><code>//gl_FragColor = vec4(mask);
//return;

if (weaponmask == 0)
{
    gl_FragColor = texture2DProj(sDiffMap, vScreenPos).rgba;
    return;
}

// HWDEPTH
float depth = ReconstructDepth(texture2DProj(sDepthBuffer, vScreenPos).r);



vec3 worldPos = vFarRay * depth / vScreenPos.w;
worldPos += cCameraPosPS;

vec4 oldClipPos = vec4(worldPos, 1.0) * cOldViewProj;
oldClipPos /= oldClipPos.w;

vec4 oldScreenPos = vec4(oldClipPos.x * vGBufferOffsets.z + vGBufferOffsets.x * oldClipPos.w,
                    oldClipPos.y * vGBufferOffsets.w + vGBufferOffsets.y * oldClipPos.w,
                    0.0, oldClipPos.w);

vec4 offset = (vScreenPos - oldScreenPos);
offset = offset / (cTimeStep * 20.0);

gl_FragColor = offset;
</code></pre>
<p>}[/code]</p>
<p>It should show different colors when you move a the mouse</p>
<p><a data-bbcode="true" href="http://savepic.ru/9836552.htm"><img alt="" height="" src="../../../images2/b020caa41bb076a7e23bffd7582a1089.png" width=""/></a></p>
<p>Also try to remove all comments from shader. May be it not works with UTF8 comments</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<p>Also are you using the latest version of the engine?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3290_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Modanung</div>
          <div class="post_content">
<aside class="quote">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/ef19ff5c6f85c4920b8ebf7eda2e2ed6.png" width="20"/> 1vanK:</div>
<blockquote>
<p>Also are you using the latest version of the engine?</p>
</blockquote>
</aside>
<p>Yep</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<p>Repo moved to <a href="https://github.com/1vanK/Urho3DMotionBlur">github.com/1vanK/Urho3DMotionBlur</a></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/87_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">sabotage3d</div>
          <div class="post_content">
<p>Is it possible to use the same technique for a depth of field effect?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<aside class="quote">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/db4c02596e658dc9102b66ceb5fb9d80.png" width="20"/> sabotage3d:</div>
<blockquote>
<p>Is it possible to use the same technique for a depth of field effect?</p>
</blockquote>
</aside>
<p>I think there is nothing in common. Even pixel blurring algorithm is other. Easier write a DOF shader from scratch,  than try to take something useful from this</p>
          </div>
        </div>
      </div>


    </div>
  </body>
</html>