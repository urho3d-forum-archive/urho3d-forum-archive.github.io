<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width">
    <title>Seams on tilemaps</title>
    <link rel="stylesheet" href="../../../archived.css" />
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']]}});
    </script>
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  </head>

  <body>
    <header class="header">
      <div class="title-span">
        <a href="../../../">
          <img src="../../../images/site-logo.png" height="40" alt="Urho3D" id="site-logo" />
        </a>
      </div>
    </header>

    <div class="main">
    <div class="archive-span">Archive 17/01/2023.</div>
    <h1 class="topic-title">Seams on tilemaps</h1>
            <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/123_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">kostik1337</div>
          <div class="post_content">
<p>Hello everybody, I am trying to load and display simple orthogonal timlemap, the problem is there are seams between same tiles. Picture below illustrates the problem<br/>
<img alt="Selection_006" height="500" src="//cdck-file-uploads-global.s3.dualstack.us-west-2.amazonaws.com/standard17/uploads/urho3d/original/2X/5/52e8367339072515e305e64dab4f817a40dc69f6.png" width="665"/><br/>
And here is minimalistic sample<br/>
<a class="onebox" href="https://www.dropbox.com/s/br391ke4pabrimq/test.zip?dl=0" rel="nofollow noopener" target="_blank">https://www.dropbox.com/s/br391ke4pabrimq/test.zip?dl=0</a><br/>
As you can see in sample, those seams desappear and appear again, when you move camera (with wsad). It looks like texture coordinates are moving a bit when you moving camera.<br/>
So, I’d like to know, why does this happen and how can I avoid it? One obvious solution is to add 1px border to each tile with the same color as tile, but this looks like hack, and probably won’t fix the problem fundamentally.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3290_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Modanung</div>
          <div class="post_content">
<p>This doesn’t work? <img alt=":wink:" class="emoji" src="../../../images2/95940790c23d98635b2a6d3f22657158.png" title=":wink:"/><br/>
<aside class="onebox whitelistedgeneric">
<header class="source">
<img class="site-icon" height="32" src="../../../images2/23d10de12650f96afe14b3b2bc894bfc.ico" width="32"/>
<a href="https://discourse.urho3d.io/t/sprite-texture-nearest-neighbour-filtering/3422/4?u=modanung" rel="nofollow noopener" target="_blank">Urho3D</a>
</header>
<article class="onebox-body">
<img class="thumbnail onebox-avatar" height="200" src="../../../images2/0c330e0cd1f8d709bc96658a66db867f.png" width="200"/>
<h3><a href="https://discourse.urho3d.io/t/sprite-texture-nearest-neighbour-filtering/3422/4?u=modanung" rel="nofollow noopener" target="_blank">Sprite/Texture Nearest Neighbour Filtering</a></h3>
<p>Well, this already has an answer, but I’d like to add - I fixed the same problem with  engineParameters_["TextureFilterMode"] = FILTER_NEAREST;  at Setup() of your Application, this sets filtering type for all textures, if they don’t have an xml file</p>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>
</p>
<p>I’d look at the map and tiles, but I’m not creating a Google account to download a file.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/123_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">kostik1337</div>
          <div class="post_content">
<aside class="quote" data-post="2" data-topic="3931">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/8b9decec7cc30729aa8f8f7015602d32.png" width="20"/> Modanung:</div>
<blockquote>
<p>This doesn’t work? <img alt=":wink:" class="emoji" src="../../../images2/95940790c23d98635b2a6d3f22657158.png" title=":wink:"/></p>
</blockquote>
</aside>
<p>Unfortunately, no, this makes no effect. I tried setting different filtering and address modes, they don’t seem to effect too.</p>
<aside class="quote" data-post="2" data-topic="3931">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/8b9decec7cc30729aa8f8f7015602d32.png" width="20"/> Modanung:</div>
<blockquote>
<p>I’d look at the map and tiles, but I’m not creating a Google account to download a file.</p>
</blockquote>
</aside>
<p>Huh? Dropbox doesn’t require you to have google account, just press “No thanks” button at the bottom.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<p>If sprite vertices are aligned and texture is good, there shan’t be any seams between. I saw similar problems in sample games, will investigate it later.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/123_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">kostik1337</div>
          <div class="post_content">
<p>Thanks. Also, i forgot to mention - if camera zoom is integer, those seams seem to be constant, moving camera does not affect them.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/123_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">kostik1337</div>
          <div class="post_content">
<p>I’ve done some research, and first off, Modanung was right. Changing filtering to nearest really fixed the problem on that map. My apologies, I should’ve tested it before.</p>
<p>But I’ve got similar problem on another map, and here it does not helps. More correct, it helps a bit, those seams appear quite rarely, but they are. This is what it looks like:</p>
<p><img alt="image" height="500" src="//cdck-file-uploads-global.s3.dualstack.us-west-2.amazonaws.com/standard17/uploads/urho3d/original/2X/9/9b2de1a7eee96eeb2794ac24fbd04a75e09e5ecb.png" width="640"/></p>
<p>Also, I’ve updated dropbox archive with new map.</p>
<p>I tried to place sprites on the scene by hand without TileMap, like this:</p>
<pre><code>Node@ spritesNode = scene_.CreateChild();
Texture2D@ texture = cache.GetResource("Texture2D", "grass9.png");
Sprite2D@ sprite = Sprite2D();
sprite.texture = texture;
sprite.rectangle = IntRect(32, 32, 64, 64);
Sprite2D@ sprite2 = Sprite2D();
sprite2.texture = texture;
sprite2.rectangle = IntRect(128, 32, 160, 64);

for (int r = 0; r&lt; 50; ++r) {
    for (int i = 0; i&lt; 50; ++i) {
        Node@ spriteNode = spritesNode.CreateChild("StaticSprite2D");
        spriteNode.position2D = Vector2(i * 32 * PIXEL_SIZE, r * 32 * PIXEL_SIZE);

        StaticSprite2D@ staticSprite = spriteNode.CreateComponent("StaticSprite2D");
        staticSprite.sprite = (r+i)%6 &lt; 3 ? sprite : sprite2;
    }
}
</code></pre>
<p>and problem stayed, so I believe, vertices are aligned and texture is OK.</p>
<p>Is there anything I should try?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<aside class="quote" data-post="7" data-topic="3931">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/b032fef93db80a84ba60ed10c6e1b100.png" width="20"/> kostik1337:</div>
<blockquote>
<p>More correct, it helps a bit, those seams appear quite rarely, but they are. This is what it looks like:</p>
</blockquote>
</aside>
<p><em>This</em> looks like bad texture. You just have dirty brown tile data.<br/>
Are these seams 100% visible?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/123_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">kostik1337</div>
          <div class="post_content">
<p>Can you elaborate, please? What do you mean at bad texture - a broken texture?<br/>
And what do you mean at 100% visible, you mean they are not transparent?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<aside class="quote" data-post="9" data-topic="3931">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/b032fef93db80a84ba60ed10c6e1b100.png" width="20"/> kostik1337:</div>
<blockquote>
<p>Can you elaborate, please? What do you mean at bad texture - a broken texture?</p>
</blockquote>
</aside>
<p>I mean that this “seam” isn’t program defect. It’s the defect of sprite data. The leftmost column of pixels of brown sprite is grass.</p>
<aside class="quote" data-post="9" data-topic="3931">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/b032fef93db80a84ba60ed10c6e1b100.png" width="20"/> kostik1337:</div>
<blockquote>
<p>And what do you mean at 100% visible, you mean they are not transparent?</p>
</blockquote>
</aside>
<p>I mean you always see these seams regardless of camera position, resolution and so on.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/123_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">kostik1337</div>
          <div class="post_content">
<blockquote>
<p>The leftmost column of pixels of brown sprite is grass.</p>
</blockquote>
<p>No, the brown sprite size is exactly 32x32 pixels, grass belongs to another tile. In Tiled tilemap looks OK.</p>
<blockquote>
<p>I mean you always see these seams regardless of camera position, resolution and so on.</p>
</blockquote>
<p>No, they appear sometimes, rather infrequently, when you move camera.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<aside class="quote" data-post="12" data-topic="3931">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/b032fef93db80a84ba60ed10c6e1b100.png" width="20"/> kostik1337:</div>
<blockquote>
<p>No, they appear sometimes, rather infrequently, when you move camera.</p>
</blockquote>
</aside>
<p>That sucks…<br/>
If you have fixed and valid sprite texture coords, it <em>must</em> look the same regardless of camera position. Could you scale it e.g. twice? To ensure that all texels are shown as 2x2 pixels.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3290_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Modanung</div>
          <div class="post_content">
<aside class="quote no-group" data-post="13" data-topic="3931" data-username="Eugene">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/ae663b3d37eca5ee603f9e0610f8f829.png" width="20"/> Eugene:</div>
<blockquote>
<p>Could you scale it e.g. twice?</p>
</blockquote>
</aside>
<p>The line glitches stay visible here after dividing the camera’s ortho size by two, doubling it’s zoom or scaling the map’s node.<br/>
To me they do seem part of the neighbouring tiles (in the set) though. Using the <code>-tf 0</code> option, btw.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/1164_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">orefkov</div>
          <div class="post_content">
<p>Do you see <a href="https://discourse.urho3d.io/t/cannot-get-rid-of-lines-around-staticsprite2d/3798/6">Cannot get rid of lines around StaticSprite2D</a> ?<br/>
Perhaps it is the same problem and solution.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<p>I inveestigated your issue.<br/>
<code>Sprite2D</code> has tune parameter <code>edgeOffset_</code> that is used to avoid edge bleeding.<br/>
Tile map doesn’t use it in any way, but it definetely should.<br/>
Unfortunatelly, <code>Sprite2D</code> is <em>resource</em> and <code>TmxFile2D</code> that creates it is resource too.<br/>
So you couldn’t just add new paramter to some component.</p>
<p>Solutions:</p>
<ul>
<li>Hard-code constant in <code>TmxFile2D</code>
</li>
<li>Put some extra data into <code>TmxFile2D</code>
</li>
<li>Add an ability to change the constant at the level of <code>StaticSprite2D</code> and so expose it into <code>TileMap2D</code>
</li>
</ul>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/123_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">kostik1337</div>
          <div class="post_content">
<p>Wow! Works perfectly, big thanks!<br/>
I’ve googled a bit about texture bleeding, and as I can see, edgeOffset of 0.5 is perfect. So, my temporary workaround is:</p>
<pre><code>void SetTextureEdgeOffsetRecursively(Node@ n) {
    Node@[]@ children = n.GetChildren();
    for (uint i=0; i &lt; children.length; ++i) {
        if (children[i].HasComponent("StaticSprite2D")) {
            StaticSprite2D@ staticSprite = children[i].GetComponent("StaticSprite2D");
            staticSprite.sprite.textureEdgeOffset = 0.5;
        }
        SetTextureEdgeOffsetRecursively(children[i]);
    }
}
</code></pre>
<p>I think, I’ll put extra data into TmxFile2D an make a PR</p>
          </div>
        </div>
      </div>


    </div>
  </body>
</html>