<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width">
    <title>Geometry shaders (GL)</title>
    <link rel="stylesheet" href="../../../archived.css" />
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']]}});
    </script>
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  </head>

  <body>
    <header class="header">
      <div class="title-span">
        <a href="../../../">
          <img src="../../../images/site-logo.png" height="40" alt="Urho3D" id="site-logo" />
        </a>
      </div>
    </header>

    <div class="main">
    <div class="archive-span">Archive 17/01/2023.</div>
    <h1 class="topic-title">Geometry shaders (GL)</h1>
            <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/119_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">codingmonkey</div>
          <div class="post_content">
<p>Hi folks)<br/>
Earlier I wrote GS-shaders support on GL renderer but I have some strange bug then I try to edit these GS shaders in liveEdit manner. I got an double linkage error.<br/>
But today, I found what my bug with GS-shaders are gone somewhere )<br/>
so I decided to share this, GS shaders seems quite working<br/>
just an example:</p>
<p>Techniques: DiffGS.xml</p>
<pre><code class="lang-auto">&lt;technique vs="UnlitGS" ps="UnlitGS" gs="UnlitGS" psdefines="DIFFMAP"&gt;
    &lt;pass name="base" /&gt;
&lt;/technique&gt;</code></pre>
<details>
<summary>
Shader: UnlitGS.glsl</summary>
<p><a href="https://pastebin.com/pyHtvanq">https://pastebin.com/pyHtvanq</a></p>
</details>
<div class="onebox lazyYT" data-height="270" data-parameters="feature=oembed&amp;wmode=opaque" data-width="480" data-youtube-id="4R39AavxWSg" data-youtube-title="Urho3D GL Geometry Shaders test">
<a href="https://www.youtube.com/watch?v=4R39AavxWSg" target="_blank">
<img class="ytp-thumbnail-image" height="270" src="../../../images2/9387b3c1162a10fb5cf97f19f66d213e.jpg" title="Urho3D GL Geometry Shaders test" width="480"/>
</a>
</div>
<aside class="onebox whitelistedgeneric">
<header class="source">
<img class="site-icon" height="32" src="../../../images2/0973ea8ce7121c320f68413e2a2f23ab.svg" width="32"/>
<a href="https://github.com/MonkeyFirst/Urho3D/tree/gs-shader-gl" target="_blank">GitHub</a>
</header>
<article class="onebox-body">
<img class="thumbnail onebox-avatar" height="400" src="https://avatars1.githubusercontent.com/u/9577466?s=400&amp;v=4" width="400"/>
<h3><a href="https://github.com/MonkeyFirst/Urho3D/tree/gs-shader-gl" target="_blank">MonkeyFirst/Urho3D</a></h3>
<p>Cross-platform 2D and 3D game engine. Contribute to MonkeyFirst/Urho3D development by creating an account on GitHub.</p>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>

          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/87_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">sabotage3d</div>
          <div class="post_content">
<p>That was in my wishlist. Awesome work!</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Simply awesome  <img alt=":stuck_out_tongue:" class="emoji" src="../../../images2/31a2303e479834609bf5befdf8c3501a.png" title=":stuck_out_tongue:"/><br/>
Many thanks for sharing.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/119_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">codingmonkey</div>
          <div class="post_content">
<p>thanks guys )<br/>
now I add “primitive mode” selection in material for properly input GS layout work:<br/>
I mean this GS input layouts:</p>
<blockquote>
<p>layout (points) in;<br/>
layout (lines) in;<br/>
layout (triangles) in;</p>
</blockquote>
<p>test with GS shades : UnlitGSPointsToQuads.glsl<br/>
<a data-bbcode="true" href="http://savepic.su/6899872.htm"><img alt="" height="" src="../../../images2/dd992bab2bdd2dc3e7e4bdb434102a64.png" width=""/></a><br/>
<div class="onebox lazyYT" data-height="270" data-parameters="feature=oembed&amp;wmode=opaque" data-width="480" data-youtube-id="fliHze4-JN0" data-youtube-title="Primitives input mode">
<a href="https://www.youtube.com/watch?v=fliHze4-JN0" target="_blank">
<img class="ytp-thumbnail-image" height="270" src="../../../images2/a8415500e8a2ecaac359aeb2c217123b.jpg" title="Primitives input mode" width="480"/>
</a>
</div>
</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">franck22000</div>
          <div class="post_content">
<p>Nice job <img alt=":slight_smile:" class="emoji" src="../../../images2/ab33f6c546ca85e7d84a4e3c32cd4034.png" title=":slight_smile:"/> Can we expect this for DX11 ? <img alt=":slight_smile:" class="emoji" src="../../../images2/ab33f6c546ca85e7d84a4e3c32cd4034.png" title=":slight_smile:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/119_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">codingmonkey</div>
          <div class="post_content">
<p>I would like also to see a similar on dx11, but I do not know much dx11( so maybe someone who knows someday implement similar stuff.<br/>
Also, why you do not do this yourself ? <img alt=":slight_smile:" class="emoji" src="../../../images2/ab33f6c546ca85e7d84a4e3c32cd4034.png" title=":slight_smile:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/55_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rasteron</div>
          <div class="post_content">
<p>nice one! <img alt=":slight_smile:" class="emoji" src="../../../images2/ab33f6c546ca85e7d84a4e3c32cd4034.png" title=":slight_smile:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>Thanks for sharing. Really interesting.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/119_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">codingmonkey</div>
          <div class="post_content">
<blockquote>
<p>Thanks for sharing. Really interesting.<br/>
No problems) I hope sometime urho3D will be fully support GS shaders on both gapi DX11/GL )</p>
</blockquote>
<p>few new additions:</p>
<ul>
<li>Add oriented billboards example shader, it can rotates around eye axis by uniform “angle” and change size of billboards by “offset” uniform</li>
<li>Add wireframe shader example (no needed second geometry passes draw with lines) We add new attributes for vertexes in GS shader to calc wireframe lines in PS.<br/>
<a data-bbcode="true" href="http://savepic.su/6929408.htm"><img alt="" height="" src="../../../images2/e19aac16283d0d33e0a56fd396804529.png" width=""/></a>
</li>
</ul>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/55_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rasteron</div>
          <div class="post_content">
<aside class="quote">
<blockquote>
<p>- Add wireframe shader example (no needed second geometry passes draw with lines) We add new attributes for vertexes in GS shader to calc wireframe lines in PS.</p>
</blockquote>
</aside>
<p>Great update codingmonkey! I like the wireframe shader, is it easy to add other textures other than diffuse?  <img alt=":slight_smile:" class="emoji" src="../../../images2/ab33f6c546ca85e7d84a4e3c32cd4034.png" title=":slight_smile:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">franck22000</div>
          <div class="post_content">
<p>Im trying to implement it for DX11 right now <img alt=":slight_smile:" class="emoji" src="../../../images2/ab33f6c546ca85e7d84a4e3c32cd4034.png" title=":slight_smile:"/></p>
<p>If i need any help i will ask it here. With your great work CodingMonkey it’s time to add geometry shaders support in Urho3D !</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/119_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">codingmonkey</div>
          <div class="post_content">
<blockquote>
<p>Im trying to implement it for DX11 right now<br/>
good news) it will be awesome to have similar stuff on dx11 also</p>
</blockquote>
<blockquote>
<p>is it easy to add other textures other than diffuse?<br/>
Did you mean LitSolid shader and all variants of it? Probably yes, it possible.<br/>
But first of all, we need began use structs in shaders, for solve one interface block issue with passing through VS&lt;-&gt;GS (vec4 vShadowPos[NUMCASCADES]<img alt=":wink:" class="emoji" src="../../../images2/95940790c23d98635b2a6d3f22657158.png" title=":wink:"/><br/>
See this topic for clarify: <a href="https://www.opengl.org/discussion_boards/showthread.php/175872-geometry-shaders-and-varying-arrays">opengl.org/discussion_board … ing-arrays</a> (post <span class="hashtag">#4</span> from Alfonse Reinheart)<br/>
I try to create std LitSolid shader (without GS part) with using structs (IN/OUT) but it’s not working properly.</p>
</blockquote>
<div class="spoiler">
<p>[pastebin]q6mXQ3X7[/pastebin]</p>
</div>
<p>Model(Jack) - is fully black colored. I do not know why. Probably I create an Issue for figure out with this.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">franck22000</div>
          <div class="post_content">
<p>I have spotted an issue in shaderprecache.cpp in your branch. at line 142:</p>
<p>ShaderVariation* gs = graphics-&gt;GetShader(GS, shader.GetAttribute(“gs”), psDefines);</p>
<p>“psDefines” should be “gsDefines” i think ? <img alt=":slight_smile:" class="emoji" src="../../../images2/ab33f6c546ca85e7d84a4e3c32cd4034.png" title=":slight_smile:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/119_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">codingmonkey</div>
          <div class="post_content">
<p>oh, yes. thanks, i’m fix this)</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">franck22000</div>
          <div class="post_content">
<p>I have made my DX11 geometry shader branch based on CodingMoney work. Im still working on this (make an HLSL shader and testing it)</p>
<p><a href="https://github.com/OldSnake22/Urho3D/tree/DX11GeometryShaders" rel="nofollow noopener">github.com/OldSnake22/Urho3D/tr … tryShaders</a></p>
<p>Feel free to take a look and spot my eventual mistakes.</p>
<p>Please note that the code tabs formating issue will be of course fixed.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/119_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">codingmonkey</div>
          <div class="post_content">
<p>[quote]// TODO: Change this<br/>
1021 1049  Pair&lt;ShaderVariation*, ShaderVariation*&gt; key = MakePair(vertexShader_, pixelShader_);  [/quote]</p>
<p>I guess you need also create second level of pair for this :<br/>
like so<br/>
Pair&lt;ShaderVariation*, ShaderVariation*&gt; baseCombination(vs, ps);<br/>
Pair&lt;ShaderVariation*, Pair&lt;ShaderVariation*, ShaderVariation*&gt;&gt; combination(gs, baseCombination);</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">franck22000</div>
          <div class="post_content">
<p>Yes thank you for your advice <img alt=":slight_smile:" class="emoji" src="../../../images2/ab33f6c546ca85e7d84a4e3c32cd4034.png" title=":slight_smile:"/></p>
<p>I have also spotted that if i am right you do not check “gs” pointer validity in this function ShaderPrecache::StoreShaders()</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/119_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">codingmonkey</div>
          <div class="post_content">
<p>ok, now look at this</p>
<pre><code class="lang-auto">void ShaderPrecache::StoreShaders(ShaderVariation* vs, ShaderVariation* ps, ShaderVariation* gs)
{
    if (!vs || !ps)
        return;

    // Check for duplicate using pointers first (fast)
    Pair&lt;ShaderVariation*, ShaderVariation*&gt; shaderPair = MakePair(vs, ps);
    Pair&lt;ShaderVariation*, Pair&lt;ShaderVariation*, ShaderVariation*&gt;&gt; shaderCombination = MakePair(gs, shaderPair);
    if (usedPtrCombinations_.Contains(shaderCombination))
        return;
    usedPtrCombinations_.Insert(shaderCombination);

    String vsName = vs-&gt;GetName();
    String psName = ps-&gt;GetName();
    String gsName = gs != 0 ? gs-&gt;GetName() : "";
    const String&amp; vsDefines = vs-&gt;GetDefines();
    const String&amp; psDefines = ps-&gt;GetDefines();
    const String&amp; gsDefines = gs != 0 ? gs-&gt;GetDefines() : "";
    // Check for duplicate using strings (needed for combinations loaded from existing file)
    String newCombination = "";
    if (!gsName.Empty())
        newCombination = vsName + " " + vsDefines + " " + psName + " " + psDefines + " " + gsName + " " + gsDefines;
    else
        newCombination = vsName + " " + vsDefines + " " + psName + " " + psDefines;

    if (usedCombinations_.Contains(newCombination))
        return;
    usedCombinations_.Insert(newCombination);

    XMLElement shaderElem = xmlFile_.GetRoot().CreateChild("shader");
    shaderElem.SetAttribute("vs", vsName);
    shaderElem.SetAttribute("vsdefines", vsDefines);
    shaderElem.SetAttribute("ps", psName);
    shaderElem.SetAttribute("psdefines", psDefines);
    
    if (!gsName.Empty()) 
    {
        shaderElem.SetAttribute("gs", gsName);
        shaderElem.SetAttribute("gsdefines", gsDefines);
    }
}</code></pre>
<p>GS is optional part of shader that’s why we do not need check it  similar as - if (!vs || !ps) return.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/119_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">codingmonkey</div>
          <div class="post_content">
<p>well, with my trying to bring litSolid shader on GS-rails gives some results<br/>
but i found what GS shader also need copy all VSdefinitions to pass all varyings(output variables) through GS shader into PS properly.<br/>
the problem with passing vShadowPos[NUMCASCADES]; through GS shader into PS i try to solve with mat4 without using structs in shaders (actually structs also working well), to avoid additional index in data.<br/>
VS write in mat4:</p>
<p><code>    #ifdef PERPIXEL
        #ifdef SHADOW
            out mat4 vShadowPos;
        #endif</code></p>
<pre><code class="lang-auto">        #ifdef SHADOW
            // Shadow projection: transform from world space to shadow space
            for (int i=0; i &lt; NUMCASCADES; i++) 
                vShadowPos[i] = GetShadowPos(i, projWorldPos);
            
        #endif</code></pre>
<p>in GS we have 3 matrixes input, by one for each vertex output</p>
<pre><code class="lang-auto">#ifdef PERPIXEL
    #ifdef SHADOW
        in mat4 vShadowPos[3];</code></pre>
<p>and one for output into PS</p>
<pre><code class="lang-auto">#ifdef PERPIXEL
    #ifdef SHADOW
        out mat4 gsShadowPos;
    #endif</code></pre>
<p>GS emit shadow mat4 for vertex</p>
<pre><code class="lang-auto">        #ifdef PERPIXEL
            #ifdef SHADOW
                gsShadowPos = vShadowPos[i];
            #endif</code></pre>
<p>after all PS gets one matrix and parse it</p>
<p><code>    #ifdef PERPIXEL
        #ifdef SHADOW
            in mat4 gsShadowPos;
        #endif</code></p>
<pre><code class="lang-auto">        #ifdef SHADOW
            vec4 vShadowPos[NUMCASCADES];
            for (int i=0; i &lt; NUMCASCADES; i++)
                vShadowPos[i] = gsShadowPos[i];
            diff *= GetShadow(vShadowPos, gsWorldPos.w);
        #endif</code></pre>
<p>but still i have some visual bugs with shading of model.</p>
<p>Edit:<br/>
I’am restore my brunch with GS with current master<br/>
now actual repo: <a href="https://github.com/MonkeyFirst/Urho3D/tree/gs-shader-gl">github.com/MonkeyFirst/Urho3D/tree/gs-shader-gl</a><br/>
<a data-bbcode="true" href="http://savepic.net/7845374.htm"><img alt="" height="" src="../../../images2/38d7e6c8b5c6729574a0f0e74e9941f0.png" width=""/></a></p>
<p>Known bugs:<br/>
bug1: [solved (with adding “gsi” to same place with vsi, psi )]forward renderer material based on DiffNormal+Packed tech some light problems (dark objects), DS work fine in this case.<br/>
bug2: CustomGeometry bug glitch of mesh (for example editor grid)</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/222_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Bananaft</div>
          <div class="post_content">
<p>Hi, what is the status of this work? Are you planing to do a PR?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/119_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">codingmonkey</div>
          <div class="post_content">
<p>Hi, currently it frozen. Also I guess render has a lot new changes and i’m not familiar with this new changes yet.<br/>
Maybe later I start new work for rewrite old GS-brunch for new gl-renderer and mb also for PR.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">cadaver</div>
          <div class="post_content">
<p>Right now I’ve a branch going where I unify all graphics APIs to use the same header files (API-specific details should be hidden inside unions or pimpl when necessary), and put API-independent parts of the graphics classes (e.g. calculating vertex element offsets) in their own files. This probably affects your work too, but hopefully will make writing for multiple APIs less tedious in the future. This should be ready in a week or so.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/119_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">codingmonkey</div>
          <div class="post_content">
<p>ok, I will be waiting for PR, and then try to figure out with new changes in renderer, and how I may inject my previous gs-brunch into it.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">najak3d</div>
          <div class="post_content">
<p>We really would like to have geometry shaders for Urho.  We want to use it for smooth line drawing (so that we can translate a simple array of Line Points into a 3D line with thickness and smoothed edges).  So the geometry would preserve the mid-line, and also create two outlines – and then the pixel shader would do a transparency falloff as it neared the edges.  This would create the smoothing effect desired.  (This is one implementation.)</p>
<p>Without Geometry shaders, we’ll have to generate 4 triangles per line segment manually. We can do this too, but I think it’s more appropriate (and efficient) to instead just feed in a simple array of points.</p>
<p>What is the difficulty of getting Geometry shaders implemented in Urho?  We could supply some funding for it, if the cost is reasonable, and it helps get the job done.</p>
          </div>
        </div>
      </div>


    </div>
  </body>
</html>