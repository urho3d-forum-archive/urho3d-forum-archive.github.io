<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width">
    <title>Creating first UrhoApp project on Windows to Android</title>
    <link rel="stylesheet" href="../../../archived.css" />
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']]}});
    </script>
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  </head>

  <body>
    <header class="header">
      <div class="title-span">
        <a href="../../../">
          <img src="../../../images/site-logo.png" height="40" alt="Urho3D" id="site-logo" />
        </a>
      </div>
    </header>

    <div class="main">
    <div class="archive-span">Archive 17/01/2023.</div>
    <h1 class="topic-title">Creating first UrhoApp project on Windows to Android</h1>
            <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Maco</div>
          <div class="post_content">
<p>Hello i tried this but get error while building<br/>
rake new[UrhoApp,demo]<br/>
gradlew.bat build</p>
<pre><code class="lang-auto">        at java.lang.Thread.run(Thread.java:748)
    Caused by: java.lang.RuntimeException: java.nio.file.DirectoryNotEmptyException: C:\Urho3D\demo\UrhoApp\app\build\intermediates\merged_assets\debug\out\CoreData
        at com.android.ide.common.resources.MergedAssetWriter$AssetWorkAction.run(MergedAssetWriter.java:97)
        at com.android.build.gradle.internal.tasks.Workers$ActionFacade.run(Workers.kt:242)
        at org.gradle.workers.internal.AdapterWorkAction.execute(AdapterWorkAction.java:57)
        at org.gradle.workers.internal.DefaultWorkerServer.execute(DefaultWorkerServer.java:63)
        at org.gradle.workers.internal.NoIsolationWorkerFactory$1$1.create(NoIsolationWorkerFactory.java:67)
        at org.gradle.workers.internal.NoIsolationWorkerFactory$1$1.create(NoIsolationWorkerFactory.java:63)
        at org.gradle.internal.classloader.ClassLoaderUtils.executeInClassloader(ClassLoaderUtils.java:97)
        at org.gradle.workers.internal.NoIsolationWorkerFactory$1.lambda$execute$0(NoIsolationWorkerFactory.java:63)
        at org.gradle.workers.internal.AbstractWorker$1.call(AbstractWorker.java:44)
        at org.gradle.workers.internal.AbstractWorker$1.call(AbstractWorker.java:41)
        at org.gradle.internal.operations.DefaultBuildOperationRunner$CallableBuildOperationWorker.execute(DefaultBuildOperationRunner.java:200)
        at org.gradle.internal.operations.DefaultBuildOperationRunner$CallableBuildOperationWorker.execute(DefaultBuildOperationRunner.java:195)
        at org.gradle.internal.operations.DefaultBuildOperationRunner$3.execute(DefaultBuildOperationRunner.java:75)
        at org.gradle.internal.operations.DefaultBuildOperationRunner$3.execute(DefaultBuildOperationRunner.java:68)
        at org.gradle.internal.operations.DefaultBuildOperationRunner.execute(DefaultBuildOperationRunner.java:153)
        at org.gradle.internal.operations.DefaultBuildOperationRunner.execute(DefaultBuildOperationRunner.java:68)
        at org.gradle.internal.operations.DefaultBuildOperationRunner.call(DefaultBuildOperationRunner.java:62)
        at org.gradle.internal.operations.DefaultBuildOperationExecutor.lambda$call$2(DefaultBuildOperationExecutor.java:76)
        at org.gradle.internal.operations.UnmanagedBuildOperationWrapper.callWithUnmanagedSupport(UnmanagedBuildOperationWrapper.java:54)
        at org.gradle.internal.operations.DefaultBuildOperationExecutor.call(DefaultBuildOperationExecutor.java:76)
        at org.gradle.workers.internal.AbstractWorker.executeWrappedInBuildOperation(AbstractWorker.java:41)
        at org.gradle.workers.internal.NoIsolationWorkerFactory$1.execute(NoIsolationWorkerFactory.java:60)
        at org.gradle.workers.internal.DefaultWorkerExecutor.lambda$submitWork$2(DefaultWorkerExecutor.java:200)
        at java.util.concurrent.FutureTask.run(FutureTask.java:266)
        at org.gradle.internal.work.DefaultConditionalExecutionQueue$ExecutionRunner.runExecution(DefaultConditionalExecutionQueue.java:215)
        at org.gradle.internal.work.DefaultConditionalExecutionQueue$ExecutionRunner.runBatch(DefaultConditionalExecutionQueue.java:164)
        at org.gradle.internal.work.DefaultConditionalExecutionQueue$ExecutionRunner.run(DefaultConditionalExecutionQueue.java:131)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at java.util.concurrent.FutureTask.run(FutureTask.java:266)
        ... 6 more
    Caused by: java.nio.file.DirectoryNotEmptyException: C:\Urho3D\demo\UrhoApp\app\build\intermediates\merged_assets\debug\out\CoreData
        at sun.nio.fs.WindowsFileCopy.copy(WindowsFileCopy.java:162)
        at sun.nio.fs.WindowsFileSystemProvider.copy(WindowsFileSystemProvider.java:278)
        at java.nio.file.Files.copy(Files.java:1274)
        at com.android.ide.common.resources.MergedAssetWriter$AssetWorkAction.run(MergedAssetWriter.java:94)
        ... 34 more


FAILURE: Build failed with an exception.

* What went wrong:
Execution failed for task ':app:mergeDebugAssets'.
&gt; A failure occurred while executing com.android.build.gradle.internal.tasks.Workers$ActionFacade
   &gt; java.nio.file.DirectoryNotEmptyException: C:\Urho3D\demo\UrhoApp\app\build\intermediates\merged_assets\debug\out\CoreData

* Try:
Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output. Run with --scan to get full insights.
</code></pre>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">SirNate0</div>
          <div class="post_content">
<aside class="quote no-group" data-post="1" data-topic="6978" data-username="Maco">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/9b915f7b3dcf0ef848ce4a2875ba994b.png" width="20"/> Maco:</div>
<blockquote>
<p><code>java.nio.file.DirectoryNotEmptyException: C:\Urho3D\demo\UrhoApp\app\build\intermediates\merged_assets\debug\out\CoreData</code></p>
</blockquote>
</aside>
<p>Never used rake for my projects, and it’s been years since I built for Android on Windows, but did you maybe have a build that failed in the middle and left something in the directory that the build system seems to expect to be empty?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Maco</div>
          <div class="post_content">
<p>before build there was no build folder while building it creating itself and gets error</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>I must admit the Android build on Windows host is not well tested, at least we don’t have it on CI yet. And, also it requires a manual correction that is currently undocumented for Windows host. As I recall it, I could not get the Android Gradle plugin to setup the “assets” directory as I originally wanted that works for Linux/macOS/Windows. I have mentioned my ordeal in this forum somewhere, but you will have to go search for it yourself. Suffice to say, in the end I have to live it with a working out of the box solution for Linux and macOS only because it relies on the concept of “symbolic link”, which Windows host does not support (no, I am not referring to mklink). Obviously I don’t want to check in the same assets twice in different places in our GitHub project. But either I am stupid or the Android plugin is stupid that I cannot declaratively split the content of the “bin” directory so that the “CoreData” go to one place (<code>android/urho3d-lib/src/main/assets</code>) and the “Data” go to another (<code>android/launcher-app/src/main/assets</code>). Why I mentioned this will be apparent shortly. I gave up and took a shortcut by making them as symbolic links.</p>
<p>At the time I was developing the new Android build system based on Gradle so that it would work with Android Studio, I have decided not to change the existing Urho3D project by too much. However, I was ambitious enough to want to have a separation between building the Urho3D library as AAR and building the Urho3D demo as Android app that depends on this AAR. So, where is the problem, you may ask. Well, you see Urho3D project has always provided the assets in the “CoreData” and “Data” (we can ignore “Autoload” for this discussion) relative to the project root. I have chosen to “CoreData” to be packaged inside the AAR, while the “Data” to be in the downstream app. Note that downstream app can put anything inside this “Data” directory in theory, not just the one provided by the Urho3D project. When building the app with the Urho3D AAR, the Gradle build system will automatically try to merge the assets directory found in the AAR with the one found in the individual app. Thus, the error you got looks like you have “CoreData” to be made available in both AAR side and the app side. This could happen if you have replaced the “symlinks” that I mentioned above wrongly. Make sure you copy the “bin/CoreData” only to the “urho3d-lib”, while “bin/Data” only to “launcher-app”.</p>
<p>HTH</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">SirNate0</div>
          <div class="post_content">
<aside class="quote no-group" data-post="4" data-topic="6978" data-username="weitjong">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/8c3888d68a9e52e853f0724aae6cefb6.png" width="20"/> weitjong:</div>
<blockquote>
<p>it relies on the concept of “symbolic link”, which Windows host does not support (no, I am not referring to mklink).</p>
</blockquote>
</aside>
<p>I’ve been trying to figure out the answer on Google for half an hour, but what are the relevant differences that makes the Windows symbolic links/directory junctions not a suitable alternative for the build system?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>Well, the symlinks are actually checked in into git repository. As git came from the Linux world, it works with symlinks. Checking out a symlink from repo also just works. Those symlinks are not created on the fly dynamically, if they do then yes, we could probably put an if somewhere to choose between mklink and genuine symlinks.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">SirNate0</div>
          <div class="post_content">
<p>I think it may be possible now to get git to work with symlinks in Windows, though it looks like it takes some work to set up:</p>
<p><a class="onebox" href="https://www.joshkel.com/2018/01/18/symlinks-in-windows/" rel="noopener nofollow ugc" target="_blank">https://www.joshkel.com/2018/01/18/symlinks-in-windows/</a></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>It would be nice that Windows could support symlinks correctly like all the other systems and all the tools will enable the support by default.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/1437_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">elix22</div>
          <div class="post_content">
<p>I am not using rake ( I am not following the latest Urho3D master)<br/>
I am using Gradle tasks to do all the work , also to copy my assets .<br/>
Works great and fast on all platforms.</p>
<p>Some example below :</p>
<pre><code class="lang-auto">Make sure you delete these 2 folders entirely , (this is causing the error that you see on Windows)
Urho3D/android/launcher-app/src/main/assets
Urho3D/android/urho3d-lib/src/main/assets
</code></pre>
<pre><code class="lang-auto">Add  below task to
android/launcher-app/build.gradle.kts

tasks {
...
...
...
    register&lt;Copy&gt;("CopyAssets") {
        from ("../../bin")
        into ("src/main/assets")
    }  
}
</code></pre>
<p>Example of using it</p>
<pre><code class="lang-auto">gradlew CopyAssets assembleDebug -P URHO3D_LUA=0  -P URHO3D_LIB_TYPE=SHARED
</code></pre>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>The Rake task is just another wrapper. Whether you use the cmake_android.bat or cmake_android.sh or call the gradle wrapper directly, it makes absolutely no difference. The key thing is to match the instructions with the commit/version of the source tree. The latest version in the master branch has moved away from the old way where people needs to hack into Urho3D build system in order to build their own Android project. With the new way, you just need to get the AAR ready and use the AAR library in your own project cleanly. So, the above instruction combining with AAR approach will actually produce the issue reported by the OP.</p>
<p>EDIT: I stand corrected. If you meant to delete “CoreData” from the AAR side and then add it back on the app side then of course it would work. However, the idea is to have the AAR build once and reuse multiple times and that it should be self-sufficient, so I still reject the above as correct workaround solution for Windows host.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/1437_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">elix22</div>
          <div class="post_content">
<aside class="quote no-group" data-post="10" data-topic="6978" data-username="weitjong">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/8c3888d68a9e52e853f0724aae6cefb6.png" width="20"/> weitjong:</div>
<blockquote>
<p>If you meant to delete “CoreData” from the AAR side and then add it back on the app side then of course it would work</p>
</blockquote>
</aside>
<p>Yes , that’s exactly what I meant in my solution .<br/>
Moving “CoreData”  to the app side doesn’t contradicts building  AAR once and reuse it .<br/>
By the end of the day you need both “CoreData” and “Data” to make a working APK .</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>Although the end of the merge result is the same, the user of the AAR will need to have multiple copies “CoreData” in each downstream app projects. Additionally, it will also make the AAR built from Windows host to be different than the one built from the rest of us on the other side of the digital divide.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3290_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Modanung</div>
          <div class="post_content">
<p>Paths free of escape characters would also be an improvement. <span class="spoiler"><strong><span class="hashtag">#bat-country</span></strong></span></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/1437_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">elix22</div>
          <div class="post_content">
<aside class="quote no-group" data-post="12" data-topic="6978" data-username="weitjong">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/8c3888d68a9e52e853f0724aae6cefb6.png" width="20"/> weitjong:</div>
<blockquote>
<p>Although the end of the merge result is the same, the user of the AAR will need to have multiple copies “CoreData” in each downstream app projects</p>
</blockquote>
</aside>
<p>Right , it’s additional ~ 450kB per app project on the desktop , will be the same size on the APK side .<br/>
It’s noting in today standards and it will solve you some major headaches</p>
<p>In <a href="http://Urho.Net" rel="noopener nofollow ugc">Urho.Net</a> I am using it for all 3 Platforms (Linux,Mac,Windows) , I am not using symbolic links.<br/>
The first copy of all assets Data/CoreData takes ~3 seconds on my desktop ,<br/>
subsequent copy operations take milliseconds , it copies only updated files/resources.<br/>
The downside it doesn’t delete files in the Android folder if the file was deleted in the bin source folder (I am too lazy to write an Task for that)<br/>
Just my 2 cents …</p>
<p>Some reference</p><aside class="onebox githubblob" data-onebox-src="https://github.com/Urho-Net/Urho.Net/blob/main/template/Android/app/build.gradle#L42">
<header class="source">
<a href="https://github.com/Urho-Net/Urho.Net/blob/main/template/Android/app/build.gradle#L42" rel="noopener nofollow ugc" target="_blank">github.com</a>
</header>
<article class="onebox-body">
<h4><a href="https://github.com/Urho-Net/Urho.Net/blob/main/template/Android/app/build.gradle#L42" rel="noopener nofollow ugc" target="_blank">Urho-Net/Urho.Net/blob/main/template/Android/app/build.gradle#L42</a></h4>
<pre class="onebox">    <code class="lang-gradle">
      <ol class="start lines" start="32" style="counter-reset: li-counter 31 ;">
          <li>    implementation"org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version"</li>
          <li>    implementation 'androidx.appcompat:appcompat:1.2.0'</li>
          <li>    implementation 'androidx.core:core-ktx:1.3.2'</li>
          <li>    implementation 'androidx.constraintlayout:constraintlayout:2.0.4'</li>
          <li>    testImplementation 'junit:junit:4.12'</li>
          <li>    androidTestImplementation 'androidx.test:runner:1.3.0'</li>
          <li>    androidTestImplementation 'androidx.test.espresso:espresso-core:3.3.0'</li>
          <li>    implementation project(path: ':classes')</li>
          <li>}</li>
          <li>
          </li>
<li class="selected">task copyAssets(type: Copy) {</li>
          <li>    println "I'm copyAssets task!"</li>
          <li>    from "../../Assets"</li>
          <li>    into "src/main/assets"</li>
          <li>}</li>
          <li>
          </li>
<li>task deleteIOSFolder(type: Delete) {</li>
          <li>  delete 'src/main/assets/Data/DotNet/ios'</li>
          <li>}</li>
          <li>
          </li>
<li>task copyDotNetAssets(type: Copy) {</li>
      </ol>
    </code>
  </pre>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>

          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>I have explained that I have failed to do it properly in the first place. Instead of “copying”, I wanted to configure the build script so that I could declaratively point the assets dir to the right content. Similar to what symlink does. Only a “pointer to” and not an actual copying. If you or anyone could do that then I will accept that as the general solution.</p>
<p>It is not just wasting the space, you will also have to keep track of which “CoreData” goes to which version of AAR down the road. Granted that Lasse is not with us anymore and that for the past few years there were nothing major changed on the Graphics side that would invalidate the RenderPaths or Techniques or Shaders in the “CoreData”. But we should not make the assumption that the same “CoreData” is perfect match of any Urho3D library. At the time I design the Urho3D AAR, I envision it to be published to MavenCentral. Android developer can just use the AAR in their own Android app project and regardless of which version they use, it will come with the documentation and core assets within itself in a nice package. The Urho3D AAR will be just another AAR used by the downstream project and there is nothing special to it.</p>
          </div>
        </div>
      </div>


    </div>
  </body>
</html>