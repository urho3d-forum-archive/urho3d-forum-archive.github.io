<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width">
    <title>Build system broken</title>
    <link rel="stylesheet" href="../../../archived.css" />
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']]}});
    </script>
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  </head>

  <body>
    <header class="header">
      <div class="title-span">
        <a href="../../../">
          <img src="../../../images/site-logo.png" height="40" alt="Urho3D" id="site-logo" />
        </a>
      </div>
    </header>

    <div class="main">
    <div class="archive-span">Archive 17/01/2023.</div>
    <h1 class="topic-title">Build system broken</h1>
            <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/821_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">WangKai</div>
          <div class="post_content">
<p>I have tested on Windows and Android. Failed to build them for both platforms.</p>
<aside class="onebox githubissue">
<header class="source">
<a  rel="noopener nofollow ugc" target="_blank">github.com/urho3d/Urho3D</a>
</header>
<article class="onebox-body">
<div class="github-row">
<div class="github-icon-container" title="Issue">
<svg aria-hidden="true" class="github-icon" height="60" viewbox="0 0 14 16" width="60"><path d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>
</div>
<div class="github-info-container">
<h4>
<a  rel="noopener nofollow ugc" target="_blank">Cannot generate solution for Visual Studio</a>
</h4>
<div class="github-info">
<div class="date">
        opened <span class="discourse-local-date" data-date="2021-01-04" data-format="ll" data-time="15:36:00" data-timezone="UTC">03:36PM - 04 Jan 21 UTC</span>
</div>
<div class="date">
          closed <span class="discourse-local-date" data-date="2021-01-13" data-format="ll" data-time="02:22:31" data-timezone="UTC">02:22AM - 13 Jan 21 UTC</span>
</div>
<div class="user">
<a href="https://github.com/SuperWangKai" rel="noopener nofollow ugc" target="_blank">
<img alt="SuperWangKai" class="onebox-avatar-inline" height="20" src="../../../images2/5f5c33dbd6ad79ea723b91c92c68c36d" width="20"/>
          SuperWangKai
        </a>
</div>
</div>
</div>
</div>
<div class="github-row">
<p class="github-content">On Windows 10, when I run script\cmake_vs2019.bat BUILD_vs2019 -DURHO3D_LUA=0 -DURHO3D_D3D11=1, the generation does not start.
It seems I cannot pass the "Build...</p>
</div>
<div class="labels">
</div>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>
<aside class="onebox githubissue">
<header class="source">
<a  rel="noopener nofollow ugc" target="_blank">github.com/urho3d/Urho3D</a>
</header>
<article class="onebox-body">
<div class="github-row">
<div class="github-icon-container" title="Issue">
<svg aria-hidden="true" class="github-icon" height="60" viewbox="0 0 14 16" width="60"><path d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>
</div>
<div class="github-info-container">
<h4>
<a  rel="noopener nofollow ugc" target="_blank">Build Failed: Android</a>
</h4>
<div class="github-info">
<div class="date">
        opened <span class="discourse-local-date" data-date="2021-01-06" data-format="ll" data-time="04:57:02" data-timezone="UTC">04:57AM - 06 Jan 21 UTC</span>
</div>
<div class="date">
          closed <span class="discourse-local-date" data-date="2021-01-16" data-format="ll" data-time="11:25:26" data-timezone="UTC">11:25AM - 16 Jan 21 UTC</span>
</div>
<div class="user">
<a href="https://github.com/SuperWangKai" rel="noopener nofollow ugc" target="_blank">
<img alt="SuperWangKai" class="onebox-avatar-inline" height="20" src="../../../images2/5f5c33dbd6ad79ea723b91c92c68c36d" width="20"/>
          SuperWangKai
        </a>
</div>
</div>
</div>
</div>
<div class="github-row">
<p class="github-content">On latest master branch, build with gradlew.bat build failed with log as following:
* What went wrong:
Execution failed for task ':android:urho3d-lib:externalNativeBuildDebug'.
&gt; Build...</p>
</div>
<div class="labels">
</div>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>

          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<p>I have never used <code>script\cmake_vs2019.bat</code>. This way works for me:</p>
<pre><code class="lang-auto">set "PATH=c:\Programs\CMake\bin;c:\Programs\Doxygen\;c:\Programs\Graphviz\bin\;c:\Program Files (x86)\HTML Help Workshop\"

mkdir Build
cd Build
cmake.exe ../Urho3D -G "Visual Studio 16" -A Win32 -DURHO3D_OPENGL=1 -DURHO3D_ANGELSCRIPT=1 -DURHO3D_LUA=1 -DURHO3D_STATIC_RUNTIME=1 -DURHO3D_SAMPLES=1 -DURHO3D_TOOLS=0 -DURHO3D_DOCS=0 -DURHO3D_LIB_TYPE=STATIC -DURHO3D_DATABASE_ODBC=1 -DURHO3D_GENERATEBINDINGS=1

</code></pre>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/821_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">WangKai</div>
          <div class="post_content">
<p>Thank you <span class="mention">@1vanK</span> and your way works. I still expect the scripts got fixed though.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/821_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">WangKai</div>
          <div class="post_content">
<p>I’ve done most of my work on Tracy integration with my limited spare time, however, I’m stuck with current Android building which futher prevents me from analyzing a potential issue on Android platforms I noticed days ago.</p>
<p>Still wish every commit on the master branch working though sometimes it is not easy to cover every platform Urho supports.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>When in doubt you can always use the git blame to trace the commit that introduced the code change and try to understand the rationale from the commit message and the rest of the changes in the same commit.</p>
<aside class="onebox githubcommit">
<header class="source">
<a  rel="noopener" target="_blank">github.com/urho3d/Urho3D</a>
</header>
<article class="onebox-body">
<div class="github-row">
<div class="github-icon-container" title="Commit">
<svg aria-hidden="true" class="github-icon" height="60" viewbox="0 0 14 16" width="60"><path d="M10.86 7c-.45-1.72-2-3-3.86-3-1.86 0-3.41 1.28-3.86 3H0v2h3.14c.45 1.72 2 3 3.86 3 1.86 0 3.41-1.28 3.86-3H14V7h-3.14zM7 10.2c-1.22 0-2.2-.98-2.2-2.2 0-1.22.98-2.2 2.2-2.2 1.22 0 2.2.98 2.2 2.2 0 1.22-.98 2.2-2.2 2.2z"></path></svg>
</div>
<div class="github-info-container">
<h4>
<a  rel="noopener" target="_blank">Handle CMake cache entry in '-D &lt;var&gt;=&lt;value&gt;' format.</a>
</h4>
<div class="github-info">
<div class="date">
        committed <span class="discourse-local-date" data-date="2020-09-05" data-format="ll" data-time="12:31:08" data-timezone="UTC">12:31PM - 05 Sep 20 UTC</span>
</div>
<div class="user">
<a href="https://github.com/weitjong" rel="noopener" target="_blank">
<img alt="weitjong" class="onebox-avatar-inline" height="20" src="../../../images2/306310b6c5663ccb22038db2f88318e7" width="20"/>
          weitjong
        </a>
</div>
<div class="lines" title="changed 12 files with 39 additions and 124 deletions">
<a  rel="noopener" target="_blank">
<span class="added">+39</span>
<span class="removed">-124</span>
</a>
</div>
</div>
</div>
</div>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>
<p>In short there is nothing wrong with the provided build script, <code>cmake_generic.bat</code> and its derivaties like <code>cmake_vs2019.bat</code>. However, you have to adjust to use the expected argument format. If it has command line argument parsing issue then it would have failed in the CI/CD. The *.bat and *.sh are all tested in the CI/CD workflow. Note that for disabling LUA subsystem, you must pass this to turn off both  LUA vanilla and JIT build options: <code>-D URHO3D_LUA=0 -D URHO3D_LUAJIT=0</code>.</p>
<p>As for the Android cross-compiling on Windows host system, it should work with a caveat or two. This has been asked many times and I am tired of answering it in detail again. Basically if your build config requires a native host tool to be built (like “buildvm” for Lua or whatever) then you are going to need a native compiler toolchain (like MinGW).</p>
<p>BTW, I have a new pet project which would occupy most of my spare time. I won’t be active in Urho3D development for the time being but I will still come to the forum once in awhile.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/821_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">WangKai</div>
          <div class="post_content">
<p>Hi <span class="mention">@weitjong</span> ,</p>
<p>I found that in the latest buid system for Android, when building Urho3DPlayer.so, SHARED version of Urho3D is depended on. I was a little confused, since I remembered it was STATIC Urho3D as the default configuration, am I right?</p>
<p>This means the default configuration in Android Studio will lead to an error when building <code>launcher-app</code> -</p>
<pre><code class="lang-auto">Build command failed.
Error while executing process /usr/bin/ninja with arguments {-C {urho3d_folder}/android/launcher-app/.cxx/cmake/debug/armeabi-v7a Urho3DPlayer}
ninja: Entering directory `{urho3d_folder}/android/launcher-app/.cxx/cmake/debug/armeabi-v7a'

ninja: error: '{urho3d_folder}/android/urho3d-lib/.cxx/cmake/debug/armeabi-v7a/lib/libUrho3D.so', needed by '../../../../build/intermediates/cmake/debug/obj/armeabi-v7a/libUrho3DPlayer.so', missing and no known rule to make it
</code></pre>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>Probably you have a problematic build tree again. You are right that the build system currently always defaulted to STATIC and when using the default build config the <code>libUrho3D.so</code> won’t be built at all. If it does then something is wrong with your build tree. Not the build system itself. I am very sure of that. Have you tried to nuke your build tree and retry? I have added a custom Gradle task called “cleanAll” which should clean up everything as its name implies.</p>
<pre><code class="lang-auto">$ ./gradlew cleanAll
</code></pre>
<p>HTH</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/821_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">WangKai</div>
          <div class="post_content">
<p>Thank you for the reply <img alt=":slight_smile:" class="emoji" src="../../../images2/7bdd5ab4d67675d002d99e4b948c8cdb.png" title=":slight_smile:"/></p>
<p>I did <code>git clean</code> for many times and I’m trying <code>cleanAll</code>.</p>
<p>I’m not very familiar with the build system of Urho, however, it seems that on Android, if it’s not Urho3D itself (Urho3DPlayer.so in our case, as a SHARED), <code>libUrho3D.so</code> will be used as the dependency, please correct me if I’m wrong -</p><aside class="onebox githubblob">
<header class="source">
<a  rel="noopener nofollow ugc" target="_blank">github.com</a>
</header>
<article class="onebox-body">
<h4><a  rel="noopener nofollow ugc" target="_blank">urho3d/Urho3D/blob/36cabe96398da686cd220f66920f89b124d7c2d2/cmake/Modules/FindUrho3D.cmake#L87</a></h4>
<pre class="onebox"><code class="lang-cmake"><ol class="start lines" start="77" style="counter-reset: li-counter 76 ;">
<li>    string (TOLOWER ${CMAKE_BUILD_TYPE} config)</li><li>    if (BUILD_STAGING_DIR)</li><li>        # Another special case where library location is already known to be in the build tree of Urho3D project</li><li>        set (URHO3D_HOME ${BUILD_STAGING_DIR}/cmake/${config}/${ANDROID_ABI})</li><li>    elseif (JNI_DIR)</li><li>        # Using Urho3D AAR from Maven repository</li><li>        set (URHO3D_HOME ${JNI_DIR}/urho3d/${config}/${ANDROID_ABI})</li><li>    else ()</li><li>        message (FATAL_ERROR "Neither 'BUILD_STAGING_DIR' nor 'JNI_DIR' is set")</li><li>    endif ()</li><li class="selected">    if (URHO3D_LIB_TYPE STREQUAL STATIC)</li><li>        set (URHO3D_LIBRARIES ${URHO3D_HOME}/lib/libUrho3D.a)</li><li>    else ()</li><li>        set (URHO3D_LIBRARIES ${URHO3D_HOME}/lib/libUrho3D.so)</li><li>    endif ()</li><li>    set (SKIP_COMPILE_TEST TRUE)</li><li>elseif (NOT URHO3D_HOME AND DEFINED ENV{URHO3D_HOME})</li><li>    # Library location would be searched (based on URHO3D_HOME variable if provided and in system-wide default location)</li><li>    file (TO_CMAKE_PATH "$ENV{URHO3D_HOME}" URHO3D_HOME)</li><li>endif ()</li><li># Convert to integer literal to match it with our internal cache representation; it also will be used as foreach loop control variable</li>
</ol></code></pre>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>

          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>The build tree is configured in <code>.gitignore</code>, so the <code>git clean df</code> does not do what you expect it to do. You have to nuke the build tree using <code>rm -rf</code> manually. You can do that using the <code>cleanAll</code> task I mentioned specifically for Android build with Gradle.</p>
<p>I think you already know this. For Android build, the main target that would be eventually shipped in the APK as “*.so”, regardless of which Urho3D library type you use. The main target can still depend on any  library types: STATIC, SHARED, or even OBJECT (CMake-specific).</p>
<p>For the “Launcher app” that Urho3D project provides, the app itself is a launcher of all the 50+ samples (main targets), including the Urho3DPlayer (main target) as the script player. The launcher app allows user to pick one of the samples to launch OR to pick one the AngelScript/Lua scripts to play (by launching Urho3DPlayer behind the scene), one at a time. Again, each main target would contribute to one *.so, regardless of which Urho3D library type you use. The difference is whether the main target shares just one Urho3D library (SHARED lib type) or the main target has individually statically linked the engine into (STATIC lib type). The build system would only include the <code>libUrho3D.so</code> in the final APK for the former case.</p>
<p>So, to answer your question. The “Urho3DPlayer” will always depend on “Urho3D” library. The “libUrho3DPlayer.so” will always be built as SHARED, as that is the target type Android main target should be. The “libUrho3D.so” will be built and included in the APK when and only when the <code>URHO3D_LIB_TYPE</code> is set to SHARED in the build config.</p>
<p>Now in my last refactoring for Android build system I have made one important change in the STATIC build configuration in order to reduce the size of the final APK. This is achieved by only setting up the Urho3DPlayer script player as the main target and excluding all the other samples. So now the launcher app only allows user to pick the scripts to run via Urho3DPlayer, and all samples are not listed anymore. I think it is easy to understand the main target will be much bigger in size if Urho3D engine is statically linked. Putting 50+ of them inside one APK made the final APK becomes very big. It would also require more memory and disk space during build time. GitHub CI/CD workflow could not meet the requirement before I made the change. The SHARED build config is not changed in this respect. Thus, the final APK will either have:</p>
<ul>
<li>SHARED: libUrho3D.so, libUrho3DPlayer.so, lib01_HelloWorld.so, lib02_HelloGUI.so, and so on</li>
<li>STATIC: libUrho3DPlayer.so</li>
</ul>
<p>In other words, it does not make sense anymore to have a build config that uses STATIC lib type but disables both the Angelscript and Lua subystems for Android build, at least for the launcher-app module. I was forced to wrap up my work in a rush, so I am sorry it is not properly documented in the online doc.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/821_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">WangKai</div>
          <div class="post_content">
<p>Hi <span class="mention">@weitjong</span> ,</p>
<p>Thank you for the detailed explaination, I think the non-clean build tree was the issue. During setting up the Android Studio, it introduced some issue.</p>
<p>I have another question about Android Studio on Linux and I wonder if you know the answer.<br/>
How can I set the environment variables so I can affect the gradle script used in Urho.</p>
<p>e.g I add <code>export URHO3D_LUA=0</code> in <code>~/.bashrc</code> or <code>~/.bash_profile</code> seems does not affect the gradle in Android Studio.</p>
<p>Regards,<br/>
Kai</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/821_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">WangKai</div>
          <div class="post_content">
<p>And how can I mark <span class="mention">@weitjong</span> 's last reply as the solution? Only <strong>Support</strong> category supports this feature?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3290_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Modanung</div>
          <div class="post_content">
<p>Yes, that would require moving the thread - and refresh the page - before being able to mark a solution.</p>
<p>…or an admin/leader/moderator taking that initiative.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>Glad to hear you have fixed your issue.</p>
<p>Your last question about the environment variable is not related to Urho3D specifically. It is a general question that many Linux newbie would have asked. Personally, I would set (and export) the env-var in the <code>~/.bash_profile</code>. The catch is, this file is only automatically sourced one time only during interactive shell login. So, you have to logout/login again to make it effective. If you want to keep using the current login session but want the change on the file to be applied immediately then you have to do <code>source ~/.bash_profile</code> manually yourself.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/821_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">WangKai</div>
          <div class="post_content">
<p>It’s interesting that I tried the ways you use, however, there were still some issues. Maybe it’s also dirty build tree related? I’d try it again later when I can find some time. Thank you <span class="mention">@weitjong</span> !</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>In the latest master branch, you need to disable both LUA and LUAJIT to disable it. Just URHO3D_LUA won’t do it anymore. At the time i made the change to auto-enable the JIT on the platform that support it, I didn’t think about this implication. Ideally, when LUA is off then both should be configured to off. Contribution is welcome to rectify this.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/821_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">WangKai</div>
          <div class="post_content">
<p>Hi <span class="mention">@weitjong</span> , I also find that I cannot build Urho3D successfully from Android Studio, while I can just use command line <code>./gradle build</code> successfully, w/ or w/o build options. I noticed that you have commited Android Studio build support recently.</p>
<p>Thanks.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>I don’t have any issue with CLI or with Android Studio or with IntelliJ, the last time I tried it. In the end all are just using Gradle the same.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/821_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">WangKai</div>
          <div class="post_content">
<p>I wonder if it is possible for you to show me you the versions of Android Studio, grade plugin, sdk, ndk, and project settings of Urho in Android Studio?</p>
<p>I guess I may sound like a rookie, last time I have spent a lot of time fixing issues for Android and set up project besides libUrho but last pulling from upstream seems breaks Urho itself. There must be something wrong (on my side)</p>
          </div>
        </div>
      </div>


    </div>
  </body>
</html>