<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width">
    <title>Parallax occlusion</title>
    <link rel="stylesheet" href="../../../archived.css" />
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']]}});
    </script>
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  </head>

  <body>
    <header class="header">
      <div class="title-span">
        <a href="../../../">
          <img src="../../../images/site-logo.png" height="40" alt="Urho3D" id="site-logo" />
        </a>
      </div>
    </header>

    <div class="main">
    <div class="archive-span">Archive 17/01/2023.</div>
    <h1 class="topic-title">Parallax occlusion</h1>
            <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Lumak</div>
          <div class="post_content">
<p>Finally got around to making it work<br/>
right side view<br/>
<div class="lightbox-wrapper"><a class="lightbox" href="https://i.imgur.com/CU4Solo.png" title=""><img alt="" height="388" src="../../../images2/8330dfa1ed563917814b31a6cd83e7ff.png" width="690"/><div class="meta"><svg aria-hidden="true" class="fa d-icon d-icon-far-image svg-icon"><use xlink:href="#far-image"></use></svg><span class="filename"></span><span class="informations">1280×720</span><svg aria-hidden="true" class="fa d-icon d-icon-discourse-expand svg-icon"><use xlink:href="#discourse-expand"></use></svg></div></a></div></p>
<p>Had to finagle TBN matrix to obtain a proper parallax occlusion.</p>
<p>Lighting normal correction<br/>
<div class="lightbox-wrapper"><a class="lightbox" href="https://i.imgur.com/d91oD68.png" title=""><img alt="" height="388" src="../../../images2/3f4c291f6f19ccac502e2c326881ab58.png" width="690"/><div class="meta"><svg aria-hidden="true" class="fa d-icon d-icon-far-image svg-icon"><use xlink:href="#far-image"></use></svg><span class="filename"></span><span class="informations">1280×720</span><svg aria-hidden="true" class="fa d-icon d-icon-discourse-expand svg-icon"><use xlink:href="#discourse-expand"></use></svg></div></a></div></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Lumak</div>
          <div class="post_content">
<p>Repo published - <a href="https://github.com/Lumak/Urho3D-ParallaxOcclusionMap">https://github.com/Lumak/Urho3D-ParallaxOcclusionMap</a></p>
<p>Let me know  if there’s some files missing.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Lumak</div>
          <div class="post_content">
<p>Updated the repo with lighting normal correction.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/2547_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Miegamicis</div>
          <div class="post_content">
<p>If there would be a “Hall of fame” section in the forums, your name would be at the top of it! Nice work! It’s always awesome to see what you have prepared. <img alt=":+1:" class="emoji" src="../../../images2/44789f9390639d4847fd0de0a6ae5879.png" title=":+1:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/1437_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">elix22</div>
          <div class="post_content">
<p>Very cool demo .<br/>
I made a small modification to pass GLSL compilation on Android<br/>
</p><aside class="onebox githubblob">
<header class="source">
<a href="https://github.com/elix22/Urho3D/blob/master/bin/Data/Parallax/Shaders/GLSL/Parallax.glsl" rel="nofollow noopener" target="_blank">github.com</a>
</header>
<article class="onebox-body">
<h4><a href="https://github.com/elix22/Urho3D/blob/master/bin/Data/Parallax/Shaders/GLSL/Parallax.glsl" rel="nofollow noopener" target="_blank">elix22/Urho3D/blob/master/bin/Data/Parallax/Shaders/GLSL/Parallax.glsl</a></h4>
<pre><code class="lang-glsl">// Parallax mapping
// DirectX9 ParallaxOcclusionMapping sample
#line 10100

#ifdef PARALLAXMAP
// error checking
#ifdef NORMALMAP
#error PARALLAXMAP and NORMALMAP must be exclusive
#endif

// height scale
#ifndef cHeightScale
uniform float cHeightScale;
#endif

#ifdef COMPILEPS

#ifdef PARALLAX_OFFSET
vec2 ParallaxOffsetLimit(sampler2D depthMap, vec2 texCoords, vec3 viewDir)
{ 
</code></pre>

  This file has been truncated. <a href="https://github.com/elix22/Urho3D/blob/master/bin/Data/Parallax/Shaders/GLSL/Parallax.glsl" rel="nofollow noopener" target="_blank">show original</a>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>

          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/2811_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">lebrewer</div>
          <div class="post_content">
<p>This is fantastic. Thanks a lot for the awesome work, <span class="mention">@Lumak</span>! <img alt=":heart_eyes:" class="emoji" src="../../../images2/2ea30638a5bdcc16f7477597b3f4b43d.png" title=":heart_eyes:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Lumak</div>
          <div class="post_content">
<p>Glad ppl like this repo, I think this was something that’s been over due by several years.</p>
<p><span class="mention">@elix22</span> Let me know what the change is or I can’t take look at your changes in your fork.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/1437_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">elix22</div>
          <div class="post_content">
<p>It applies both for iOS and Android .<br/>
The change is  in <strong>Parallax.glsl</strong></p>
<p>Add  at the top:</p>
<pre><code>#ifdef MOBILE_GRAPHICS
    precision mediump float;
#else
    precision highp float;
#endif
</code></pre>
<p>change from :</p>
<pre><code>const float minLayers = 8;
const float maxLayers = 36;
</code></pre>
<p>change to :</p>
<pre><code>float minLayers = 8.0;
float maxLayers = 36.0;
</code></pre>
<p>change from :</p>
<pre><code>    if ( fDenominator == 0.0f )
    {
       fParallaxAmount = 0.0f;
    }	
</code></pre>
<p>change to :</p>
<pre><code>    if ( fDenominator == 0.0 )
    {
       fParallaxAmount = 0.0;
    }</code></pre>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/2811_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">lebrewer</div>
          <div class="post_content">
<p>can it work with terrains?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Lumak</div>
          <div class="post_content">
<p>I couldn’t just answered the question but had to try it. And the answer is, you can do parallax mapping on terrain with limitations. This is because detail textures requires displacement and normal map. If you were to do that with 1-weight map and 3-detail textures, that would mean you’ll need total of 10 textures. That’ll be problematic, however, you can do it with 2 detail textures. Texture detail list:<br/>
1-weight map<br/>
2-detailmap1 with displacement(heightmap) embedded in alpha channel<br/>
3-detailmap2 with displacement(heightmap) embedded in alpha channel<br/>
4-normalmap1 for detailmap1<br/>
5-normalmap2 for detailmap2</p>
<p><s>Very restrictive but do-able. Here’s a test that I did.</s> Nope. this is not right.<br/>
conclusion: the very first image, which is edited out, has only normal map applied and no matter what I tried, parallax mapping fails due to varying normals, even if you fix the tangents and bitangents some parts of the terrain becomes distorted. So, parallax mapping will not work, but normal map will.</p>
<p><span class="mention">@elix22</span> thank you for that. I’ll update the repo with your changes.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Lumak</div>
          <div class="post_content">
<p>Updated the repo: bug fix for parallaxLength computation, added elix22’s android changes, added saint images.<br/>
and another pic<br/>
<div class="lightbox-wrapper"><a class="lightbox" href="https://i.imgur.com/pQe6Rge.png" title=""><img alt="" height="388" src="../../../images2/3cb70ff62fd9b9a1b24ae567c2ce1d4f.png" width="690"/><div class="meta"><svg aria-hidden="true" class="fa d-icon d-icon-far-image svg-icon"><use xlink:href="#far-image"></use></svg><span class="filename"></span><span class="informations">1280×720</span><svg aria-hidden="true" class="fa d-icon d-icon-discourse-expand svg-icon"><use xlink:href="#discourse-expand"></use></svg></div></a></div></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/1669_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">GoldenThumbs</div>
          <div class="post_content">
<p>Is this just an adaption of the shader on <a href="https://learnopengl.com/Advanced-Lighting/Parallax-Mapping" rel="nofollow noopener">Learn OpenGL</a> or totally rewritten yourself? I mean, seeing as this is an established technique there’s going to be a lot of similarities lol.</p>
<p>I also wrote an <a href="https://discourse.urho3d.io/t/parallax-mapping/4754">Urho3D version of that shader</a> from Learn OpenGL awhile ago. Don’t think I ever made a Github repo for it though. Anyway, it’s nice seeing someone else trying this effect.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Lumak</div>
          <div class="post_content">
<p>I had no idea about your work. I wish I had known about it; that would’ve save me the trouble writing one. The shader code in my work is from DirectX SDK, along with the textures.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/1437_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">elix22</div>
          <div class="post_content">
<p><span class="mention">@Lumak</span> you missed a small change.<br/>
const int assignment into float will fail on some android devices</p>
<pre><code class="lang-auto">float minLayers = 8;
float maxLayers = 36;
</code></pre>
<p>change to :</p>
<pre><code class="lang-auto">float minLayers = 8.0;
float maxLayers = 36.0;
</code></pre>
<p>For those that would like to try it on an Android device,<br/>
I generated an Android apk with all the samples , this one included.<br/>
</p><aside class="onebox googledrive">
<header class="source">
<a href="https://drive.google.com/file/d/19_feFQS18ePSScwtw-7ynj5XWuFLEtoS/view?usp=sharing" rel="nofollow noopener" target="_blank">drive.google.com</a>
</header>
<article class="onebox-body">
<a href="https://drive.google.com/file/d/19_feFQS18ePSScwtw-7ynj5XWuFLEtoS/view?usp=sharing" rel="nofollow noopener" target="_blank"><span class="googledocs-onebox-logo g-drive-logo"></span></a>
<h3><a href="https://drive.google.com/file/d/19_feFQS18ePSScwtw-7ynj5XWuFLEtoS/view?usp=sharing" rel="nofollow noopener" target="_blank">launcher-app.apk</a></h3>
<p>Google Drive file.</p>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>

          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Lumak</div>
          <div class="post_content">
<p><span class="mention">@elix22</span> Alright, I’ll make another update with those changes.</p>
<p>Ever since I’ve started on this project, I wondered about two things:<br/>
1 - I was puzzled by why the tangent and bitangent vectors needed to be swapped and negated to construct the TBN matrix, i.e.</p>
<pre><code class="lang-auto">mat3 tbn = mat3(-vec3(vTexCoord.zw, vTangent.w), -vTangent.xyz, vNormal);
</code></pre>
<p>to make this work.</p>
<p>2  - why when the orientation of the face changed, the parallax offset got skewed.</p>
<p>I finally figured it out. Of all the primitive models that we have in Data/Models folder, the Plane.mdl is the only model with the incorrect tangents. I pre-dumped every model’s tangent vectors and post-dumped them again after calling <strong>GenerateTangents()</strong> fn Plane.mdl currently stores bitangent vectors in tangent vector data.</p>
<p>The second problem – I’ve looked over the DirectX sample over and over again and didn’t see where I made a bad copy or translated HLSL incorrectly. Just another puzzle I couldn’t figure out. Then after looking at the Learn OpenGL version of the shader that <span class="mention">@GoldenThumbs</span> pointed out, I realize the transpose() could be inherent in the HLSL but needed to explicitly applied in GLSL. And sure enough, that solved the problem.</p>
<p>These two problems fixes the following problems:<br/>
1-- cube parallax occlusion<br/>
<div class="lightbox-wrapper"><a class="lightbox" href="https://i.imgur.com/GDBtwgI.png" title=""><img alt="" height="388" src="../../../images2/3c2f4c404dc08bd1736ce892ada0c872.png" width="690"/><div class="meta"><svg aria-hidden="true" class="fa d-icon d-icon-far-image svg-icon"><use xlink:href="#far-image"></use></svg><span class="filename"></span><span class="informations">1280×720</span><svg aria-hidden="true" class="fa d-icon d-icon-discourse-expand svg-icon"><use xlink:href="#discourse-expand"></use></svg></div></a></div></p>
<p>2-- terrain parallax occlusion<br/>
<div class="lightbox-wrapper"><a class="lightbox" href="https://i.imgur.com/NzRibEz.jpg" title=""><img alt="" height="368" src="../../../images2/913a7d4a4498278d449d8fa5c1b3a512.jpg" width="690"/><div class="meta"><svg aria-hidden="true" class="fa d-icon d-icon-far-image svg-icon"><use xlink:href="#far-image"></use></svg><span class="filename"></span><span class="informations">1922×1026</span><svg aria-hidden="true" class="fa d-icon d-icon-discourse-expand svg-icon"><use xlink:href="#discourse-expand"></use></svg></div></a></div></p>
<p>I have these test codes in several folders. I’ll collect them and add them to the repo in a day or two.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/1669_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">GoldenThumbs</div>
          <div class="post_content">
<p>Glad I could help! Also, ay I ask where you got that terrain shader? Is this the <span class="mention">@JTippetts</span> terrain shader (with some modifications made by you for the POM)?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Lumak</div>
          <div class="post_content">
<p>Repo updated, as I don’t think I’ll have the time to update it after today.</p>
<p><span class="mention">@GoldenThumbs</span> It’s a modified version of the default TerrainBlend shader that comes with Urho3D.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/1669_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">GoldenThumbs</div>
          <div class="post_content">
<p>By the way I found that <a href="https://discourse.urho3d.io/t/whats-with-normal-maps/5364/4">issue with the plane model</a> a while ago. Should have been fixed by now given how there’s no benefit to having a default model with faulty tangents and the fix is very easy.</p>
<p>Edit: could one do a PR for art assets? I might just do it myself.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/1437_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">elix22</div>
          <div class="post_content">
<p><span class="mention">@Lumak</span> thanks for the demo.</p>
<p>Small note, transpose is not supported on mobile devices<br/>
I added local <strong>transpose(in mat3 inMatrix)</strong>  implementation on my side</p>
<aside class="onebox githubblob">
<header class="source">
<a href="https://github.com/elix22/Urho3D/blob/master/bin/Data/Parallax/Shaders/GLSL/LitSolidParallax.glsl" rel="nofollow noopener" target="_blank">github.com</a>
</header>
<article class="onebox-body">
<h4><a href="https://github.com/elix22/Urho3D/blob/master/bin/Data/Parallax/Shaders/GLSL/LitSolidParallax.glsl" rel="nofollow noopener" target="_blank">elix22/Urho3D/blob/master/bin/Data/Parallax/Shaders/GLSL/LitSolidParallax.glsl</a></h4>
<pre><code class="lang-glsl">#include "Uniforms.glsl"
#include "Samplers.glsl"
#include "Transform.glsl"
#include "ScreenPos.glsl"
#include "Lighting.glsl"
#include "Fog.glsl"
#include "Parallax.glsl"

#ifdef MOBILE_GRAPHICS
mat3 transpose(in mat3 inMatrix) {
     vec3 i0 = inMatrix[0];
     vec3 i1 = inMatrix[1];
     vec3 i2 = inMatrix[2];

     mat3 outMatrix = mat3(
                 vec3(i0.x, i1.x, i2.x),
                 vec3(i0.y, i1.y, i2.y),
                 vec3(i0.z, i1.z, i2.z)
                 );

</code></pre>

  This file has been truncated. <a href="https://github.com/elix22/Urho3D/blob/master/bin/Data/Parallax/Shaders/GLSL/LitSolidParallax.glsl" rel="nofollow noopener" target="_blank">show original</a>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>
<p>Also updated the Android APK<br/>
</p><aside class="onebox googledrive">
<header class="source">
<a href="https://drive.google.com/file/d/19_feFQS18ePSScwtw-7ynj5XWuFLEtoS/view?usp=sharing" rel="nofollow noopener" target="_blank">drive.google.com</a>
</header>
<article class="onebox-body">
<a href="https://drive.google.com/file/d/19_feFQS18ePSScwtw-7ynj5XWuFLEtoS/view?usp=sharing" rel="nofollow noopener" target="_blank"><span class="googledocs-onebox-logo g-drive-logo"></span></a>
<h3><a href="https://drive.google.com/file/d/19_feFQS18ePSScwtw-7ynj5XWuFLEtoS/view?usp=sharing" rel="nofollow noopener" target="_blank">launcher-app.apk</a></h3>
<p>Google Drive file.</p>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>

          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Lumak</div>
          <div class="post_content">
<p><span class="mention">@elix22</span> Thanks, again. Added that function to repo.</p>
<p><span class="mention">@GoldenThumbs</span> Typical procedure is to make the changes to SourceAssets/ *.blend files and that’ll generate the *.mdl files.  Maybe <span class="mention">@1vanK</span> can investigate what’s wrong with the Plane.blend file to see why it’s generating erroneous tangents.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<p>*.blend have tangents but *.mdl was changed later: <a >https://github.com/urho3d/Urho3D/commit/16eea3949961fe6798b2ed63ea1b72d19eceac4b</a></p>
<p>Can you test this file <a href="https://dropmefiles.com/KThBy">https://dropmefiles.com/KThBy</a></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Lumak</div>
          <div class="post_content">
<p>The one from your <a href="http://dropmefiles.com">dropmefiles.com</a> works perfectly. The updated one – 16eea3949961fe6798b2ed63ea1b72d19eceac4b, didn’t work properly.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">coldev</div>
          <div class="post_content">
<p>nice assets , thanks <img alt=":grin:" class="emoji" src="../../../images2/ab418b6a2a0bf690d1ca04fff8b57495.png" title=":grin:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3290_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Modanung</div>
          <div class="post_content">
<p>Maybe try it with some <a href="https://texturehaven.com/textures/">Texture Haven</a> assets and PBR?</p>
          </div>
        </div>
      </div>


    </div>
  </body>
</html>