<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width">
    <title>Laser and Laser prefab</title>
    <link rel="stylesheet" href="../../../archived.css" />
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']]}});
    </script>
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  </head>

  <body>
    <header class="header">
      <div class="title-span">
        <a href="../../../">
          <img src="../../../images/site-logo.png" height="40" alt="Urho3D" id="site-logo" />
        </a>
      </div>
    </header>

    <div class="main">
    <div class="archive-span">Archive 17/01/2023.</div>
    <h1 class="topic-title">Laser and Laser prefab</h1>
            <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/998_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">stark7</div>
          <div class="post_content">
<p>Hello,</p>
<p>Can someone please give me some direction on how to make a laser like this:<br/>
<div class="lazyYT" data-height="270" data-parameters="feature=oembed&amp;wmode=opaque" data-width="480" data-youtube-id="kBCpiRzaRX4" data-youtube-title="Urho3D Laser"></div></p>
<p>And if at all possible, something like this in blender or whatever other program:<br/>
<div class="lazyYT" data-height="270" data-parameters="feature=oembed&amp;wmode=opaque" data-width="480" data-youtube-id="DaD-IRotLBA" data-youtube-title="Urho3D fh devlog laser fx prefab"></div></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<blockquote>
<p>Can someone please give me some direction on how to make a laser like this:</p>
</blockquote>
<p>cylinder with material</p>
<pre><code class="lang-auto">&lt;material&gt;
    &lt;technique name="Techniques/DiffAdd.xml" /&gt;
    &lt;parameter name="MatDiffColor" value="1 0 0 1" /&gt;
&lt;/material&gt;
</code></pre>
<p>raycast forward to find obstacle and change scale for this cylinder</p>
<p>EDIT:</p>
<blockquote>
<p>And if at all possible, something like this in blender or whatever other program:</p>
</blockquote>
<p>I look to <a href="https://github.com/MonkeyFirst/FH">https://github.com/MonkeyFirst/FH</a></p>
<p>it is just intersected poligons with texture with fade alpha</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<p><img alt="1" height="399" src="//cdck-file-uploads-global.s3.dualstack.us-west-2.amazonaws.com/standard17/uploads/urho3d/original/1X/650d4e786ecf8a45e7d016aa2f370d02ac603849.jpg" width="690"/></p>
<p><img alt="thunder" height="500" src="//cdck-file-uploads-global.s3.dualstack.us-west-2.amazonaws.com/standard17/uploads/urho3d/original/1X/775c6a38578d154d39b61a3cea9522d35cebd9f6.png" width="500"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/998_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">stark7</div>
          <div class="post_content">
<p>Thank you very much 1vank! This really puts me back on track.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3290_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Modanung</div>
          <div class="post_content">
<p>Possibly related topic:<br/>
<a class="onebox" href="https://discourse.urho3d.io/t/rotate-node-on-local-z-facing-camera/2929" target="_blank">https://discourse.urho3d.io/t/rotate-node-on-local-z-facing-camera/2929</a></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/998_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">stark7</div>
          <div class="post_content">
<p>Beautiful work Modanung! I am actually coding all this in urhosharp and it will take me a little while to convert your code to c# and test it - when I do I will make sure to put it on my github. Seeing how good it looks, I will probably get it done sometime tomorrow.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3290_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Modanung</div>
          <div class="post_content">
<p>In case of a laser you’d probably want to add a raycast that controls the Z-scale of the plane and the position of any impact effect.<br/>
Also you may want to implement it as a <code>Drawable</code> instead of a <code>LogicComponent</code>.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/998_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">stark7</div>
          <div class="post_content">
<p>Yes - that’s what I did and now I’m getting the effect I wanted. Instead of cylinder I also used two perpendicular planes (aka intersecting polygons). It looks pretty good.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/998_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">stark7</div>
          <div class="post_content">
<p>Hey 1vanK - do you have any idea how LaserObject.mdl was created in the first place? Was it some blender animated model with armature and what not?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/768_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">1vanK</div>
          <div class="post_content">
<p>Write message to <span class="mention">@codingmonkey</span></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/998_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">stark7</div>
          <div class="post_content">
<p>Hey Modanung,</p>
<p>When I tried to replicate BeamLight with urhosharp, I get the below weirdness.</p>
<p>I am now going to do a third pass <img alt=":slight_smile:" class="emoji" src="../../../images2/ab33f6c546ca85e7d84a4e3c32cd4034.png" title=":slight_smile:"/> - I used the white bg so you can see what I think should be the beamlight sources. I pasted the code below and I tried to reuse your variable names as much as possible for an easier transition.</p>
<p>One thing I am not really doing is setting the same renderpath with BloomHDR - could that be part of it? I didn’t set this because I am under the impression that any render path other than the standard doesn’t work for mobile devices.</p>
<div class="lazyYT" data-height="270" data-parameters="feature=oembed&amp;wmode=opaque" data-width="480" data-youtube-id="yn-OnXlxy_g" data-youtube-title="BeamLight"></div>
<blockquote>
<p>class BeamLight : Component<br/>
{<br/>
float startEulerY_;<br/>
Node beamNode_;<br/>
Node flareNode_;</p>
</blockquote>
<pre><code>    Light light_;
    Material lampMaterial_;
    Material beamMaterial_;
    Material flareMaterial_;

    public BeamLight()
    {
        ReceiveSceneUpdates = true;
    }

    public void SetColor(Color color)
    {
        light_.Color = color;

        int isEnabled = light_.Enabled ? 1 : 0;

        lampMaterial_.SetShaderParameter("MatDiffColor", (light_.Color * 2.0f + Color.White) * 0.333f * isEnabled * light_.Brightness);
        lampMaterial_.SetShaderParameter("MatEmissiveColor", light_.Color * 100.0f * isEnabled * light_.Brightness);
    }

    private float Angle(Vector3 lhs, Vector3 rhs)
    {
        return (float)Math.Acos((float)Vector3.Dot(lhs, rhs) / (lhs.Length * rhs.Length));
    }

    private float Average(Color p_color)
    {
        return (p_color.R + p_color.G + p_color.B) / 3.0f;
    }

    protected override void OnUpdate(float timeStep)
    {
        base.OnUpdate(timeStep);

        float yaw = this.Node.Rotation.YawAngle;
        float pitch = this.Node.Rotation.PitchAngle;
        float roll = this.Node.Rotation.RollAngle;

        float shift = (0.23f + 0.05f * pitch * 0.5f) + (yaw / 360.0f);

        //SetColor(Color.White);

        SetColor(new Color(
            BeamLightTools.MCSine(0.111f, 0.0f, 1.0f, shift),
            BeamLightTools.MCSine(0.222f, 0.0f, 1.0f, shift + .23f),
            BeamLightTools.MCSine(0.333f, 0.0f, 1.0f, shift + .42f),
            1f
        ));

        Vector3 camDeltaPos = this.Node.WorldPosition - Vector3.Zero;

        this.Node.RotateAround(Vector3.Zero, new Quaternion(Vector3.Up, timeStep), TransformSpace.World);

        beamNode_.LookAt(this.Node.WorldPosition + this.Node.Direction, camDeltaPos);

        float normAngle = 1.0f - Angle(this.Node.Direction, camDeltaPos) / 90.0f;

        int isEnabled = light_.Enabled ? 1 : 0;

        Color lightColor = light_.Color * isEnabled * light_.Brightness;
        Color beamColor = lightColor * MathHelper.Clamp((float)Math.Pow(1.1f - Math.Abs(normAngle) - 0.16f, 0.9f), 0.0f, 1.0f);
        Color flareColor = lightColor * MathHelper.Clamp((float)Math.Pow(0.5f - normAngle, 4.0f) - 0.23f, 0.0f, 1.0f);

        beamMaterial_.SetShaderParameter("MatDiffColor", beamColor);
        flareMaterial_.SetShaderParameter("MatDiffColor", flareColor);
        flareNode_.SetScale(normAngle * (0.5f + Average(lightColor) * 0.32f));
    }
    
    public override void OnAttachedToNode(Node node)
    {
        if (node == null)
            return;

        base.OnAttachedToNode(node);

        var cache = Physics.resourcecache;

        light_ = node.CreateComponent&lt;Light&gt;();
        light_.LightType = LightType.Spot;

        var lampModel = node.CreateComponent&lt;StaticModel&gt;();
        lampModel.Model = cache.GetModel("Models/Lamp.mdl");
        lampMaterial_ = cache.GetMaterial("Materials/Lamp.xml").Clone();
        lampModel.SetMaterial(0, lampMaterial_);

        beamNode_ = node.CreateChild("Beam");
        beamNode_.Translate(Vector3.Forward * 0.82f);
        beamNode_.Scale = new Vector3(1.0f, 1.0f, 1.8f);

        var beamModel = beamNode_.CreateComponent&lt;StaticModel&gt;();
        beamModel.Model = cache.GetModel("Models/Plane.mdl");
        beamMaterial_ = cache.GetMaterial("Materials/Beam.xml").Clone();
        beamModel.Material = beamMaterial_;

        //beamNode_.CreateComponent&lt;RibbonTrail&gt;();

        flareNode_ = node.CreateChild("Flare");
        flareNode_.Rotate(new Quaternion(Vector3.Right, 90.0f));
        var flareModel = flareNode_.CreateComponent&lt;StaticModel&gt;();
        flareModel.Model = cache.GetModel("Models/Plane.mdl");
        flareMaterial_ = cache.GetMaterial("Materials/Flare.xml").Clone();
        flareModel.Material = flareMaterial_;
    }
}</code></pre>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/119_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">codingmonkey</div>
          <div class="post_content">
<p>hi <span class="mention">@stark7</span><br/>
I have my old shader for beam lights (very basic), you may also take a look on it.<br/>
But I do not know how urhosharp integrate custom shaders/techniques, cuz I never used it.<br/>
<img alt="preview" height="360" src="//cdck-file-uploads-global.s3.dualstack.us-west-2.amazonaws.com/standard17/uploads/urho3d/original/1X/82a3a9c19a28801fb9d96f64466ea0d2b4019c3b.png" width="690"/></p>
<p>REPO: <a class="inline-onebox-loading" href="https://github.com/MonkeyFirst/Urho3D_GeomBeamLight">https://github.com/MonkeyFirst/Urho3D_GeomBeamLight</a></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/998_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">stark7</div>
          <div class="post_content">
<p>foooorked! I’ll try to get it working and let you know.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/998_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">stark7</div>
          <div class="post_content">
<p>Hey <span class="mention">@codingmonkey</span> - for ease of replication, would you please add to your repo the missing assets like Sphere.mdl, Dome.mdl, Box.mdl and Plane.mdl and  Materials/BlockWithEnv.xml ? Just so I can replicate this as is and compare 1:1 - thank you again!</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/998_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">stark7</div>
          <div class="post_content">
<p>Here is what it looks like in urhosharp with your shader and with removing a bunch of stuff from scene1.xml - it’s fantastic! I can hardly wait to put it in it’s right place.</p>
<p><img alt="image" height="500" src="//cdck-file-uploads-global.s3.dualstack.us-west-2.amazonaws.com/standard17/uploads/urho3d/original/1X/8273755b702f15301df8d6a8ac2598dced1ce691.jpg" width="485"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/998_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">stark7</div>
          <div class="post_content">
<p><span class="mention">@codingmonkey</span> do you happen to have a similar shader or maybe you can provide some direction on how to turn this into a point light? I’m thinking to use something like that to make some glowing cannonballs <img alt=":smiley:" class="emoji" src="../../../images2/c16ddadcbd525aa6d219a1df596d362f.png" title=":smiley:"/> or something along those lines.</p>
<p>My current investigation is to try and use DiffEmissive but that requires a SpecularMap and I was hoping to not have to use that.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/119_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">codingmonkey</div>
          <div class="post_content">
<p>You are welcome, it’s nice to see what it works even on urhosharp )</p>
<p>but shader still far from complete, it have some “angle” problems, it might disappear when you try to looking on it from some positions. also it’s need to be fix to render beams in similar way as SoftParticles.</p>
<blockquote>
<p>maybe you can provide some direction on how to turn this into a point light?</p>
</blockquote>
<p>use softparticles for that, there two mode of SP, don’t remember exactly what mode allow make glow.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/998_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">stark7</div>
          <div class="post_content">
<p>Hey <span class="mention">@codingmonkey</span> is there a way to have it remain visible when it’s pointing at the camera or away from the camera? The version you shared makes it disappear and I’m trying to make an effect like this:</p>
<p><img alt="image" height="329" src="//cdck-file-uploads-global.s3.dualstack.us-west-2.amazonaws.com/standard17/uploads/urho3d/original/1X/955430b9e1541f45874f773ce8a7aa8e2c5686fe.jpg" width="690"/></p>
<p>EDIT - man… I’m burned out - I did read your text on how you have the angle issues and completely forgot about it like 10 seconds after. I wish I could help with the shader and resolving those issues, I just don’t really have any idea where to start or what to do.<br/>
Are the issues you’re experiencing related to limitations in what can be done with a shader or are you in the process of learning how to do it?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/119_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">codingmonkey</div>
          <div class="post_content">
<p>Hey <span class="mention">@stark7</span> yeah I thinking about this issue, but still no clue how fix this.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<p>Well, if you are ready to work…<br/>
I suppose that you could utilize the same approach as used for 3d lines.<br/>
<aside class="onebox pdf">
<header class="source">
<a href="https://developer.download.nvidia.com/SDK/9.5/Samples/DEMOS/OpenGL/src/cg_VolumeLine/docs/VolumeLine.pdf" rel="nofollow noopener" target="_blank">developer.download.nvidia.com</a>
</header>
<article class="onebox-body">
<a href="https://developer.download.nvidia.com/SDK/9.5/Samples/DEMOS/OpenGL/src/cg_VolumeLine/docs/VolumeLine.pdf" rel="nofollow noopener" target="_blank"><span class="pdf-onebox-logo"></span></a>
<h3><a href="https://developer.download.nvidia.com/SDK/9.5/Samples/DEMOS/OpenGL/src/cg_VolumeLine/docs/VolumeLine.pdf" rel="nofollow noopener" target="_blank">VolumeLine.pdf</a></h3>
<p class="filesize">3.22 MB</p>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>
</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/998_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">stark7</div>
          <div class="post_content">
<p>Hey <span class="mention">@codingmonkey</span>  just in case you don’t see my comments on github <img alt=":slight_smile:" class="emoji" src="../../../images2/ab33f6c546ca85e7d84a4e3c32cd4034.png" title=":slight_smile:"/> - can you please add the missing scene and material .xmls and .mdl to your Urho3D_GeomBeamLight repo? Btw, I can’t seem to be able to see anything anymore with your latest commit - although the screenshot you posted looks siiiiiick.</p>
          </div>
        </div>
      </div>


    </div>
  </body>
</html>