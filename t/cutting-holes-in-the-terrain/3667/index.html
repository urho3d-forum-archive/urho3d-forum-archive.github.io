<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width">
    <title>Cutting holes in the terrain</title>
    <link rel="stylesheet" href="../../../archived.css" />
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']]}});
    </script>
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  </head>

  <body>
    <header class="header">
      <div class="title-span">
        <a href="../../../">
          <img src="../../../images/site-logo.png" height="40" alt="Urho3D" id="site-logo" />
        </a>
      </div>
    </header>

    <div class="main">
    <div class="archive-span">Archive 17/01/2023.</div>
    <h1 class="topic-title">Cutting holes in the terrain</h1>
            <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3200_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rku</div>
          <div class="post_content">
<p>Does current <code>Terrain</code> component support cutting holes in it? Say for making cave entrance. API does not suggest anything obvious, but maybe there is some smart trick to achieve this?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<p>Graphics is simple.<br/>
Physics is average.<br/>
Navigation etc - I don’t know.</p>
<aside class="quote no-group" data-post="2" data-topic="3538" data-username="Eugene">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/ae663b3d37eca5ee603f9e0610f8f829.png" width="20"/><a href="https://discourse.urho3d.io/t/urho3d-questions-terrain-material-vs-other-engines/3538/2">Urho3D questions (terrain, material, vs other engines)</a>
</div>
<blockquote>
<p>Semi-transparent material for graphics.</p>
<p>Physics will require tweaking Bullet Physics, but that’s easy. I shall probably commit the change into Urho.</p>
<p>Navigation will also require some tweaking.</p>
<p>Thanks for reminding, I shall probably add some support of the holes in the Terrain. However, don’t expect this in the nearest future.</p>
</blockquote>
</aside>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<p>FYI: How to make Bullet work with holes in terrain:</p>
<ol>
<li>Inherit from <code>btHeightfieldTerrainShape</code>
</li>
<li>Override <code>processAllTriangles</code>
</li>
<li>Somehow drop triangles: use mask array or sentinel height. I’ve just copy-pasted content of <code>processAllTriangles</code>.</li>
<li>Use your own height field shape.</li>
</ol>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/81_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Enhex</div>
          <div class="post_content">
<p>Maybe you could use several terrains, leaving a gap between them?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3200_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rku</div>
          <div class="post_content">
<p>I thought of that. It would likely be easiest approach, but then these two terrains would not be stitched together and lesser problem is gaps would be allowed only at terrain boundaries.</p>
<p><span class="mention">@Eugene</span> thanks for pointers. Any idea if sentinel height value could be used with heightmap itself? I tried naive thing (discarding vertices <a  rel="nofollow noopener">here</a>) and it ended up being a royal mess because clearly i have no idea what im doing.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/788_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">johnnycable</div>
          <div class="post_content">
<p>Uhm, looking at terrain just these days…<br/>
I found, for instance, <a href="https://github.com/domlysz/BlenderGIS/wiki/Materials-node-setup-builder" rel="nofollow noopener">BlenderGis</a>, which allows you to get multimapping; one could use heightmap as usual, and slope and aspect to get direction of movement for characters for recast/detour I think… or for intentional movement inside a cave…<br/>
Anyway terrain basically is a flat plane and doing st like cave sounds like voxels… the normal solution is using point of interests and teleporting somewhere else…<br/>
But of course this is not continuos movement like probably you’re looking for…</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<p>It’s hard to combine stable geometry discarding, sentinel heights and geomipmapping.<br/>
Even PhysX use material index instead of height to mask cells as gaps.<br/>
I recommend you to hold the idea about sentinel heights and revise it if it become important.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/81_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Enhex</div>
          <div class="post_content">
<p>Another approach is to just use something other than heightmap terrain, like regular 3D models.<br/>
You can also mix it up with terrain, leaving a low height hole where you want to place your 3D model cave, so the terrain is below the cave.</p>
<p>a workaround with terrain is to have some sort of transition between the cave and the terrain, like a door.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3200_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rku</div>
          <div class="post_content">
<p><span class="mention">@Enhex</span> my primary reason why i looked at terrain component is that it handles stitching and all that. Using 3D model would probably be akin to making own terrain system.</p>
<p>On a closer look at terrain component i noticed these:</p>
<pre><code class="lang-cpp">void SetNorthNeighbor(Terrain* north);
void SetSouthNeighbor(Terrain* south);
void SetWestNeighbor(Terrain* west);
void SetEastNeighbor(Terrain* east);
</code></pre>
<p>Does terrain component handle stitching of multiple <code>Terrain</code> components together? Not just <code>TerrainPatch</code>es within <code>Terrain</code>? If so that brings me to your original suggestion.</p>
<p>Take a following picture as example:<br/>
<img alt="terrains" height="284" src="../../../images2/bb019289937cf470925dca0724a2738a.png" width="442"/><br/>
Each rectangle represents <code>Terrain</code> component. Each green border represents neighbour relationship being set. Red border represents no neighbour relationship.</p>
<p>Am i right to think that in this setup terrain would not be stitched together at the red border? If so then adjacent tiles could have different height (which would be a very steep cliff if stitched together) and create a hole when no stitching is applied to that border.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<p>AFAIK, terrain wouldn’t be stiched unless you stich it manually. I mean, it depends on values in heightmap.<br/>
But I find this approach very limited to be useful.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3200_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rku</div>
          <div class="post_content">
<p>What does <code>SetXXNeighbor(Terrain*)</code> do then?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<p>Ensures that geomipmapping won’t make any unexpected holes</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3200_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rku</div>
          <div class="post_content">
<aside class="quote no-group" data-post="12" data-topic="3667" data-username="Eugene">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/ae663b3d37eca5ee603f9e0610f8f829.png" width="20"/> Eugene:</div>
<blockquote>
<p>geomipmapping</p>
</blockquote>
</aside>
<p>Excuse my ignorance, but that sounds very much like stitching up terrains. Could you please elaborate?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<p>Separate terrains don’t have any shared data, so they couldn’t stich themselves without explicit user intention.</p>
<p>Neigbors are used to ensure that terrain patches on the edges has valid topology and there won’t be any gap caused by mismatching LODs.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/81_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Enhex</div>
          <div class="post_content">
<p>You don’t have to handle stitching with a 3D model, just let it intersect with the terrain and you won’t have gaps.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3200_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rku</div>
          <div class="post_content">
<p>I am experimenting with setting up multiple terrains. Docs are sparse on this topic and there seem to be hidden requirements for making entire thing work.</p>
<p>What is supposed to be a heightmap format? I noticed that terrain skips 1 pixel at the edges of heightmap, thus for creating 16x16 units terrain i need to use 17x17 heigthmap. Whats the purpose of skipped edge?</p>
<p>How exactly am i supposed to use <code>SetXXXNeighbor()</code>? My test code:</p>
<pre><code class="lang-cpp">
        auto terrain = scene_-&gt;CreateChild()-&gt;CreateComponent&lt;Terrain&gt;();
        terrain-&gt;SetPatchSize(8);
        terrain-&gt;SetSpacing({1, 1.f / 255.f, 1.f});
        terrain-&gt;SetHeightMap(GetCache()-&gt;GetResource&lt;Image&gt;("Textures/heightmap.png"));

        auto terrain2 = scene_-&gt;CreateChild()-&gt;CreateComponent&lt;Terrain&gt;();
        terrain2-&gt;SetPatchSize(8);
        terrain2-&gt;SetSpacing({1, 1.f / 255.f, 1.f});
        terrain2-&gt;SetHeightMap(GetCache()-&gt;GetResource&lt;Image&gt;("Textures/heightmap.png"));
        terrain2-&gt;GetNode()-&gt;SetPosition({16, 0, 0});
        terrain-&gt;SetEastNeighbor(terrain2);
</code></pre>
<p>And a heightmap. I scaled it up by 800% for demo purposes. Actual image used by code is 17x17.<br/>
<img alt="heightmap" height="136" src="//cdck-file-uploads-global.s3.dualstack.us-west-2.amazonaws.com/standard17/uploads/urho3d/original/1X/6af944210a2f680f3fd53ac23adc909ef38ab056.png" width="136"/></p>
<p>Test code aligns terrain tiles like so:<br/>
<img alt="heightmap" height="136" src="//cdck-file-uploads-global.s3.dualstack.us-west-2.amazonaws.com/standard17/uploads/urho3d/original/1X/6af944210a2f680f3fd53ac23adc909ef38ab056.png" width="136"/><img alt="heightmap" height="136" src="//cdck-file-uploads-global.s3.dualstack.us-west-2.amazonaws.com/standard17/uploads/urho3d/original/1X/6af944210a2f680f3fd53ac23adc909ef38ab056.png" width="136"/></p>
<p>On the right edge of terrain i expected to get seamless transition between terrains, however it looks like this:<br/>
<img alt="terrain" height="441" src="//cdck-file-uploads-global.s3.dualstack.us-west-2.amazonaws.com/standard17/uploads/urho3d/original/1X/682d5dd4ae03f0391d572ac4509627f6fcdf1ebf.png" width="690"/></p>
<p>Notice crack between points painted in white on heightmap. Also neighbour terrains are not taken into account when calculating tiles.</p>
<p>So whats the right way to use terrain in this case?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<aside class="quote" data-post="16" data-topic="3667">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/c74e1d6abd7187cdd2f8199c8cfb922b.png" width="20"/> rku:</div>
<blockquote>
<p>thus for creating 16x16 units terrain i need to use 17x17 heigthmap. Whats the purpose of skipped edge?</p>
</blockquote>
</aside>
<p>Do you mean 16x16 quads?</p>
<aside class="quote" data-post="16" data-topic="3667">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/c74e1d6abd7187cdd2f8199c8cfb922b.png" width="20"/> rku:</div>
<blockquote>
<p>How exactly am i supposed to use SetXXXNeighbor()?</p>
</blockquote>
</aside>
<p>If you want two terrains be seamlessly connected, you should set them as neighbors for each other.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3200_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rku</div>
          <div class="post_content">
<aside class="quote no-group" data-post="17" data-topic="3667" data-username="Eugene">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/ae663b3d37eca5ee603f9e0610f8f829.png" width="20"/> Eugene:</div>
<blockquote>
<p>Do you mean 16x16 quads?</p>
</blockquote>
</aside>
<p>I mean entire terrain being 16x16 quad.</p>
<p>Edit: i suppose 1 pixel in heightmap means one vertex. In order to get 1x1 tile terrain i would need 2x2 heightmap, because one quad needs 4 vertices at the corners. So 16x16 terrain needx 17x17 pixels. Right?</p>
<aside class="quote no-group" data-post="17" data-topic="3667" data-username="Eugene">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/ae663b3d37eca5ee603f9e0610f8f829.png" width="20"/> Eugene:</div>
<blockquote>
<p>If you want two terrains be seamlessly connected, you should set them as neighbors for each other.</p>
</blockquote>
</aside>
<p>Like so?</p>
<pre><code class="lang-cpp">        terrain-&gt;SetEastNeighbor(terrain2);
        terrain2-&gt;SetWestNeighbor(terrain);
</code></pre>
<p>Because it produces exactly same visual result.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<aside class="quote" data-post="18" data-topic="3667">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/c74e1d6abd7187cdd2f8199c8cfb922b.png" width="20"/> rku:</div>
<blockquote>
<p>i suppose 1 pixel in heightmap means one vertex. In order to get 1x1 tile terrain i would need 2x2 heightmap, because one quad needs 4 vertices at the corners. So 16x16 terrain needx 17x17 pixels. Right?</p>
</blockquote>
</aside>
<p>I think so.</p>
<aside class="quote" data-post="18" data-topic="3667">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/c74e1d6abd7187cdd2f8199c8cfb922b.png" width="20"/> rku:</div>
<blockquote>
<p>Because it produces exactly same visual result.</p>
</blockquote>
</aside>
<p>Well, that’s strange. Maybe terrains have different scale?<br/>
They must have connected geometry. Could you check the grid?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3200_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rku</div>
          <div class="post_content">
<aside class="quote no-group" data-post="19" data-topic="3667">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/ae663b3d37eca5ee603f9e0610f8f829.png" width="20"/> Eugene:</div>
<blockquote>
<p>Could you check the grid?</p>
</blockquote>
</aside>
<p>Do you mean seeing debug geometry? Terrain does not have built in debug info rendering on purpose.  I added it myself bit it isnt exactly revealing.<br/>
<img alt="terrain" height="382" src="//cdck-file-uploads-global.s3.dualstack.us-west-2.amazonaws.com/standard17/uploads/urho3d/original/1X/0165f89cf741a116c427daaca509355689d41fba.png" width="690"/></p>
<p>They are of exactly same scale. Snippet i pasted previously - its pretty much all the code setting up scene. Other stuff is just setting up viewport, camera and creating scene object. You can take a look at entire thing: <a href="https://drive.google.com/uc?id=0Bx2UNCIdLR4VazlwQnhObUcySG8" rel="nofollow noopener">terrain.zip</a></p>
<p>Edit:<br/>
I just noticed that white pixel on the right was tiny bit darker than white pixel on the left. That caused height mismatch. But there is still normal issue which makes lighting look weird. Is terrain supposed to take into account neighbouring terrains when calculating normals?</p>
<p><img alt="terrain" height="320" src="//cdck-file-uploads-global.s3.dualstack.us-west-2.amazonaws.com/standard17/uploads/urho3d/original/1X/ea3404e619344951bfe826a82856699573d52591.png" width="690"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<aside class="quote" data-post="20" data-topic="3667">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/c74e1d6abd7187cdd2f8199c8cfb922b.png" width="20"/> rku:</div>
<blockquote>
<p>I just noticed that white pixel on the right was tiny bit darker than white pixel on the left. That caused height mismatch.</p>
</blockquote>
</aside>
<p>I have just noticed too xD</p>
<aside class="quote" data-post="20" data-topic="3667">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/c74e1d6abd7187cdd2f8199c8cfb922b.png" width="20"/> rku:</div>
<blockquote>
<p>But there is still normal issue which makes lighting look weird. Is terrain supposed to take into account neighbouring terrains when calculating normals?</p>
</blockquote>
</aside>
<p>Yeah, I don’t like this lighting. Terrain definetely <em>could</em> pick neighbor’s data when generating normal, but it doesn’t do it for now… It could be hard, but must be possible.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3290_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Modanung</div>
          <div class="post_content">
<p>Looking at the <a >code</a> it seems like neighbours should be set before creating the terrain geometry:</p>
<pre><code class="lang-auto">void Terrain::HandleNeighborTerrainCreated(StringHash eventType, VariantMap&amp; eventData)
{
    UpdateEdgePatchNeighbors();
}
</code></pre>
<pre><code class="lang-auto">    // Send event only if new geometry was generated, or the old was cleared
    if (patches_.Size() || prevNumPatches)
    {
        using namespace TerrainCreated;

        VariantMap&amp; eventData = GetEventDataMap();
        eventData[P_NODE] = node_;
        node_-&gt;SendEvent(E_TERRAINCREATED, eventData);
    }
</code></pre>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<p>Huh, just recalled…<br/>
If you want high-quality terrain lighting, use world-space normal maps.<br/>
Bake true normals of terrain into texture and use them in the shader <em>instead</em> of vertex normals.<br/>
It has almost zero performance penalty, doesn’t requre changes in Terrain and <em>has much much better quality</em>.<br/>
Vertex normals are badly corrupted by geomipmapping and look nasty. Texture is always nice.<br/>
(just a hint)</p>
<aside class="quote" data-post="22" data-topic="3667">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/8b9decec7cc30729aa8f8f7015602d32.png" width="20"/> Modanung:</div>
<blockquote>
<p>Looking at the code it seems like neighbours should be set before creating the terrain geometry</p>
</blockquote>
</aside>
<p>I don’t think that it’s important because Terrain geometry is created via GetRawNormal/GetRawHeight that don’t care about neighbors.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3200_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rku</div>
          <div class="post_content">
<p>Tried setting neighbours before setting heightmap too. <span class="mention">@Eugene</span> guessed right - it had no effect.</p>
<p>Sounds like normals in a texture are easy way around the problem, going to do just that. Thanks <img alt=":wink:" class="emoji" src="../../../images2/95940790c23d98635b2a6d3f22657158.png" title=":wink:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/357_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">JTippetts</div>
          <div class="post_content">
<p>The cool part about using a normal map for normals is you can go higher resolution, to add detail that isn’t there in the heightmap. Bake your normal map from a much higher resolution version of the heightmap, then downsample that heightmap for the actual heightmap, etc… It’s a process I’m working on implementing in my terrain editor.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3200_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rku</div>
          <div class="post_content">
<p>Back to original issue… I found interesting idea on the internets: having depth mask object in a place where hole is supposed to be cut in the terrain. I created material that makes box transparent and all, tried ordering of box and terrain rendering but best i could get was a black or transparent box but no hole in the terrain. Any pointers would be greatly appreciated.</p>
<p>As for collisions one person on youtube mentioned using trigger objects disabling collision with the terrain when passing through masked area. This indeed sounds like perfect solution. Much simpler than altering collision/rendering meshes.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<aside class="quote no-group" data-post="26" data-topic="3667">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/fd3b88ecdc16c24107db787de64d9d59.png" width="20"/> rku:</div>
<blockquote>
<p>I found interesting idea on the internets: having depth mask object in a place where hole is supposed to be cut in the terrain.</p>
</blockquote>
</aside>
<p>I don’t understand the idea, may you elaborate?</p>
<p>BTW, I never liked solutions with stencil and other pipeline hacks because it makes many things broken and manual control is required…</p>
<aside class="quote no-group" data-post="26" data-topic="3667">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/fd3b88ecdc16c24107db787de64d9d59.png" width="20"/> rku:</div>
<blockquote>
<p>This indeed sounds like perfect solution</p>
</blockquote>
</aside>
<p>It is. If you could guarantee that:</p>
<ol>
<li>All your holes have some “restricted area” around the hole edge that is never collided.</li>
<li>This restricted area is bigger that any dynamic object that could collide your hole.<br/>
<img alt="image" height="326" src="../../../images2/8b2903ed990d5d6646b74b86ed027230.png" width="380"/>
</li>
</ol>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3200_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rku</div>
          <div class="post_content">
<aside class="quote no-group" data-post="27" data-topic="3667" data-username="Eugene">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/ae663b3d37eca5ee603f9e0610f8f829.png" width="20"/> Eugene:</div>
<blockquote>
<p>I don’t understand the idea, may you elaborate?</p>
</blockquote>
</aside>
<p>As i understand rendering “mask” object is supposed to alter depth buffer making part of terrain covered by “mask” object transparent.</p>
<p>In video i mentioned mask object shader adds object to rendering queue at <code>Geometry+10</code>. <a href="https://youtu.be/uxXEV91xsSc?t=173" rel="noopener nofollow ugc">link</a><br/>
Same thing is done with terrain material, except its added to queue at <code>Geometry+100</code>. <a href="https://youtu.be/uxXEV91xsSc?t=326" rel="noopener nofollow ugc">link</a></p>
<p>I am not familiar with unity terms, but it seems this technique exploits rendering order.</p>
<p>Possibly:</p>
<ol>
<li>Render mask object, depth buffer modification done here</li>
<li>Render terrain object, previous depth buffer modification prevents terrain from rendering at spot where mask object was visible.</li>
</ol>
<p>Did i get it right?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<p>I see. It must work if you set correct render order. Default is 128. Terrain hole and terrain itself should have bigger order than everything else. Hole technique must have depthwrite=true. Note that hole shader mustn’t discard pixels with zero alpha.</p>
<p>If I understand correctly, this hack won’t work if your Camera could move through the hole.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3200_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rku</div>
          <div class="post_content">
<aside class="quote no-group" data-post="29" data-topic="3667" data-username="Eugene">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/ae663b3d37eca5ee603f9e0610f8f829.png" width="20"/> Eugene:</div>
<blockquote>
<p>If I understand correctly, this hack won’t work if your Camera could move through the hole.</p>
</blockquote>
</aside>
<p>Why not? Considering camera can see through that spot and collisions would be disabled upon moving through…</p>
<p>Could you take a peek at my technique and material?</p>
<pre><code class="lang-xml"> &lt;technique vs="Unlit" ps="Unlit"&gt;
    &lt;pass name="alpha" depthwrite="true" depthtest="lessequal" blend="replace" /&gt;
&lt;/technique&gt;
</code></pre>
<pre><code class="lang-xml">&lt;material&gt;
    &lt;technique name="Techniques/DepthMask.xml" /&gt;
    &lt;parameter name="MatDiffColor" value="0 0 0 0" /&gt;
    &lt;renderorder value="130" /&gt;
&lt;/material&gt; 
</code></pre>
<p>They result in a black mask object. For terrain i am using original <code>Materials/Terrain.xml</code> material by the way.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<aside class="quote" data-post="30" data-topic="3667">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/c74e1d6abd7187cdd2f8199c8cfb922b.png" width="20"/> rku:</div>
<blockquote>
<p>For terrain i am using original Materials/Terrain.xml material by the way.</p>
</blockquote>
</aside>
<p>What about Terrain render order?</p>
<aside class="quote" data-post="30" data-topic="3667">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/c74e1d6abd7187cdd2f8199c8cfb922b.png" width="20"/> rku:</div>
<blockquote>
<p>Why not? Considering camera can see through that spot and collisions would be disabled upon moving through…</p>
</blockquote>
</aside>
<p>Huh, it would be fine if you set front face culling for your mask object material.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3200_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rku</div>
          <div class="post_content">
<aside class="quote no-group" data-post="31" data-topic="3667" data-username="Eugene">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/ae663b3d37eca5ee603f9e0610f8f829.png" width="20"/> Eugene:</div>
<blockquote>
<p>What about Terrain render order?</p>
</blockquote>
</aside>
<p>Terrain material does not set <code>renderorder</code> so it must be default value.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<aside class="quote" data-post="32" data-topic="3667">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/c74e1d6abd7187cdd2f8199c8cfb922b.png" width="20"/> rku:</div>
<blockquote>
<p>Terrain material does not set renderorder so it must be default value.</p>
</blockquote>
</aside>
<p>So it won’t work if you draw terrain before cutting the hole.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3200_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rku</div>
          <div class="post_content">
<p>I tried changing <code>renderorder</code> of mask material to 0, 120, 130, 200. I also tried explicitly adding <code>renderorder</code> to terrain material and changing numbers so their order changes. Nothing has any effect which makes me think i messed up something else in material or technique.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<aside class="quote" data-post="34" data-topic="3667">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/c74e1d6abd7187cdd2f8199c8cfb922b.png" width="20"/> rku:</div>
<blockquote>
<p>Nothing has any effect which makes me think i messed up something else in material or technique.</p>
</blockquote>
</aside>
<p>I don’t know what could be wrong with materials.<br/>
The most important thing is that hole is rendered before terrain:</p>
<blockquote>
<p>I also tried explicitly adding renderorder to terrain material and changing numbers so their order changes.</p>
</blockquote>
<p>The second important thing is that hole material writes depth.</p>
<blockquote>
<p>depthwrite=“true”</p>
</blockquote>
<p>You should be able to see hole if you set alpha = 0.1.<br/>
If you turn lighting on and make your terrain semi-transparend, you should be able to see the actual order of objects: maybe Urho doesn’t handle render order properly.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3200_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rku</div>
          <div class="post_content">
<p>Victory! This is how its done:</p>
<p>For depth mask object:</p>
<pre><code class="lang-xml"> &lt;technique vs="Basic" ps="Basic"&gt;
    &lt;pass name="alpha" depthwrite="true" blend="addalpha" /&gt;
&lt;/technique&gt;
</code></pre>
<pre><code class="lang-xml">&lt;material&gt;
    &lt;technique name="Techniques/DepthMask.xml" /&gt;
    &lt;parameter name="MatDiffColor" value="0 0 0 0" /&gt;
    &lt;renderorder value="129" /&gt;
&lt;/material&gt; 
</code></pre>
<p>For terrain:</p>
<pre><code class="lang-xml">&lt;material&gt;
    &lt;technique name="Techniques/DiffAlpha.xml" /&gt;
    &lt;renderorder value="130" /&gt;
&lt;/material&gt;
</code></pre>
<p>Important: terrain has to have technique supporting alpha. Result:</p>
<p><img alt="2" height="255" src="../../../images2/c2661fed4ff52a7948cb0f7f0503ad1b.gif" width="320"/></p>
<p>Thank you everyone for the help!</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<aside class="quote no-group" data-post="31" data-topic="3667" data-username="Eugene">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/ae663b3d37eca5ee603f9e0610f8f829.png" width="20"/> Eugene:</div>
<blockquote>
<p>Huh, it would be fine if you set front face culling for your mask object material.</p>
</blockquote>
</aside>
<p><span class="mention">@rku</span> Sorry, I was wrong twice. It won’t work in common case.<br/>
This hack won’t work if hole object is not rendered in front of terrain. E.g. if your camera is inside hole object.</p>
<p>PS. Rendering terrain after all other geometry will have negative performance impact due to overdraw.</p>
<p>PS2. Your terrain should also be rendered after semi-transparent things like particles.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3200_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rku</div>
          <div class="post_content">
<p><span class="mention">@Eugene</span> thank you for insights. Indeed this appears to be fitting for just some usecases. I tried making mask object as thin as possible, but even then camera passing through it results in a tiny few pixels strip across entire screen. That strip is terrain being no longer masked. And like you said, performance issues… I guess they could be solved by replacing material of those terrain patches that have holes. Not much point in that considering previous issue.</p>
<p>Back to the drawing board i guess. I took a closer look at terrain code and seems like sentinel height values are off the table as well. Terrain component does a smart thing reusing index buffers between patches. Going to try to experiment by allowing unique index buffers for patches.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<aside class="quote" data-post="39" data-topic="3667">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/c74e1d6abd7187cdd2f8199c8cfb922b.png" width="20"/> rku:</div>
<blockquote>
<p>Back to the drawing board i guess. I took a closer look at terrain code and seems like sentinel height values are off the table as well. Terrain component does a smart thing reusing index buffers between patches. Going to try to experiment by allowing unique index buffers for patches.</p>
</blockquote>
</aside>
<p>I don’t think it’s good solution if you want to use geomipmapping. There is no change to generate nice automatic LODs for terrain with corrupted geometry.</p>
<p>Heightfield use R or RG channels for height.<br/>
You could use B channel to mask holes for physics.<br/>
Of course, you’ll need semi-transparent material for terrain.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3200_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rku</div>
          <div class="post_content">
<aside class="quote no-group" data-post="40" data-topic="3667" data-username="Eugene">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/ae663b3d37eca5ee603f9e0610f8f829.png" width="20"/> Eugene:</div>
<blockquote>
<p>I don’t think it’s good solution if you want to use geomipmapping. There is no change to generate nice automatic LODs for terrain with corrupted geometry.</p>
</blockquote>
</aside>
<p>My idea was to allow it generate and process all vertices and only to not render triangles where at least one vertex is at zero height.</p>
<aside class="quote no-group" data-post="40" data-topic="3667" data-username="Eugene">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/ae663b3d37eca5ee603f9e0610f8f829.png" width="20"/> Eugene:</div>
<blockquote>
<p>Of course, you’ll need semi-transparent material for terrain.</p>
</blockquote>
</aside>
<p>But transparent objects are rendered after geometry, so it means overdraw like with previous approach, no?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<aside class="quote" data-post="41" data-topic="3667">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/c74e1d6abd7187cdd2f8199c8cfb922b.png" width="20"/> rku:</div>
<blockquote>
<p>But transparent objects are rendered after geometry, so it means overdraw like with previous approach, no?</p>
</blockquote>
</aside>
<p>1-bit transparency is rendered like solid, so it’s fine (ALPHAMASK pixel shared define in material).</p>
<aside class="quote" data-post="41" data-topic="3667">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/c74e1d6abd7187cdd2f8199c8cfb922b.png" width="20"/> rku:</div>
<blockquote>
<p>My idea was to allow it generate and process all vertices and only to not render triangles where at least one vertex is at zero height.</p>
</blockquote>
</aside>
<p>You will either have your holes disappearing (if hole is fully covered with low-quality LOD) or growing x2-x4-x8-etc (if it’s not) as lod quality is decreased. Impossible to control, impossible to tune. The only way is to disable geomipmapping at all.</p>
          </div>
        </div>
      </div>


    </div>
  </body>
</html>