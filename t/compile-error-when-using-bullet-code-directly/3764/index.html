<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width">
    <title>Compile error when using bullet code directly</title>
    <link rel="stylesheet" href="../../../archived.css" />
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']]}});
    </script>
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  </head>

  <body>
    <header class="header">
      <div class="title-span">
        <a href="../../../">
          <img src="../../../images/site-logo.png" height="40" alt="Urho3D" id="site-logo" />
        </a>
      </div>
    </header>

    <div class="main">
    <div class="archive-span">Archive 17/01/2023.</div>
    <h1 class="topic-title">Compile error when using bullet code directly</h1>
            <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">mazataza</div>
          <div class="post_content">
<p>I am try to create character control using suche code</p>
<p>btTransform startTransform;<br/>
startTransform.setIdentity ();<br/>
<a href="//startTransform.setOrigin" rel="nofollow noopener">//startTransform.setOrigin</a> (btVector3(0.0, 4.0, 0.0));<br/>
const Vector3 &amp;postion = <em>cameraNode-&gt;GetWorldPosition();<br/>
startTransform.setOrigin (btVector3(postion.x</em>, postion.y_, postion.z_));</p>
<pre><code>ghostObject = new btPairCachingGhostObject();
ghostObject-&gt;setWorldTransform(startTransform);

btScalar characterHeight=1.75;
btScalar characterWidth =1.75;
ghostShape = new btCapsuleShape(characterWidth,characterHeight);
ghostObject-&gt;setCollisionShape (ghostShape);
ghostObject-&gt;setCollisionFlags (btCollisionObject::CF_CHARACTER_OBJECT);

btScalar stepHeight = btScalar(0.35);
characterController = new btKinematicCharacterController (ghostObject,ghostShape,stepHeight);
</code></pre>
<p>when compiling it with Clion i got following linking error</p>
<p>CMakeFiles\LoadScene.dir/objects.a(CharacterComponent.cpp.obj): In function <code>btAlignedAllocator&lt;int, 16u&gt;::deallocate(int*)': C:/3d/Urho3D.git/Urho3D-SDK-Shared/include/Urho3D/ThirdParty/Bullet/LinearMath/btAlignedAllocator.h:96: undefined reference to</code>btAlignedFreeInternal(void*)‘<br/>
CMakeFiles\LoadScene.dir/objects.a(CharacterComponent.cpp.obj): In function <code>btAlignedAllocator&lt;btHashInt, 16u&gt;::deallocate(btHashInt*)': C:/3d/Urho3D.git/Urho3D-SDK-Shared/include/Urho3D/ThirdParty/Bullet/LinearMath/btAlignedAllocator.h:96: undefined reference to</code>btAlignedFreeInternal(void*)‘<br/>
CMakeFiles\LoadScene.dir/objects.a(CharacterComponent.cpp.obj): In function <code>btAlignedAllocator&lt;btTriangleInfo, 16u&gt;::deallocate(btTriangleInfo*)': C:/3d/Urho3D.git/Urho3D-SDK-Shared/include/Urho3D/ThirdParty/Bullet/LinearMath/btAlignedAllocator.h:96: undefined reference to</code>btAlignedFreeInternal(void*)‘<br/>
CMakeFiles\LoadScene.dir/objects.a(CharacterComponent.cpp.obj):CharacterComponent.cpp:(.rdata$_ZTV17btTypedConstraint[_ZTV17btTypedConstraint]+0x60): undefined reference to <code>btTypedConstraint::serialize(void*, btSerializer*) const' CMakeFiles\LoadScene.dir/objects.a(CharacterControl.cpp.obj): In function</code>btCollisionObject::operator new(unsigned long long)’:<br/>
C:/3d/Urho3D.git/Urho3D-SDK-Shared/include/Urho3D/ThirdParty/Bullet/BulletCollision/CollisionDispatch/btCollisionObject.h:129: undefined reference to <code>btAlignedAllocInternal(unsigned long long, int)' CMakeFiles\LoadScene.dir/objects.a(CharacterControl.cpp.obj): In function</code>CharacterControl::CharacterControl(Urho3D::Context*, Urho3D::Scene*)’:<br/>
C:/3d/Urho3D.git/Urho3D-SDK-Shared/include/Urho3D/ThirdParty/Bullet/BulletCollision/CollisionDispatch/btCollisionObject.h:129: undefined reference to <code>btPairCachingGhostObject::btPairCachingGhostObject()' CMakeFiles\LoadScene.dir/objects.a(CharacterControl.cpp.obj): In function</code>btCapsuleShape::operator new(unsigned long long)’:<br/>
C:/3d/Urho3D.git/Urho3D-SDK-Shared/include/Urho3D/ThirdParty/Bullet/BulletCollision/CollisionShapes/btCapsuleShape.h:37: undefined reference to <code>btAlignedAllocInternal(unsigned long long, int)' CMakeFiles\LoadScene.dir/objects.a(CharacterControl.cpp.obj): In function</code>CharacterControl::CharacterControl(Urho3D::Context*, Urho3D::Scene*)’:<br/>
C:/3d/Urho3D.git/samples/LoadScene/CharacterControl.cpp:21: undefined reference to <code>btCapsuleShape::btCapsuleShape(float, float)' CMakeFiles\LoadScene.dir/objects.a(CharacterControl.cpp.obj): In function</code>btKinematicCharacterController::operator new(unsigned long long)’:<br/>
C:/3d/Urho3D.git/Urho3D-SDK-Shared/include/Urho3D/ThirdParty/Bullet/BulletDynamics/Character/btKinematicCharacterController.h:118: undefined reference to <code>btAlignedAllocInternal(unsigned long long, int)' CMakeFiles\LoadScene.dir/objects.a(CharacterControl.cpp.obj): In function</code>CharacterControl::CharacterControl(Urho3D::Context*, Urho3D::Scene*)’:<br/>
C:/3d/Urho3D.git/samples/LoadScene/CharacterControl.cpp:26: undefined reference to <code>btKinematicCharacterController::btKinematicCharacterController(btPairCachingGhostObject*, btConvexShape*, float, btVector3 const&amp;)' CMakeFiles\LoadScene.dir/objects.a(CharacterControl.cpp.obj): In function</code>btCollisionObject::operator delete(void*)’:<br/>
C:/3d/Urho3D.git/Urho3D-SDK-Shared/include/Urho3D/ThirdParty/Bullet/BulletCollision/CollisionDispatch/btCollisionObject.h:129: undefined reference to <code>btAlignedFreeInternal(void*)' CMakeFiles\LoadScene.dir/objects.a(CharacterControl.cpp.obj): In function</code>btCapsuleShape::operator delete(void*)’:<br/>
C:/3d/Urho3D.git/Urho3D-SDK-Shared/include/Urho3D/ThirdParty/Bullet/BulletCollision/CollisionShapes/btCapsuleShape.h:37: undefined reference to <code>btAlignedFreeInternal(void*)' CMakeFiles\LoadScene.dir/objects.a(CharacterControl.cpp.obj): In function</code>btKinematicCharacterController::operator delete(void*)’:<br/>
C:/3d/Urho3D.git/Urho3D-SDK-Shared/include/Urho3D/ThirdParty/Bullet/BulletDynamics/Character/btKinematicCharacterController.h:118: undefined reference to `btAlignedFreeInternal(void*)'<br/>
collect2.exe: error: ld returned 1 exit status<br/>
CMakeFiles\LoadScene.dir\build.make:151: recipe for target ‘bin/LoadScene_d.exe’ failed<br/>
mingw32-make.exe[3]: *** [bin/LoadScene_d.exe] Error 1<br/>
mingw32-make.exe[2]: *** [CMakeFiles/LoadScene.dir/all] Error 2<br/>
mingw32-make.exe[1]: *** [CMakeFiles/LoadScene.dir/rule] Error 2<br/>
CMakeFiles\Makefile2:66: recipe for target ‘CMakeFiles/LoadScene.dir/all’ failed<br/>
CMakeFiles\Makefile2:78: recipe for target ‘CMakeFiles/LoadScene.dir/rule’ failed<br/>
Makefile:163: recipe for target ‘LoadScene’ failed<br/>
mingw32-make.exe: *** [LoadScene] Error 2</p>
<p>any idea what can case this ?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/975_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">ppsychrite</div>
          <div class="post_content">
<p>I’ve had something similar to this when I tried doing what you are.</p>
<p>What fixed it for me was including bullet headers before urho3d’s headers and adding</p>
<pre><code>#undef new
</code></pre>
<p>Hope that helps! <img alt=":slight_smile:" class="emoji" src="../../../images2/ab33f6c546ca85e7d84a4e3c32cd4034.png" title=":slight_smile:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">mazataza</div>
          <div class="post_content">
<p>thanks for your replay but i add what you said but i still got the error <img alt=":frowning:" class="emoji" src="../../../images2/2506cac83464f3f86e257fa414340d4c.png" title=":frowning:"/></p>
<p><span class="hashtag">#include</span> &lt;Urho3D/ThirdParty/Bullet/btBulletCollisionCommon.h&gt;<br/>
<span class="hashtag">#include</span> &lt;Urho3D/ThirdParty/Bullet/btBulletDynamicsCommon.h&gt;<br/>
<span class="hashtag">#include</span> &lt;Urho3D/ThirdParty/Bullet/BulletCollision/CollisionDispatch/btGhostObject.h&gt;<br/>
<span class="hashtag">#include</span> &lt;Urho3D/ThirdParty/Bullet/BulletDynamics/Character/btKinematicCharacterController.h&gt;</p>
<p><span class="hashtag">#undef</span> new</p>
<p><span class="hashtag">#include</span> &lt;Urho3D/Core/CoreEvents.h&gt;<br/>
<span class="hashtag">#include</span> &lt;Urho3D/Engine/Application.h&gt;<br/>
<span class="hashtag">#include</span> &lt;Urho3D/Engine/Engine.h&gt;<br/>
<span class="hashtag">#include</span> &lt;Urho3D/Input/Input.h&gt;<br/>
<span class="hashtag">#include</span> &lt;Urho3D/Input/InputEvents.h&gt;</p>
<p><span class="hashtag">#include</span> &lt;Urho3D/Graphics/Camera.h&gt;<br/>
<span class="hashtag">#include</span> &lt;Urho3D/Graphics/Graphics.h&gt;<br/>
<span class="hashtag">#include</span> &lt;Urho3D/Resource/ResourceCache.h&gt;<br/>
<span class="hashtag">#include</span> &lt;Urho3D/Scene/Scene.h&gt;<br/>
<span class="hashtag">#include</span> &lt;Urho3D/Graphics/Renderer.h&gt;<br/>
<span class="hashtag">#include</span> &lt;Urho3D/Graphics/Viewport.h&gt;<br/>
<span class="hashtag">#include</span> &lt;Urho3D/UI/UI.h&gt;<br/>
<span class="hashtag">#include</span> &lt;Urho3D/UI/UIEvents.h&gt;</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>Try using STATIC version of the Urho3D library to see if it helps. The SHARED lib may have unused 3rd-party symbols optimized away at the time the lib is built. The STATIC lib on the other hand is an archive of all the symbols there are.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">mazataza</div>
          <div class="post_content">
<p>yes with static version i compiled it works …</p>
<p>i think that what you said about optimization is the issue, only the parts which are used by Urho3D to build Physic world is linked against.</p>
<p>but is there any way to let shared library of Urho3D to have all code without optimization on discarding any unused code? because a library should have all code compiled and included. when i for example compile libc as shared library i can’t expect that some methods are discards from the shared lib at the end.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/902_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Eugene</div>
          <div class="post_content">
<aside class="quote no-group" data-post="5" data-topic="3764" data-username="mazataza">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/2b1581678de76786a5abe6088684c240.png" width="20"/> mazataza:</div>
<blockquote>
<p>but is there any way to let shared library of Urho3D to have all code without optimization on discarding any unused code?</p>
</blockquote>
</aside>
<p>To be fair, I’d like to avoid SHARED build of Urho at all. Memory management is awful. If you want to take DLL pain, make your own DLL and link it with Urho statically.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">mazataza</div>
          <div class="post_content">
<p>my target is later is android … thus it is better to link it with static and in android it will be at the end a shared lib.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>Perhaps there is something wrong with how we setup for library building for the SHARED lib type and even to certain extent the STATIC lib type as well. The setup is non-trivial considering we have to make it work for MSVC/GCC/Xcode with the same build script. We have attempted to use the <code>--whole-archive</code> linker flag on GCC to get as much symbols included, nevertheless from the past user feedback we aware some symbols are still optimized away. Alternative to use “export map” is beyond our mean (no one would spend time to maintain the map in the long run).</p>
<p>p.s. Aside from this, there is inherently nothing wrong in using a SHARED lib. DLL is another story though, user need to worry certain thing when the DLL boundary is crossed.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">slapin</div>
          <div class="post_content">
<p>No exported symbols can be optimized-away from static library.<br/>
For shared it is possible to hide symbols, but that depends on the way it is built.<br/>
More likely is that some parts are excluded from being in .a which might be checked.<br/>
as for .so I think only URHO3D_API symbols are exported, hence the error is produced<br/>
for linking.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">mazataza</div>
          <div class="post_content">
<p>i agree that shared or static should work … i think it may be related how DLL export symboles.</p>
          </div>
        </div>
      </div>


    </div>
  </body>
</html>