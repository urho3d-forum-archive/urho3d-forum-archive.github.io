<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width">
    <title>DetourCrowd implementation</title>
    <link rel="stylesheet" href="../../../archived.css" />
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']]}});
    </script>
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  </head>

  <body>
    <header class="header">
      <div class="title-span">
        <a href="../../../">
          <img src="../../../images/site-logo.png" height="40" alt="Urho3D" id="site-logo" />
        </a>
      </div>
    </header>

    <div class="main">
    <div class="archive-span">Archive 17/01/2023.</div>
    <h1 class="topic-title">DetourCrowd implementation</h1>
            <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">scorvi</div>
          <div class="post_content">
<p>hey,</p>
<p>i am adding detour crowd component to the engine. I have a running sample but i did not create a DetourCrowd lib.<br/>
i want to add this to the engine core libs but DetourCrowd needs detour and i dont know how to add it to the cmake file …</p>
<p>my cmake file is in Urho3DDetour\Source\ThirdParty\DetourCrowd and looks like this:</p>
<p>[code]# Define target name<br/>
set (TARGET_NAME DetourCrowd)</p>
<h1>Define source files</h1>
<p>file (GLOB CPP_FILES source/<em>.cpp)<br/>
file (GLOB H_FILES include/</em>.h)<br/>
set (SOURCE_FILES ${CPP_FILES} ${H_FILES})</p>
<h1>Define dependency libs</h1>
<p>set (INCLUDE_DIRS_ONLY include)</p>
<h1>Setup target</h1>
<p>setup_library ()<br/>
[/code]</p>
<p>i am compiling with visual studio and i get now the error :</p>
<p><code>Fehler	1	error C1083: Datei (Include) kann nicht ge?ffnet werden: "DetourNavMeshQuery.h": No such file or directory\Urho3DDetour\Source\ThirdParty\DetourCrowd\include\DetourCrowd.h	22	1	DetourCrowd
Fehler	2	error C1083: Datei (Include) kann nicht ge?ffnet werden: "DetourNavMeshQuery.h": No such file or directory	\Urho3DDetour\Source\ThirdParty\DetourCrowd\include\DetourLocalBoundary.h	22	1	DetourCrowd
Fehler	3	error C1083: Datei (Include) kann nicht ge?ffnet werden: "DetourCommon.h": No such file or directory	\Urho3DDetour\Source\ThirdParty\DetourCrowd\source\DetourObstacleAvoidance.cpp	20	1	DetourCrowd
Fehler	4	error C1083: Datei (Include) kann nicht ge?ffnet werden: "DetourNavMeshQuery.h": No such file or directory	\Urho3DDetour\Source\ThirdParty\DetourCrowd\include\DetourPathCorridor.h	22	1	DetourCrowd
Fehler	5	error C1083: Datei (Include) kann nicht ge?ffnet werden: "DetourNavMesh.h": No such file or directory	\Urho3DDetour\Source\ThirdParty\DetourCrowd\include\DetourPathQueue.h	22	1	DetourCrowd
Fehler	6	error C1083: Datei (Include) kann nicht ge?ffnet werden: "DetourCommon.h": No such file or directory \Urho3DDetour\Source\ThirdParty\DetourCrowd\source\DetourProximityGrid.cpp	22	1	DetourCrowd
</code></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">cadaver</div>
          <div class="post_content">
<p>You should be able to add Detour’s include dir to the “set (INCLUDE_DIRS_ONLY)” statement, using a relative path like …/Detour/include.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">scorvi</div>
          <div class="post_content">
<p>yes thx that did it ^^</p>
<p>i have now extended the navigation sample with detourcrowd and it works <img alt=":slight_smile:" class="emoji" src="../../../images2/ab33f6c546ca85e7d84a4e3c32cd4034.png" title=":slight_smile:"/><br/>
created comonents are:<br/>
DetourCrowdManager<br/>
DetourCrowdAgent</p>
<p>i implemented DetourCrowd like the Physics components.<br/>
you have to create  DetourCrowdManager  to the root scene node (like PhysicsWorld) and you can add DetourCrowdAgent to your nodes (like RigidBody).<br/>
But you can also only use DetourCrowdManager::AddAgent function to get the agents id. With the id you can call  DetourCrowdManager::GetAgentPosition(id) … so that you dont have to use the  DetourCrowdAgent component.</p>
<p>i am also updating the NavigationMesh with NavmeshPartitionTypes and a add the debug functions memononen used in his demo, for better debuging ^^<br/>
after that i will add a AnnotationBuilder component to create cover points and Jump Links (<a href="http://digestingduck.blogspot.fi/2011/07/paris-gameai-conference-2011-slides-and.html" rel="nofollow noopener">digestingduck.blogspot.fi/2011/0 … s-and.html</a>)</p>
<p>can that be added to the engine (after code cleanup) ?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">scorvi</div>
          <div class="post_content">
<p>so added the new navmesh debug view …</p>
<p>but i have now another problem,<br/>
if i add this line in NavigationMesh::RegisterObject(Context* context) :</p>
<pre><code class="lang-auto">ENUM_ACCESSOR_ATTRIBUTE(NavigationMesh, "Partition Type", GetPartitionType, SetPartitionType, NavmeshPartitionType, navmeshPartitionTypeNames, NAVMESH_PARTITION_WATERSHED, AM_DEFAULT);</code></pre>
<p>the urho3d lib compiles but the navigation sample does not. it gets some kind of link error, does not now NavmeshPartitionType … but without that line it compiles !</p>
<p><a data-bbcode="true" href="http://imgur.com/kCBpcOQ" rel="nofollow noopener"><img alt="" height="480" src="../../../images2/d4c5ac19e3457d12e3011d9ec5d405f8.jpg" width="640"/></a><br/>
<a data-bbcode="true" href="http://imgur.com/nDTUFh3" rel="nofollow noopener"><img alt="" height="480" src="../../../images2/fbc56357ae70adf2c1ea31864bfe1837.jpg" width="640"/></a></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">cadaver</div>
          <div class="post_content">
<p>Yes, when you make a pull request it will be added (pending any cleanup or fixes) and it completes one of the issues we have marked on the tracker.</p>
<p>If the NavmeshPartitionType is an enum defined in the bowels of Detour I recommend to change the type in the NavigationMesh public API to int or unsigned if possible and cast to the Detour type only internally.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>I don’t know how to express this properly but the screenshots look so “delicious” <img alt=":slight_smile:" class="emoji" src="../../../images2/ab33f6c546ca85e7d84a4e3c32cd4034.png" title=":slight_smile:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">scorvi</div>
          <div class="post_content">
<aside class="quote no-group">
<blockquote>
<p>If the NavmeshPartitionType is an enum defined in the bowels of Detour I recommend to change the type in the NavigationMesh public API to int or unsigned if possible and cast to the Detour type only internally.</p>
</blockquote>
</aside>
<p>the enum is defined in NavigationMesh.h/cpp so i added</p>
<p><code> 
 const char* navmeshPartitionTypeNames[] =
 {
 "watershed",
 "monotone",
 "layers",
 0
 };
template&lt;&gt; NavmeshPartitionType Variant::Get&lt;NavmeshPartitionType&gt;() const
 {
 return (NavmeshPartitionType)GetInt();
 }</code></p>
<p>and it works now ^^</p>
<aside class="quote no-group">
<blockquote>
<p>I don’t know how to express this properly but the screenshots look so “delicious” <img alt=":slight_smile:" class="emoji" src="../../../images2/7bdd5ab4d67675d002d99e4b948c8cdb.png" title=":slight_smile:"/></p>
</blockquote>
</aside>
<p>yeah, the new debug view from memononen is nice, but i think it needs a staticModel or customGeometry implentation for speed and so that it can be culled.<br/>
I added the annotation builder but it does not find all jump down links …<br/>
And the first iteration is online <a href="https://github.com/scorvi/Urho3D/tree/DetourCrowd" rel="nofollow noopener">github.com/scorvi/Urho3D/tree/DetourCrowd</a></p>
<p><a data-bbcode="true" href="http://imgur.com/3KGhszO" rel="nofollow noopener"><img alt="" height="480" src="../../../images2/7e81a44b302d71d3eff496e15293a78f.jpg" width="640"/></a></p>
<p><a data-bbcode="true" href="http://imgur.com/qeVQGHu" rel="nofollow noopener"><img alt="" height="480" src="../../../images2/216dbdf074b558d3576fc812e7769783.jpg" width="640"/></a></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Great job so far scorvi, thanks for sharing  <img alt=":stuck_out_tongue:" class="emoji" src="../../../images2/31a2303e479834609bf5befdf8c3501a.png" title=":stuck_out_tongue:"/></p>
<p>I’ve had to fix 3 CMakeLists (due to inconsistant use of lower/upper case for source folders’ name) and DetourCrowdManager.cpp to make it work, maybe fork is not up-to-date.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">scorvi</div>
          <div class="post_content">
<p>[quote=“Mike”]Great job so far scorvi, thanks for sharing  <img alt=":stuck_out_tongue:" class="emoji" src="../../../images2/2163fe85d10cc0d651a6a2d04efe61d0.png" title=":stuck_out_tongue:"/></p>
<p>I’ve had to fix 3 CMakeLists (due to inconsistant use of lower/upper case for source folders’ name) and DetourCrowdManager.cpp to make it work, maybe fork is not up-to-date.[/quote]</p>
<p>hmm i just updated the source folder. can you check if the the issues are no resolved or can you say what you edited ?</p>
<p>so i just added the navigation agent and a crowd debug view</p>
<p><a data-bbcode="true" href="http://imgur.com/Y9K8tsn" rel="nofollow noopener"><img alt="" height="480" src="../../../images2/77a817f6365d4eb0dffee8adc8b7adbd.jpg" width="640"/></a><br/>
<a data-bbcode="true" href="http://imgur.com/9IL02fh" rel="nofollow noopener"><img alt="" height="480" src="../../../images2/40bdb293ff1d8da54586b6bc03a2892a.jpg" width="640"/></a></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>I’ll send you a pull-request so you will be able to see the modifications, maybe some compilers are not case-sensitive.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/357_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">JTippetts</div>
          <div class="post_content">
<p>I am pretty eager to see this go to master. Looking good.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">scorvi</div>
          <div class="post_content">
<p>hey<br/>
i think it is ready to go in the master branch but it is not complete …  i put some todos in there but they are not important one.  so if someone can look at the code and say it is ok i will make a pull request.<br/>
hmm  the annotation builder is not ready so it will not upload it. i also made a sample project.</p>
<p>hmm there was a problem with lower/upper case for include/source folders’ names so i changed them to lower cases but github does not update them :-/ how can i update/change folder names ?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/357_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">JTippetts</div>
          <div class="post_content">
<p>I think it might still need a little bit of work before it can be pulled into master. At the very least, it would need the Script and LuaScript bindings. Also, I suspect cadaver would probably want to see vecmath.h and vecmath.cpp replaced. I recommend you check the contribution checklist at <a href="http://urho3d.github.io/documentation/HEAD/_contribution_checklist.html" rel="nofollow noopener">urho3d.github.io/documentation/H … klist.html</a> before you do the pull request, just to make sure you’ve gotten everything in order.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">scorvi</div>
          <div class="post_content">
<p>ahh ok thx for the link. i did not see that documentation …</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/357_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">JTippetts</div>
          <div class="post_content">
<p>I’ve forked your repo and am currently doing some stuff, including writing bindings. I can send you a pull request when I’m done, if you like.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Hey Scorvi and Joshua,<br/>
Are you still working on DetourCrowd?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/357_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">JTippetts</div>
          <div class="post_content">
<p>I am kinda/sorta still working on it, as I can in between 12 hr shifts at work. For the immediate future, I plan to read the Detour Crowd docs through again to see where I can best make some changes. I’ve got the Lua and Angelscript bindings started for DetourCrowdManager and NavigationAgent, and have made only a few slight changes to what scorvi originally wrote to facilitate the bindings. You can check out what I’ve got so far at my fork: <a href="https://github.com/JTippetts/Urho3D/tree/DetourCrowd" rel="nofollow noopener">github.com/JTippetts/Urho3D/tree/DetourCrowd</a></p>
<p>The AngelScript sample is the most complete, and in fact I haven’t started a Lua sample or kept the C++ sample up-to-date with what I’ve been doing. I’m still a long way from where I want to get with things, but I’ll keep plugging away.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Thanks for reply Joshua.<br/>
From gamedev I’ve seen that your new job has tough rythms.<br/>
Let me know if I can be of any help, for example for the lua sample and updating the C++ sample.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Azalrion</div>
          <div class="post_content">
<p>It might be worthwhile on adding the masagroup (<a href="https://github.com/masagroup/recastdetour" rel="nofollow noopener">github.com/masagroup/recastdetour</a>) improvements to DetourCrowd to provide specific navigation behaviors instead of just pure path following. Happy to do so and create a pull request if no one has any objections.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/357_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">JTippetts</div>
          <div class="post_content">
<p>I notice that the base Recast/Detour git repo has recent activity, but the Masa group one last had a commit a year ago. I, personally, have no objection to the switch if it adds functionality, as long as we don’t get stuck in an abandoned fork that isn’t going anywhere.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Azalrion</div>
          <div class="post_content">
<p>Seems most of the changes in the main repo are to do with bug fixes and filter changes, should be fairly simple to rebase the masa group work onto the main repo to keep both sets of changes, the major difference is that collision avoidance is not done by default in masa group but needs to be chained with other behaviors and so that requires a fairly large change to DetourCrowd, would also mean we would have to keep the Urho version manually updated.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/357_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">JTippetts</div>
          <div class="post_content">
<p>Okay, that’s fine with me. Although since this is scorvi’s baby, maybe he’d like to weigh in. I’m guessing, too, that we’ll probably need to do some redesigning of the component classes to take advantage of it. Perhaps we should take this to a thread in Developer Talk or something.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Azalrion</div>
          <div class="post_content">
<p>Spent some time looking at this some more while off work (slow going with only one hand for typing), not worth moving to masa crowd at the moment it would be a complete re-write. Instead just working on finishing and tidying the current impl up with things such as per agent flags, height, radius, more pathing events and getting it to play nice with physics. I’ll add a branch to the main urho repo soon for everyone to play with.</p>
<p>[video]<a href="https://www.youtube.com/watch?v=BpB_Ar31O8I%5B/video%5D" rel="nofollow noopener">https://www.youtube.com/watch?v=BpB_Ar31O8I[/video]</a></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">OvermindDL1</div>
          <div class="post_content">
<p>Looks fascinating, looking forward.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/1151_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">hdunderscore</div>
          <div class="post_content">
<p>Very cool !</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>Any update on this work? It has been months since the last post.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/119_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">codingmonkey</div>
          <div class="post_content">
<p>Awesome, great work!<br/>
Is it going into master also ?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/62_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">GoogleBot42</div>
          <div class="post_content">
<p>Great work!  Looks amazing!   <img alt=":smiley:" class="emoji" src="../../../images2/c16ddadcbd525aa6d219a1df596d362f.png" title=":smiley:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>I have been looking forward for this. Thanks for sharing it.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>That makes two of us, I am no CMake guru too. I only know enough of the tool to use it to scratch my own itch. I just have a quick look on your Urho3D fork and I agree with you that this approach will make the future update harder than necessary. What kind of problem you encounter when trying to add those sub-libs separately as recommended by memononen. There should be no problem to modify the CMakeLists.txt for one sub-lib to depend on the include dir from the other sub-lib.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">TikariSakari</div>
          <div class="post_content">
<p>I’ve been trying to have some sort of obstacle like thing with the urho and navmeshes, but looks like this would make it a lot easier for moving objects than having to constantly rebuild the navmesh. So big thanks for this.</p>
<p>I tested out the example, and I noticed that the characters do not move that close to the point where I actually click. I feel like in general it was bottom left corner where a crowd settled to considering where my mouse was, not center.</p>
<p>On the screenshot the cursor in middle of the screen came from taking the screenshot, so the “real” cursor is the other one.<br/>
<a data-bbcode="true" href="http://i.imgur.com/zToLG0e.jpg" rel="nofollow noopener">http://i.imgur.com/zToLG0e.jpg</a><br/>
I guess this line is the culpirit</p>
<pre><code class="lang-auto">agent-&gt;SetMoveTarget(pathPos + Vector3(Random(7.0f), 0.0f, Random(7.0f)));</code></pre>
<p>Also it feels bit odd that even if I only have one jack moving, it still goes off from the point of where I click, but that is more of an example thing rather than a bug with the detour crowd.</p>
<p>Another thing that I noticed is that there seems to be some sort of easing with the moving. By easing I mean that the jacks “drive” past the target point, then go back few steps. As far as I looked at the example, I didn’t see this behavior being set, so this is by default I assume?.  I hope that there is a way to set this to a linear interpolation.</p>
<p>Edit: Also I was curious with the example what would happen if I tried to move the characters into top right corner of the scene. Since it sets the movement points to location + bit of randomness. It turns out that if it doesn’t random a point that actually exists on the plane, those units do not move at all.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">thebluefish</div>
          <div class="post_content">
<p>Any estimate for when this gets merged with the urho3d master branch?</p>
<p>It looks like I’ve ran across a couple of issues with this. They seem to revolve around the CrowdAgent component. Right now I’m saving out a node with everything configured, and then instantiating it later.</p>
<p>The first issue is that when I load the node xml, and then save it back out, the CrowdAgent no longer moves. ResourceCache is set to auto-refresh the files. I am calling the following, which is still being called every frame:</p>
<pre><code class="lang-auto">Urho3D::CrowdAgent* agent = GetNode()-&gt;GetComponent&lt;Urho3D::CrowdAgent&gt;();
			agent-&gt;SetMoveTarget(_playerNode-&gt;GetPosition());</code></pre>
<p>The second issue is what happens when I don’t do that. If I simply load the game and play it without saving the xml, then the CrowdAgent properly moves around. However all agents start at position (0,0,0). This happens even though I’m creating the node at a specific position before-hand.</p>
<p>If I load the node, then save it out (reproducing the first issue), I can see the agents positioned properly.</p>
<p>Edit:</p>
<p>It appears that the second issue comes from the fact that the node’s position is set after all of its components are added when calling InstantiateXML. Debugging shows that the node is created, the component added, the agent added to the crowd manager, then the node’s position is set. I have currently worked around this by using the following code:</p>
<pre><code class="lang-auto">Urho3D::XMLFile* file = cache-&gt;GetResource&lt;Urho3D::XMLFile&gt;("Objects/Enemy.xml");

			Urho3D::DynamicNavigationMesh* navMesh = GetComponent&lt;Urho3D::DynamicNavigationMesh&gt;();
			Urho3D::Vector3 position = navMesh-&gt;GetRandomPoint();
			Urho3D::Node* node = GetScene()-&gt;InstantiateXML(file-&gt;GetRoot(), position, GetNode()-&gt;GetRotation());

			Urho3D::CrowdAgent* agent = node-&gt;GetComponent&lt;Urho3D::CrowdAgent&gt;();
			if (agent)
			{
				agent-&gt;SetEnabled(false);
				node-&gt;SetPosition(position);
				agent-&gt;SetEnabled(true);
			}</code></pre>
<p>Edit:</p>
<p>It looks like the first issue is related to the fact that DetourCrowdManager is automatically created when loading the node in the editor. Apparently having this component already in the scene appears to break things.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">thebluefish</div>
          <div class="post_content">
<p>For the first issue - The DetourCrowdManager and DynamicNavigationMesh are both created in the editor. The CrowdAgent is created during runtime by a scene-level component. I actually serialize out the editor scene and then serialize it back in when testing the game, and it still breaks if DetourCrowdManager is present initially.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">thebluefish</div>
          <div class="post_content">
<p>I have been playing with this for a few days now. I have found a few issues:</p>
<ul>
<li>There is a slow down after a number of agents has been created. I find that around 190-200 (~100 in Debug) agents with a move target begins to show some slowdown at around 30 FPS on this PC. At around 250-300 (~120-150) agents, that drops to &lt;1 FPS on the same machine. If there aren’t any move targets, then there’s no slow down. I have reproduced this with nodes with only the CrowdAgent component in order to rule out other components (ParticleEmitter, etc…) being the problem.</li>
</ul>
<p>It would also be nice to have some additional functions in DetourCrowdManager. In particle, getset the max number of agents, and getting a list of agents would be nice. I’ve implemented these in my branch in a dirty way for now though.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/827_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">friesencr</div>
          <div class="post_content">
<p>If I recall from the docs, 1ms / 30 agents from just detour crowd.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/357_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">JTippetts</div>
          <div class="post_content">
<p>Just saw that this has been pulled into master. Thanks a lot for continuing work on this thing.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>I have said it in my earlier post but thanks again for your awesome work. BTW, the HTML5 version of the new sample is uploaded this morning. <a href="http://urho3d.github.io/samples/39_CrowdNavigation.html">urho3d.github.io/samples/39_CrowdNavigation.html</a></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>I made a line comment in the GitHub on these lines of code: <a >github.com/urho3d/Urho3D/blob/m … #L504-L507</a>. In my opinion, I think navigation should not depend on physics. Any objection to change the event type from E_PHYSICSPRESTEP (fixed-rate timestep) to, say, E_SCENESUBSYSTEMUPDATE (variable-rate timestep)? It not only decouples Detour crowd navigation from Physics subsystem but also makes crowd manager to update at the same (variable) rate as the DynamicNavigationMesh component. If there is no objection then I will include this change in my next commit which mainly consists of minor code cleanup due to code convention.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>OK. I will include that change in my next commit. About the agent being “locked”, yes, I am observing that too. The locked agent can be produced in the manner you just mentioned and also when spawning too many Jacks on a same tight spot (i.e. when it is spawned on top of another or on top a cube).</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">cadaver</div>
          <div class="post_content">
<p>Ah yes, moving away from FixedUpdate is good for at least two additional reasons:</p>
<ol>
<li>No spiral-of-death if navigation would suddenly take a lot of time</li>
<li>Physics interpolates transforms, while applying the navigation positions doesn’t, so it will look smoother</li>
</ol>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>One more other minor thing. There is inconsistency (at least to me) in naming the member variable/method for “area type/id” in different classes. I think we should either stick to “area id” following the internal implementation of DetourCrowd or stick to “area type” through out Urho3D API.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>I find ‘id’ more intuitive than ‘type’, for which I was mistakenly expecting an enum.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<aside class="quote">
<div class="title">
<div class="quote-controls"></div>
 Sinoid:</div>
<blockquote>
<p>Was the cube case you saw in the angelscript example? For some dumb reason I set the spawned Jacks’ Y position to 0 instead of using the exact point from the nav mesh. That causes the agents to be hidden inside the boxes, the other examples don’t appear to suffer this (at least from a quick look).</p>
</blockquote>
</aside>
<p>I believe I encountered this on native version. I think it has something to do with the cube size (or more precisely its height). On a taller cube the agent behaves normally, although Jack does not know how to climb down <img alt=":slight_smile:" class="emoji" src="../../../images2/ab33f6c546ca85e7d84a4e3c32cd4034.png" title=":slight_smile:"/>, it is not locked in place. On a shorter cube, however, the agent is locked. I think it has something to do with the nav mesh itself. It appears that any agents spawned in between the floor and a certain height-threshold is locked.</p>
<p>[quote=“Sinoid”]Because the agent’s state could become invalid (and therefore frozen) in different ways (a very large obstacle was placed right on top of it, it was knocked far off the navmesh, etc) it’s probably best to leave the handling of that to the user.</p>
<p>The next viable option for simple cases would be to allow for a “correction margin” in which the agent would snap to the nearest point on the navmesh if within the range of the margin - though you could accomplish the same thing according to specific needs by handling the event.[/quote]<br/>
I am totally agree with you that it would be best to leave the handling of such case to the user (app-specific). For a Lemmings-type game, one would probably just kills the agent. It would be great if we have a unique event type for this situation or we have an indicator flag for this somewhere. We can then demonstrate how to handle such event in the simplest case as you mentioned above in the sample just as an example.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Does anybody successfully tested off-mesh connections?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Thanks Sinoid, I’ve tried from code to jump from one box to another and failed. I’ll try to replicate your experiment.<br/>
In my experiment I’ve created OffMeshConnection before building, after looking at NavigationMesh.cpp code.</p>
<p>Just to be sure, what are your ‘start’ node (holding the component) and your end node? Does radius matter?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Ah! It didn’t hook (white debug geometry). I’ll test this immediately! Many thanks for these insights Sinoid  <img alt=":stuck_out_tongue:" class="emoji" src="../../../images2/31a2303e479834609bf5befdf8c3501a.png" title=":stuck_out_tongue:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Finally I used FindNearestPoint() to set my nodes’ position and it works perfectly  <img alt=":stuck_out_tongue:" class="emoji" src="../../../images2/31a2303e479834609bf5befdf8c3501a.png" title=":stuck_out_tongue:"/><br/>
Thanks again for your detailed great insights.</p>
<p><span class="mention">@Cadaver</span>, maybe we could add this to the samples (15 and/or 39), it only costs a few lines of code to create 2 nodes  <img alt=":unamused:" class="emoji" src="../../../images2/21382c100a852239caa7667da5bafe68.png" title=":unamused:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">cadaver</div>
          <div class="post_content">
<p>Yes, feel free to add.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Great, thanks.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>I’ve added off-mesh connections to sample 39. Overall it works great, but sometimes it fails:</p>
<ul>
<li>although hooking correctly, a few boxes are still non climbable</li>
<li>after climbing on the tallest box, agent can’t go down</li>
</ul>
<p>I also noticed that when removing a moving agent, its target path remains (in debug draw) when creating a new agent. Maybe some agent data needs to be cleared when removing an agent.</p>
<p>[spoiler][code]<br/>
– CrowdNavigation example.<br/>
– This sample demonstrates:<br/>
–     - Generating a dynamic navigation mesh into the scene<br/>
–     - Performing path queries to the navigation mesh<br/>
–     - Adding and removing obstacles at runtime from the dynamic mesh<br/>
–     - Adding and removing crowd agents at runtime<br/>
–     - Raycasting drawable components<br/>
–     - Crowd movement management<br/>
–     - Accessing crowd agents with the crowd manager<br/>
–     - Using off-mesh connections to make boxes climbable</p>
<p>require “LuaScripts/Utilities/Sample”</p>
<p>local crowdManager = nil<br/>
local agents = {}</p>
<p>function Start()<br/>
– Execute the common startup for samples<br/>
SampleStart()</p>
<pre><code>-- Create the scene content
CreateScene()

-- Create the UI content
CreateUI()

-- Setup the viewport for displaying the scene
SetupViewport()

-- Hook up to the frame update and render post-update events
SubscribeToEvents()
</code></pre>
<p>end</p>
<p>function CreateScene()<br/>
scene_ = Scene()<br/>
– Create octree, use default volume (-1000, -1000, -1000) to (1000, 1000, 1000)<br/>
– Also create a DebugRenderer component so that we can draw debug geometry<br/>
scene_:CreateComponent(“Octree”)<br/>
scene_:CreateComponent(“DebugRenderer”)</p>
<pre><code>-- Create scene node &amp; StaticModel component for showing a static plane
local planeNode = scene_:CreateChild("Plane")
planeNode.scale = Vector3(100.0, 1.0, 100.0)
local planeObject = planeNode:CreateComponent("StaticModel")
planeObject.model = cache:GetResource("Model", "Models/Plane.mdl")
planeObject.material = cache:GetResource("Material", "Materials/StoneTiled.xml")

-- Create a Zone component for ambient lighting &amp; fog control
local zoneNode = scene_:CreateChild("Zone")
local zone = zoneNode:CreateComponent("Zone")
zone.boundingBox = BoundingBox(-1000.0, 1000.0)
zone.ambientColor = Color(0.15, 0.15, 0.15)
zone.fogColor = Color(0.5, 0.5, 0.7)
zone.fogStart = 100.0
zone.fogEnd = 300.0

-- Create a directional light to the world. Enable cascaded shadows on it
local lightNode = scene_:CreateChild("DirectionalLight")
lightNode.direction = Vector3(0.6, -1.0, 0.8)
local light = lightNode:CreateComponent("Light")
light.lightType = LIGHT_DIRECTIONAL
light.castShadows = true
light.shadowBias = BiasParameters(0.00025, 0.5)
-- Set cascade splits at 10, 50 and 200 world units, fade shadows out at 80% of maximum shadow distance
light.shadowCascade = CascadeParameters(10.0, 50.0, 200.0, 0.0, 0.8)

-- Create randomly sized boxes. If boxes are big enough, make them occluders. Occluders will be software rasterized before
-- rendering to a low-resolution depth-only buffer to test the objects in the view frustum for visibility
local boxes = {}
for i = 1, 20 do
    local boxNode = scene_:CreateChild("Box")
    local size = 1.0 + Random(10.0)
    boxNode.position = Vector3(Random(80.0) - 40.0, size * 0.5, Random(80.0) - 40.0)
    boxNode:SetScale(size)
    local boxObject = boxNode:CreateComponent("StaticModel")
    boxObject.model = cache:GetResource("Model", "Models/Box.mdl")
    boxObject.material = cache:GetResource("Material", "Materials/Stone.xml")
    boxObject.castShadows = true
    if size &gt;= 3.0 then
        boxObject.occluder = true
        table.insert(boxes, boxNode)
    end
end

-- Create a DynamicNavigationMesh component to the scene root
local navMesh = scene_:CreateComponent("DynamicNavigationMesh")
-- Enable drawing debug geometry for obstacles and off-mesh connections
navMesh.drawObstacles = true
</code></pre>
<p>–    navMesh.drawOffMeshConnections = true<br/>
– Set the agent height large enough to exclude the layers under boxes<br/>
navMesh.agentHeight = 10<br/>
– Set nav mesh tilesize to something reasonable<br/>
navMesh.tileSize = 64<br/>
– Set nav mesh cell height to minimum (allows agents to be grounded)<br/>
navMesh.cellHeight = 0.05<br/>
– Create a Navigable component to the scene root. This tags all of the geometry in the scene as being part of the<br/>
– navigation mesh. By default this is recursive, but the recursion could be turned off from Navigable<br/>
scene_:CreateComponent(“Navigable”)<br/>
– Add padding to the navigation mesh in Y-direction so that we can add objects on top of the tallest boxes<br/>
– in the scene and still update the mesh correctly<br/>
navMesh.padding = Vector3(0.0, 10.0, 0.0)<br/>
– Now build the navigation geometry. This will take some time. Note that the navigation mesh will prefer to use<br/>
– physics geometry from the scene nodes, as it often is simpler, but if it can not find any (like in this example)<br/>
– it will use renderable geometry instead<br/>
navMesh:Build()</p>
<pre><code>-- Create an OffMeshConnection for each box to make it climbable (tiny boxes are skipped)
for i, box in ipairs(boxes) do
    local boxPos = box.position
    local connectionStart = scene_:CreateChild("Connection1")
    connectionStart.position = navMesh:FindNearestPoint(boxPos + Vector3(box.scale.x / 2, -box.scale.y / 2, 0), Vector3.ONE) -- Base of box
    local connectionEnd = connectionStart:CreateChild("Connection2")
    connectionEnd.worldPosition = navMesh:FindNearestPoint(boxPos + Vector3(box.scale.x / 2, box.scale.y / 2, 0), Vector3.ONE) -- Top of box

    local connection = connectionStart:CreateComponent("OffMeshConnection")
    connection.endPoint = connectionEnd
end

-- Create a DetourCrowdManager component to the scene root
crowdManager = scene_:CreateComponent("DetourCrowdManager")

-- Create Jack node as crowd agent
SpawnJack(Vector3(-5, 0, 20))

-- Create some mushrooms as obstacles. Note that obstacles are added onto an already buit navigation mesh
for i = 1, 100 do
    CreateMushroom(Vector3(Random(90.0) - 45.0, 0.0, Random(90.0) - 45.0))
end

-- Create the camera. Limit far clip distance to match the fog. Note: now we actually create the camera node outside
-- the scene, because we want it to be unaffected by scene load / save
cameraNode = Node()
local camera = cameraNode:CreateComponent("Camera")
camera.farClip = 300.0

-- Set an initial position for the camera scene node above the plane
cameraNode.position = Vector3(0.0, 5.0, 0.0)
</code></pre>
<p>end</p>
<p>function CreateUI()<br/>
– Create a Cursor UI element because we want to be able to hide and show it at will. When hidden, the mouse cursor will<br/>
– control the camera, and when visible, it will point the raycast target<br/>
local style = cache:GetResource(“XMLFile”, “UI/DefaultStyle.xml”)<br/>
local cursor = Cursor:new()<br/>
cursor:SetStyleAuto(style)<br/>
ui.cursor = cursor<br/>
– Set starting position of the cursor at the rendering window center<br/>
cursor:SetPosition(graphics.width / 2, graphics.height / 2)</p>
<pre><code>-- Construct new Text object, set string to display and font to use
local instructionText = ui.root:CreateChild("Text")
instructionText.text = "Use WASD keys to move, RMB to rotate view\n"..
    "LMB to set destination, SHIFT+LMB to spawn a Jack\n"..
    "MMB to add obstacles or remove obstacles/agents\n"..
    "F5 to save scene, F7 to load\n"..
    "Space to toggle debug geometry"
instructionText:SetFont(cache:GetResource("Font", "Fonts/Anonymous Pro.ttf"), 15)
-- The text has multiple rows. Center them in relation to each other
instructionText.textAlignment = HA_CENTER

-- Position the text relative to the screen center
instructionText.horizontalAlignment = HA_CENTER
instructionText.verticalAlignment = VA_CENTER
instructionText:SetPosition(0, ui.root.height / 4)
</code></pre>
<p>end</p>
<p>function SetupViewport()<br/>
– Set up a viewport to the Renderer subsystem so that the 3D scene can be seen<br/>
local viewport = Viewport:new(scene_, cameraNode:GetComponent(“Camera”))<br/>
renderer:SetViewport(0, viewport)<br/>
end</p>
<p>function SubscribeToEvents()<br/>
– Subscribe HandleUpdate() function for processing update events<br/>
SubscribeToEvent(“Update”, “HandleUpdate”)</p>
<pre><code>-- Subscribe HandlePostRenderUpdate() function for processing the post-render update event, during which we request
-- debug geometry
SubscribeToEvent("PostRenderUpdate", "HandlePostRenderUpdate")

-- Subscribe HandleCrowdAgentFailure() function for resolving invalidation issues with agents, during which we
-- use a larger extents for finding a point on the navmesh to fix the agent's position
SubscribeToEvent("CrowdAgentFailure", "HandleCrowdAgentFailure")
</code></pre>
<p>end</p>
<p>function SpawnJack(pos)<br/>
local jackNode = scene_:CreateChild(“Jack”)<br/>
jackNode.position = pos<br/>
local modelObject = jackNode:CreateComponent(“AnimatedModel”)<br/>
modelObject.model = cache:GetResource(“Model”, “Models/Jack.mdl”)<br/>
modelObject.material = cache:GetResource(“Material”, “Materials/Jack.xml”)<br/>
modelObject.castShadows = true</p>
<pre><code>-- Create a CrowdAgent component and set its height (use default radius)
local agent = jackNode:CreateComponent("CrowdAgent")
agent.height = 2.0
agents = crowdManager:GetActiveAgents() -- Update agents container
</code></pre>
<p>end</p>
<p>function CreateMushroom(pos)<br/>
local mushroomNode = scene_:CreateChild(“Mushroom”)<br/>
mushroomNode.position = pos<br/>
mushroomNode.rotation = Quaternion(0.0, Random(360.0), 0.0)<br/>
mushroomNode:SetScale(2.0 + Random(0.5))<br/>
local mushroomObject = mushroomNode:CreateComponent(“StaticModel”)<br/>
mushroomObject.model = cache:GetResource(“Model”, “Models/Mushroom.mdl”)<br/>
mushroomObject.material = cache:GetResource(“Material”, “Materials/Mushroom.xml”)<br/>
mushroomObject.castShadows = true</p>
<pre><code>-- Create the navigation Obstacle component and set its height &amp; radius proportional to scale
local obstacle = mushroomNode:CreateComponent("Obstacle")
obstacle.radius = mushroomNode.scale.x
obstacle.height = mushroomNode.scale.y
return mushroomNode
</code></pre>
<p>end</p>
<p>function SetPathPoint()<br/>
local hitPos, hitDrawable = Raycast(250.0)<br/>
local navMesh = scene_:GetComponent(“DynamicNavigationMesh”)</p>
<pre><code>if hitDrawable then
    local pathPos = navMesh:FindNearestPoint(hitPos, Vector3.ONE)

    if input:GetQualifierDown(QUAL_SHIFT) then
        -- Spawn a Jack
        SpawnJack(pathPos)
    else
        -- Set target position and ignit agents' move
        for i = 1, table.maxn(agents) do
            local agent = agents[i]

            if i == 1 then
                -- The first agent will always move to the exact position
                agent:SetMoveTarget(pathPos)
            else
                -- Other agents will move to a random point nearby
                local targetPos = navMesh:FindNearestPoint(pathPos + Vector3(Random(-4.5, 4.5), 0, Random(-4.5, 4.5)), Vector3.ONE)
                agent:SetMoveTarget(targetPos)
            end
        end
    end
end
</code></pre>
<p>end</p>
<p>function AddOrRemoveObject()<br/>
– Raycast and check if we hit a mushroom node. If yes, remove it, if no, create a new one<br/>
local hitPos, hitDrawable = Raycast(250.0)<br/>
if hitDrawable then</p>
<pre><code>    local hitNode = hitDrawable.node
    if hitNode.name == "Mushroom" then
        hitNode:Remove()
    elseif hitNode.name == "Jack" then
        hitNode:Remove()
        agents = crowdManager:GetActiveAgents() -- Update agents container
    else
        CreateMushroom(hitPos)
    end
end
</code></pre>
<p>end</p>
<p>function Raycast(maxDistance)<br/>
local hitPos = nil<br/>
local hitDrawable = nil</p>
<pre><code>local pos = ui.cursorPosition
-- Check the cursor is visible and there is no UI element in front of the cursor
if (not ui.cursor.visible) or (ui:GetElementAt(pos, true) ~= nil) then
    return nil, nil
end

local camera = cameraNode:GetComponent("Camera")
local cameraRay = camera:GetScreenRay(pos.x / graphics.width, pos.y / graphics.height)
-- Pick only geometry objects, not eg. zones or lights, only get the first (closest) hit
local octree = scene_:GetComponent("Octree")
local result = octree:RaycastSingle(cameraRay, RAY_TRIANGLE, maxDistance, DRAWABLE_GEOMETRY)
if result.drawable ~= nil then
    return result.position, result.drawable
end

return nil, nil
</code></pre>
<p>end</p>
<p>function MoveCamera(timeStep)<br/>
– Right mouse button controls mouse cursor visibility: hide when pressed<br/>
ui.cursor.visible = not input:GetMouseButtonDown(MOUSEB_RIGHT)</p>
<pre><code>-- Do not move if the UI has a focused element (the console)
if ui.focusElement ~= nil then
    return
end

-- Movement speed as world units per second
local MOVE_SPEED = 20.0
-- Mouse sensitivity as degrees per pixel
local MOUSE_SENSITIVITY = 0.1

-- Use this frame's mouse motion to adjust camera node yaw and pitch. Clamp the pitch between -90 and 90 degrees
-- Only move the camera when the cursor is hidden
if not ui.cursor.visible then
    local mouseMove = input.mouseMove
    yaw = yaw + MOUSE_SENSITIVITY * mouseMove.x
    pitch = pitch + MOUSE_SENSITIVITY * mouseMove.y
    pitch = Clamp(pitch, -90.0, 90.0)

    -- Construct new orientation for the camera scene node from yaw and pitch. Roll is fixed to zero
    cameraNode.rotation = Quaternion(pitch, yaw, 0.0)
end

-- Read WASD keys and move the camera scene node to the corresponding direction if they are pressed
if input:GetKeyDown(KEY_W) then
    cameraNode:Translate(Vector3(0.0, 0.0, 1.0) * MOVE_SPEED * timeStep)
end
if input:GetKeyDown(KEY_S) then
    cameraNode:Translate(Vector3(0.0, 0.0, -1.0) * MOVE_SPEED * timeStep)
end
if input:GetKeyDown(KEY_A) then
    cameraNode:Translate(Vector3(-1.0, 0.0, 0.0) * MOVE_SPEED * timeStep)
end
if input:GetKeyDown(KEY_D) then
    cameraNode:Translate(Vector3(1.0, 0.0, 0.0) * MOVE_SPEED * timeStep)
end
-- Set destination or spawn a jack with left mouse button
if input:GetMouseButtonPress(MOUSEB_LEFT) then
    SetPathPoint()
end
-- Add new obstacle or remove existing obstacle/agent with middle mouse button
if input:GetMouseButtonPress(MOUSEB_MIDDLE) then
    AddOrRemoveObject()
end

-- Toggle debug geometry with space
if input:GetKeyPress(KEY_SPACE) then
    drawDebug = not drawDebug
end

-- Check for loading/saving the scene from/to the file Data/Scenes/CrowdNavigation.xml relative to the executable directory
if input:GetKeyPress(KEY_F5) then
    scene_:SaveXML(fileSystem:GetProgramDir().."Data/Scenes/CrowdNavigation.xml")
end
if input:GetKeyPress(KEY_F7) then
    scene_:LoadXML(fileSystem:GetProgramDir().."Data/Scenes/CrowdNavigation.xml")

    -- After reload, reacquire crowd manager &amp; agents
    crowdManager = scene_:GetComponent("DetourCrowdManager")
    agents = crowdManager:GetActiveAgents()

    -- Re-enable debug draw for obstacles
    local navMesh = scene_:GetComponent("DynamicNavigationMesh")
    navMesh.drawObstacles = true
end
</code></pre>
<p>end</p>
<p>function HandleUpdate(eventType, eventData)<br/>
– Take the frame time step, which is stored as a float<br/>
local timeStep = eventData:GetFloat(“TimeStep”)</p>
<pre><code>-- Move the camera, scale movement with time step
MoveCamera(timeStep)

-- Make the CrowdAgents face the direction of their velocity
for i = 1, table.maxn(agents) do
    local agent = agents[i]
    agent.node.worldDirection = agent.actualVelocity
end
</code></pre>
<p>end</p>
<p>function HandlePostRenderUpdate(eventType, eventData)<br/>
– If draw debug mode is enabled, draw navigation debug geometry<br/>
if drawDebug then<br/>
– Visualize navigation mesh and obstacles<br/>
local navMesh = scene_:GetComponent(“DynamicNavigationMesh”)<br/>
navMesh:DrawDebugGeometry(true)</p>
<pre><code>    -- Visualize agents' path and position to reach
    crowdManager:DrawDebugGeometry(true)
end
</code></pre>
<p>end</p>
<p>function HandleCrowdAgentFailure(eventType, eventData)</p>
<pre><code>local node = eventData:GetPtr("Node", "Node")
local agent = eventData:GetPtr("CrowdAgent", "CrowdAgent")
local agentState = eventData:GetInt("CrowdAgentState")

-- If the agent's state is invalid, likely from spawning on the side of a box, find a point in a larger area
if agentState == CROWD_AGENT_INVALID then
    local navMesh = scene_:GetComponent("DynamicNavigationMesh")
    -- Get a point on the navmesh using more generous extents
    local newPos = navMesh:FindNearestPoint(node:GetWorldPosition(), Vector3(5, 5, 5))
    -- Set the new node position, CrowdAgent component will automatically reset the state of the agent
    node:SetWorldPosition(newPos)
end
</code></pre>
<p>end</p>
<p>– Create XML patch instructions for screen joystick layout specific to this sample app<br/>
function GetScreenJoystickPatchString()<br/>
return<br/>
"" …<br/>
"    &lt;add sel="/element"&gt;" …<br/>
"        &lt;element type=“Button”&gt;" …<br/>
"            &lt;attribute name=“Name” value=“Button3” /&gt;" …<br/>
"            &lt;attribute name=“Position” value="-120 -120" /&gt;" …<br/>
"            &lt;attribute name=“Size” value=“96 96” /&gt;" …<br/>
"            &lt;attribute name=“Horiz Alignment” value=“Right” /&gt;" …<br/>
"            &lt;attribute name=“Vert Alignment” value=“Bottom” /&gt;" …<br/>
"            &lt;attribute name=“Texture” value=“Texture2D;Textures/TouchInput.png” /&gt;" …<br/>
"            &lt;attribute name=“Image Rect” value=“96 0 192 96” /&gt;" …<br/>
"            &lt;attribute name=“Hover Image Offset” value=“0 0” /&gt;" …<br/>
"            &lt;attribute name=“Pressed Image Offset” value=“0 0” /&gt;" …<br/>
"            &lt;element type=“Text”&gt;" …<br/>
"                &lt;attribute name=“Name” value=“Label” /&gt;" …<br/>
"                &lt;attribute name=“Horiz Alignment” value=“Center” /&gt;" …<br/>
"                &lt;attribute name=“Vert Alignment” value=“Center” /&gt;" …<br/>
"                &lt;attribute name=“Color” value=“0 0 0 1” /&gt;" …<br/>
"                &lt;attribute name=“Text” value=“Spawn Jack” /&gt;" …<br/>
"            " …<br/>
"            &lt;element type=“Text”&gt;" …<br/>
"                &lt;attribute name=“Name” value=“KeyBinding” /&gt;" …<br/>
"                &lt;attribute name=“Text” value=“LSHIFT” /&gt;" …<br/>
"            " …<br/>
"            &lt;element type=“Text”&gt;" …<br/>
"                &lt;attribute name=“Name” value=“MouseButtonBinding” /&gt;" …<br/>
"                &lt;attribute name=“Text” value=“LEFT” /&gt;" …<br/>
"            " …<br/>
"        " …<br/>
"        &lt;element type=“Button”&gt;" …<br/>
"            &lt;attribute name=“Name” value=“Button4” /&gt;" …<br/>
"            &lt;attribute name=“Position” value="-120 -12" /&gt;" …<br/>
"            &lt;attribute name=“Size” value=“96 96” /&gt;" …<br/>
"            &lt;attribute name=“Horiz Alignment” value=“Right” /&gt;" …<br/>
"            &lt;attribute name=“Vert Alignment” value=“Bottom” /&gt;" …<br/>
"            &lt;attribute name=“Texture” value=“Texture2D;Textures/TouchInput.png” /&gt;" …<br/>
"            &lt;attribute name=“Image Rect” value=“96 0 192 96” /&gt;" …<br/>
"            &lt;attribute name=“Hover Image Offset” value=“0 0” /&gt;" …<br/>
"            &lt;attribute name=“Pressed Image Offset” value=“0 0” /&gt;" …<br/>
"            &lt;element type=“Text”&gt;" …<br/>
"                &lt;attribute name=“Name” value=“Label” /&gt;" …<br/>
"                &lt;attribute name=“Horiz Alignment” value=“Center” /&gt;" …<br/>
"                &lt;attribute name=“Vert Alignment” value=“Center” /&gt;" …<br/>
"                &lt;attribute name=“Color” value=“0 0 0 1” /&gt;" …<br/>
"                &lt;attribute name=“Text” value=“Obstacles” /&gt;" …<br/>
"            " …<br/>
"            &lt;element type=“Text”&gt;" …<br/>
"                &lt;attribute name=“Name” value=“MouseButtonBinding” /&gt;" …<br/>
"                &lt;attribute name=“Text” value=“MIDDLE” /&gt;" …<br/>
"            " …<br/>
"        " …<br/>
"    " …<br/>
"    &lt;remove sel="/element/element[./attribute[@name=‘Name’ and @value=‘Button0’]]/attribute[@name=‘Is Visible’]" /&gt;" …<br/>
"    &lt;replace sel="/element/element[./attribute[@name=‘Name’ and @value=‘Button0’]]/element[./attribute[@name=‘Name’ and @value=‘Label’]]/attribute[@name=‘Text’]/<span class="mention">@value</span>"&gt;Set" …<br/>
"    &lt;add sel="/element/element[./attribute[@name=‘Name’ and @value=‘Button0’]]"&gt;" …<br/>
"        &lt;element type=“Text”&gt;" …<br/>
"            &lt;attribute name=“Name” value=“MouseButtonBinding” /&gt;" …<br/>
"            &lt;attribute name=“Text” value=“LEFT” /&gt;" …<br/>
"        " …<br/>
"    " …<br/>
"    &lt;remove sel="/element/element[./attribute[@name=‘Name’ and @value=‘Button1’]]/attribute[@name=‘Is Visible’]" /&gt;" …<br/>
"    &lt;replace sel="/element/element[./attribute[@name=‘Name’ and @value=‘Button1’]]/element[./attribute[@name=‘Name’ and @value=‘Label’]]/attribute[@name=‘Text’]/<span class="mention">@value</span>"&gt;Debug" …<br/>
"    &lt;add sel="/element/element[./attribute[@name=‘Name’ and @value=‘Button1’]]"&gt;" …<br/>
"        &lt;element type=“Text”&gt;" …<br/>
"            &lt;attribute name=“Name” value=“KeyBinding” /&gt;" …<br/>
"            &lt;attribute name=“Text” value=“SPACE” /&gt;" …<br/>
"        " …<br/>
"    " …<br/>
""<br/>
end<br/>
[/code][/spoiler]</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Currently off-mesh connections can be added post-build with dynamic navMesh, but they must be added before building a static navMesh.<br/>
I have a preference for the post-build addition, as it allows using FindNearestPoint(). Maybe same behavior can be applied to static navMesh.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Thanks Sinoid.</p>
<aside class="quote">
<blockquote>
<p>It works in your Lua code there because the OffMeshConnections are added before Obstacles are added to the scene, which causes tiles to be rebuilt…if adding offmeshconnections at runtime (without changing obstacles) is reliable then there’s a bug</p>
</blockquote>
</aside>
<p>I’ve tried to add only a few Obstacles: OffMeshConnections get created only for tiles including an Obstacle, so it is effectively incidental here that OffMeshConnections get created post build (as there are lots of Obstacles, each tile has at least one and get rebuilt, incidentally hooking OffMeshConnections). Fortunately no potential bug here.</p>
<p>For the few boxes non climbable issue, it may be difficult to reproduce as using random positions, I assume the scene might be different from one computer to another. For example when running the AngelScript sample, I only see the texture of a box at start, as a box is created just in front of the camera.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Currently for moving obstacles in the scene I am removing the component and add it back. Is there a better way to achieve this?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Maybe we could simply create moving obstacles as agents with very low pushiness.<br/>
This way we don’t even need physics to push the obstacles.<br/>
I’ll try this today.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Works great  <img alt=":stuck_out_tongue:" class="emoji" src="../../../images2/31a2303e479834609bf5befdf8c3501a.png" title=":stuck_out_tongue:"/><br/>
To make an agent strong enough to push another agent, its pushiness must be set to ‘high’ (as long as other agents don’t also have high pushiness).<br/>
Here I’ve added 20 barrels that can be pushed only by the main agent.<br/>
And I also tested cloning agents.<br/>
EDIT: also added teleportation<br/>
EDIT2: also added AnimationController</p>
<p>[spoiler][code]<br/>
– CrowdNavigation example.<br/>
– This sample demonstrates:<br/>
–     - Generating a dynamic navigation mesh into the scene<br/>
–     - Performing path queries to the navigation mesh<br/>
–     - Adding and removing obstacles at runtime from the dynamic mesh<br/>
–     - Adding and removing crowd agents at runtime<br/>
–     - Raycasting drawable components<br/>
–     - Crowd movement management<br/>
–     - Accessing crowd agents with the crowd manager<br/>
–     - Using off-mesh connections to make boxes climbable<br/>
–     - Using agents to simulate pushing obstacles without using physics</p>
<p>require “LuaScripts/Utilities/Sample”</p>
<p>local crowdManager = nil<br/>
local agents = {}<br/>
local navMesh = nil</p>
<p>function Start()<br/>
– Execute the common startup for samples<br/>
SampleStart()</p>
<pre><code>-- Create the scene content
CreateScene()

-- Create the UI content
CreateUI()

-- Setup the viewport for displaying the scene
SetupViewport()

-- Hook up to the frame update and render post-update events
SubscribeToEvents()
</code></pre>
<p>end</p>
<p>function CreateScene()<br/>
scene_ = Scene()<br/>
– Create octree, use default volume (-1000, -1000, -1000) to (1000, 1000, 1000)<br/>
– Also create a DebugRenderer component so that we can draw debug geometry<br/>
scene_:CreateComponent(“Octree”)<br/>
scene_:CreateComponent(“DebugRenderer”)</p>
<pre><code>-- Create scene node &amp; StaticModel component for showing a static plane
local planeNode = scene_:CreateChild("Plane")
planeNode.scale = Vector3(100.0, 1.0, 100.0)
local planeObject = planeNode:CreateComponent("StaticModel")
planeObject.model = cache:GetResource("Model", "Models/Plane.mdl")
planeObject.material = cache:GetResource("Material", "Materials/StoneTiled.xml")

-- Create a Zone component for ambient lighting &amp; fog control
local zoneNode = scene_:CreateChild("Zone")
local zone = zoneNode:CreateComponent("Zone")
zone.boundingBox = BoundingBox(-1000.0, 1000.0)
zone.ambientColor = Color(0.15, 0.15, 0.15)
zone.fogColor = Color(0.5, 0.5, 0.7)
zone.fogStart = 100.0
zone.fogEnd = 300.0

-- Create a directional light to the world. Enable cascaded shadows on it
local lightNode = scene_:CreateChild("DirectionalLight")
lightNode.direction = Vector3(0.6, -1.0, 0.8)
local light = lightNode:CreateComponent("Light")
light.lightType = LIGHT_DIRECTIONAL
light.castShadows = true
light.shadowBias = BiasParameters(0.00025, 0.5)
-- Set cascade splits at 10, 50 and 200 world units, fade shadows out at 80% of maximum shadow distance
light.shadowCascade = CascadeParameters(10.0, 50.0, 200.0, 0.0, 0.8)

-- Create randomly sized boxes. If boxes are big enough, make them occluders. Occluders will be software rasterized before
-- rendering to a low-resolution depth-only buffer to test the objects in the view frustum for visibility
local boxes = {}
for i = 1, 20 do
    local boxNode = scene_:CreateChild("Box")
    local size = 1.0 + Random(10.0)
    boxNode.position = Vector3(Random(80.0) - 40.0, size * 0.5, Random(80.0) - 40.0)
    boxNode:SetScale(size)
    local boxObject = boxNode:CreateComponent("StaticModel")
    boxObject.model = cache:GetResource("Model", "Models/Box.mdl")
    boxObject.material = cache:GetResource("Material", "Materials/Stone.xml")
    boxObject.castShadows = true
    if size &gt;= 3.0 then
        boxObject.occluder = true
        table.insert(boxes, boxNode)
    end
end

-- Create a DynamicNavigationMesh component to the scene root
navMesh = scene_:CreateComponent("DynamicNavigationMesh")
-- Enable drawing debug geometry for obstacles and off-mesh connections
navMesh.drawObstacles = true
navMesh.drawOffMeshConnections = true
-- Set the agent height large enough to exclude the layers under boxes
navMesh.agentHeight = 10
-- Set nav mesh tilesize to something reasonable
navMesh.tileSize = 64
-- Set nav mesh cell height to minimum (allows agents to be grounded)
navMesh.cellHeight = 0.05
-- Create a Navigable component to the scene root. This tags all of the geometry in the scene as being part of the
-- navigation mesh. By default this is recursive, but the recursion could be turned off from Navigable
scene_:CreateComponent("Navigable")
-- Add padding to the navigation mesh in Y-direction so that we can add objects on top of the tallest boxes
-- in the scene and still update the mesh correctly
navMesh.padding = Vector3(0.0, 10.0, 0.0)
-- Now build the navigation geometry. This will take some time. Note that the navigation mesh will prefer to use
-- physics geometry from the scene nodes, as it often is simpler, but if it can not find any (like in this example)
-- it will use renderable geometry instead
navMesh:Build()

-- Create an off-mesh connection for each box to make it climbable (tiny boxes are skipped).
-- Note that OffMeshConnections must be added before building the navMesh, but as we are adding Obstacles next, tiles will be automatically rebuilt.
-- Creating connections post-build here allows us to use FindNearestPoint() to procedurally set accurate positions for the connection
CreateBoxOffMeshConnections(boxes)

-- Create a DetourCrowdManager component to the scene root
crowdManager = scene_:CreateComponent("DetourCrowdManager")

-- Create some mushrooms as obstacles. Note that obstacles are added onto an already buit navigation mesh
for i = 1, 100 do
    CreateMushroom(Vector3(Random(90.0) - 45.0, 0.0, Random(90.0) - 45.0))
end

-- Create some moving crates. We create them as crowd agents as for moving entities it is less expensive than using obstacles
CreateMovingBarrels()

-- Create Jack node as crowd agent
SpawnJack(Vector3(-5, 0, 20))

-- Create the camera. Limit far clip distance to match the fog. Note: now we actually create the camera node outside
-- the scene, because we want it to be unaffected by scene load / save
cameraNode = Node()
local camera = cameraNode:CreateComponent("Camera")
camera.farClip = 300.0

-- Set an initial position for the camera scene node above the plane
cameraNode.position = Vector3(0.0, 5.0, 0.0)
local nodes = scene_:GetChildrenWithComponent("CrowdAgent")
</code></pre>
<p>end</p>
<p>function CreateUI()<br/>
– Create a Cursor UI element because we want to be able to hide and show it at will. When hidden, the mouse cursor will<br/>
– control the camera, and when visible, it will point the raycast target<br/>
local style = cache:GetResource(“XMLFile”, “UI/DefaultStyle.xml”)<br/>
local cursor = Cursor:new()<br/>
cursor:SetStyleAuto(style)<br/>
ui.cursor = cursor<br/>
– Set starting position of the cursor at the rendering window center<br/>
cursor:SetPosition(graphics.width / 2, graphics.height / 2)</p>
<pre><code>-- Construct new Text object, set string to display and font to use
local instructionText = ui.root:CreateChild("Text")
instructionText.text = "Use WASD keys to move, RMB to rotate view\n"..
    "LMB to set destination, SHIFT+LMB to spawn a Jack, CTRL+LMB to teleport\n"..
    "MMB to add obstacles or remove obstacles/agents\n"..
    "F5 to save scene, F7 to load\n"..
    "Space to toggle debug geometry"
instructionText:SetFont(cache:GetResource("Font", "Fonts/Anonymous Pro.ttf"), 12)
-- The text has multiple rows. Center them in relation to each other
instructionText.textAlignment = HA_CENTER

-- Position the text relative to the screen center
instructionText.horizontalAlignment = HA_CENTER
instructionText.verticalAlignment = VA_CENTER
instructionText:SetPosition(0, ui.root.height / 4)
</code></pre>
<p>end</p>
<p>function SetupViewport()<br/>
– Set up a viewport to the Renderer subsystem so that the 3D scene can be seen<br/>
local viewport = Viewport:new(scene_, cameraNode:GetComponent(“Camera”))<br/>
renderer:SetViewport(0, viewport)<br/>
end</p>
<p>function SubscribeToEvents()<br/>
– Subscribe HandleUpdate() function for processing update events<br/>
SubscribeToEvent(“Update”, “HandleUpdate”)</p>
<pre><code>-- Subscribe HandlePostRenderUpdate() function for processing the post-render update event, during which we request
-- debug geometry
SubscribeToEvent("PostRenderUpdate", "HandlePostRenderUpdate")

-- Subscribe HandleCrowdAgentFailure() function for resolving invalidation issues with agents, during which we
-- use a larger extents for finding a point on the navmesh to fix the agent's position
SubscribeToEvent("CrowdAgentFailure", "HandleCrowdAgentFailure")
</code></pre>
<p>end</p>
<p>function SpawnJack(pos)<br/>
local jackNode = scene_:CreateChild(“Jack”)<br/>
jackNode.position = pos<br/>
local modelObject = jackNode:CreateComponent(“AnimatedModel”)<br/>
modelObject.model = cache:GetResource(“Model”, “Models/Jack.mdl”)<br/>
modelObject.material = cache:GetResource(“Material”, “Materials/Jack.xml”)<br/>
modelObject.castShadows = true<br/>
jackNode:CreateComponent(“AnimationController”)</p>
<pre><code>-- Create a CrowdAgent component and set its height (use default radius)
local agent = jackNode:CreateComponent("CrowdAgent")
agent.height = 2.0
agent.maxSpeed = 4
agent.maxAccel = 100
agents = crowdManager:GetActiveAgents() -- Update agents container
</code></pre>
<p>end</p>
<p>function CreateMushroom(pos)<br/>
local mushroomNode = scene_:CreateChild(“Mushroom”)<br/>
mushroomNode.position = navMesh:FindNearestPoint(pos)<br/>
mushroomNode.rotation = Quaternion(0.0, Random(360.0), 0.0)<br/>
mushroomNode:SetScale(2.0 + Random(0.5))<br/>
local mushroomObject = mushroomNode:CreateComponent(“StaticModel”)<br/>
mushroomObject.model = cache:GetResource(“Model”, “Models/Mushroom.mdl”)<br/>
mushroomObject.material = cache:GetResource(“Material”, “Materials/Mushroom.xml”)<br/>
mushroomObject.castShadows = true</p>
<pre><code>-- Create the navigation Obstacle component and set its height &amp; radius proportional to scale
local obstacle = mushroomNode:CreateComponent("Obstacle")
obstacle.radius = mushroomNode.scale.x
obstacle.height = mushroomNode.scale.y
return mushroomNode
</code></pre>
<p>end</p>
<p>function CreateBoxOffMeshConnections(boxes)<br/>
for i, box in ipairs(boxes) do<br/>
local boxPos = box.position<br/>
local boxHalfSize = box.scale.x / 2</p>
<pre><code>    -- Create 2 empty nodes for the start &amp; end points of the connection. Note that order matters only when using one-way/unidirectional connection.
    local connectionStart = scene_:CreateChild("ConnectionStart")
    connectionStart.position = navMesh:FindNearestPoint(boxPos + Vector3(boxHalfSize, -boxHalfSize, 0)) -- Base of box
    local connectionEnd = connectionStart:CreateChild("ConnectionEnd")
    connectionEnd.worldPosition = navMesh:FindNearestPoint(boxPos + Vector3(boxHalfSize, boxHalfSize, 0)) -- Top of box

    -- Create the OffMeshConnection component to one node and link the other node
    local connection = connectionStart:CreateComponent("OffMeshConnection")
    connection.endPoint = connectionEnd
end
</code></pre>
<p>end</p>
<p>function CreateMovingBarrels()<br/>
local barrel = scene_:CreateChild(“Barrel”)<br/>
local model = barrel:CreateComponent(“StaticModel”)<br/>
model.model = cache:GetResource(“Model”, “Models/Cylinder.mdl”)<br/>
model.material = cache:GetResource(“Material”, “Materials/StoneTiled.xml”)<br/>
model.material:SetTexture(0, cache:GetResource(“Texture2D”, “Textures/TerrainDetail2.dds”))<br/>
model.castShadows = true<br/>
barrel:CreateComponent(“CrowdAgent”)<br/>
for i = 1, 20 do<br/>
local clone = barrel:Clone()<br/>
local size = 0.5 + Random(1)<br/>
clone.scale = Vector3(size/1.5, size*2, size/1.5)<br/>
clone.position = navMesh:FindNearestPoint(Vector3(Random(80.0) - 40.0, size * 0.5 , Random(80.0) - 40.0))<br/>
local agent = clone:GetComponent(“CrowdAgent”)<br/>
agent.radius = clone.scale.x * 0.5<br/>
agent.height = size<br/>
end<br/>
barrel:Remove()<br/>
end</p>
<p>function SetPathPoint()<br/>
local hitPos, hitDrawable = Raycast(250.0)<br/>
local navMesh = scene_:GetComponent(“DynamicNavigationMesh”)</p>
<pre><code>if hitDrawable then
    local pathPos = navMesh:FindNearestPoint(hitPos, Vector3.ONE)

    if input:GetQualifierDown(QUAL_SHIFT) then
        -- Spawn a Jack
        SpawnJack(pathPos)

    elseif input:GetQualifierDown(QUAL_CTRL) then
        -- Teleport
        local agent = agents[table.maxn(agents)] -- Get last agent
        if agent.node.name == "Barrel" then return end
        local node = agent.node
        node:LookAt(pathPos) -- Face target
        agent:SetMoveVelocity(Vector3.ZERO) -- Stop agent
        node.position = pathPos
        return

    else
        -- Set target position and init agents' move
        for i, agent in ipairs(agents) do
            if agent.node.name == "Jack" then
                if i == table.maxn(agents) then
                    -- The last agent will always move to the exact position and is strong enough to push barrels and his siblings
                    agent.navigationPushiness = PUSHINESS_HIGH
                    agent:SetMoveTarget(pathPos)
                else
                    -- Other agents will move to a random point nearby
                    local targetPos = navMesh:FindNearestPoint(pathPos + Vector3(Random(-4.5, 4.5), 0, Random(-4.5, 4.5)), Vector3.ONE)
                    agent:SetMoveTarget(targetPos)
                end
            end
        end
    end
end
</code></pre>
<p>end</p>
<p>function AddOrRemoveObject()<br/>
– Raycast and check if we hit a mushroom node. If yes, remove it, if no, create a new one<br/>
local hitPos, hitDrawable = Raycast(250.0)<br/>
if hitDrawable then</p>
<pre><code>    local hitNode = hitDrawable.node
    if hitNode.name == "Mushroom" then
        hitNode:Remove()
    elseif hitNode.name == "Jack" then
        hitNode:Remove()
        agents = crowdManager:GetActiveAgents() -- Update agents container
    else
        CreateMushroom(hitPos)
    end
end
</code></pre>
<p>end</p>
<p>function Raycast(maxDistance)<br/>
local pos = ui.cursorPosition<br/>
– Check the cursor is visible and there is no UI element in front of the cursor<br/>
if (not ui.cursor.visible) or (ui:GetElementAt(pos, true) ~= nil) then<br/>
return nil, nil<br/>
end</p>
<pre><code>local camera = cameraNode:GetComponent("Camera")
local cameraRay = camera:GetScreenRay(pos.x / graphics.width, pos.y / graphics.height)
-- Pick only geometry objects, not eg. zones or lights, only get the first (closest) hit
local octree = scene_:GetComponent("Octree")
local result = octree:RaycastSingle(cameraRay, RAY_TRIANGLE, maxDistance, DRAWABLE_GEOMETRY)
if result.drawable ~= nil then
    return result.position, result.drawable
end

return nil, nil
</code></pre>
<p>end</p>
<p>function MoveCamera(timeStep)<br/>
– Right mouse button controls mouse cursor visibility: hide when pressed<br/>
ui.cursor.visible = not input:GetMouseButtonDown(MOUSEB_RIGHT)</p>
<pre><code>-- Do not move if the UI has a focused element (the console)
if ui.focusElement ~= nil then
    return
end

-- Movement speed as world units per second
local MOVE_SPEED = 20.0
-- Mouse sensitivity as degrees per pixel
local MOUSE_SENSITIVITY = 0.1

-- Use this frame's mouse motion to adjust camera node yaw and pitch. Clamp the pitch between -90 and 90 degrees
-- Only move the camera when the cursor is hidden
if not ui.cursor.visible then
    local mouseMove = input.mouseMove
    yaw = yaw + MOUSE_SENSITIVITY * mouseMove.x
    pitch = pitch + MOUSE_SENSITIVITY * mouseMove.y
    pitch = Clamp(pitch, -90.0, 90.0)

    -- Construct new orientation for the camera scene node from yaw and pitch. Roll is fixed to zero
    cameraNode.rotation = Quaternion(pitch, yaw, 0.0)
end

-- Read WASD keys and move the camera scene node to the corresponding direction if they are pressed
if input:GetKeyDown(KEY_W) then
    cameraNode:Translate(Vector3(0.0, 0.0, 1.0) * MOVE_SPEED * timeStep)
end
if input:GetKeyDown(KEY_S) then
    cameraNode:Translate(Vector3(0.0, 0.0, -1.0) * MOVE_SPEED * timeStep)
end
if input:GetKeyDown(KEY_A) then
    cameraNode:Translate(Vector3(-1.0, 0.0, 0.0) * MOVE_SPEED * timeStep)
end
if input:GetKeyDown(KEY_D) then
    cameraNode:Translate(Vector3(1.0, 0.0, 0.0) * MOVE_SPEED * timeStep)
end
-- Set destination or spawn a jack with left mouse button
if input:GetMouseButtonPress(MOUSEB_LEFT) then
    SetPathPoint()
end
-- Add new obstacle or remove existing obstacle/agent with middle mouse button
if input:GetMouseButtonPress(MOUSEB_MIDDLE) then
    AddOrRemoveObject()
end

-- Toggle debug geometry with space
if input:GetKeyPress(KEY_SPACE) then
    drawDebug = not drawDebug
end

-- Check for loading/saving the scene from/to the file Data/Scenes/CrowdNavigation.xml relative to the executable directory
if input:GetKeyPress(KEY_F5) then
    scene_:SaveXML(fileSystem:GetProgramDir().."Data/Scenes/CrowdNavigation.xml")
end
if input:GetKeyPress(KEY_F7) then
    scene_:LoadXML(fileSystem:GetProgramDir().."Data/Scenes/CrowdNavigation.xml")
    -- After reload, reacquire crowd manager &amp; agents
    crowdManager = scene_:GetComponent("DetourCrowdManager")
    agents = crowdManager:GetActiveAgents()
end
</code></pre>
<p>end</p>
<p>function HandleUpdate(eventType, eventData)<br/>
– Take the frame time step, which is stored as a float<br/>
local timeStep = eventData:GetFloat(“TimeStep”)</p>
<pre><code>-- Move the camera, scale movement with time step
MoveCamera(timeStep)

-- Make the CrowdAgents face the direction of their velocity and play animation
for i, agent in ipairs(agents) do
    local node = agent.node
    if node.name == "Jack" then
        local animCtrl = node:GetComponent("AnimationController")
        local velocity = agent.actualVelocity
        if velocity:Length() &lt; 0.6 then
            animCtrl:Stop("Models/Jack_Walk.ani", 0.2)
        else
            node.worldDirection = velocity
            animCtrl:PlayExclusive("Models/Jack_Walk.ani", 0, true, 0.2)
            animCtrl:SetSpeed("Models/Jack_Walk.ani", velocity:Length() * 0.3)
        end
    end
end
</code></pre>
<p>end</p>
<p>function HandlePostRenderUpdate(eventType, eventData)<br/>
if drawDebug then<br/>
– Visualize navigation mesh, obstacles and off-mesh connections<br/>
navMesh:DrawDebugGeometry(true)<br/>
– Visualize agents’ path and position to reach<br/>
crowdManager:DrawDebugGeometry(true)<br/>
end<br/>
end</p>
<p>function HandleCrowdAgentFailure(eventType, eventData)<br/>
local node = eventData:GetPtr(“Node”, “Node”)<br/>
local agent = eventData:GetPtr(“CrowdAgent”, “CrowdAgent”)<br/>
local agentState = eventData:GetInt(“CrowdAgentState”)</p>
<pre><code>-- If the agent's state is invalid, likely from spawning on the side of a box, find a point in a larger area
if agentState == CROWD_AGENT_INVALID then
    -- Get a point on the navmesh using more generous extents
    local newPos = navMesh:FindNearestPoint(node.worldPosition, Vector3(5, 5, 5))
    -- Set the new node position, CrowdAgent component will automatically reset the state of the agent
    node:SetWorldPosition(newPos)
end
</code></pre>
<p>end</p>
<p>– Create XML patch instructions for screen joystick layout specific to this sample app<br/>
function GetScreenJoystickPatchString()<br/>
return<br/>
"" …<br/>
"    &lt;add sel="/element"&gt;" …<br/>
"        &lt;element type=“Button”&gt;" …<br/>
"            &lt;attribute name=“Name” value=“Button3” /&gt;" …<br/>
"            &lt;attribute name=“Position” value="-120 -120" /&gt;" …<br/>
"            &lt;attribute name=“Size” value=“96 96” /&gt;" …<br/>
"            &lt;attribute name=“Horiz Alignment” value=“Right” /&gt;" …<br/>
"            &lt;attribute name=“Vert Alignment” value=“Bottom” /&gt;" …<br/>
"            &lt;attribute name=“Texture” value=“Texture2D;Textures/TouchInput.png” /&gt;" …<br/>
"            &lt;attribute name=“Image Rect” value=“96 0 192 96” /&gt;" …<br/>
"            &lt;attribute name=“Hover Image Offset” value=“0 0” /&gt;" …<br/>
"            &lt;attribute name=“Pressed Image Offset” value=“0 0” /&gt;" …<br/>
"            &lt;element type=“Text”&gt;" …<br/>
"                &lt;attribute name=“Name” value=“Label” /&gt;" …<br/>
"                &lt;attribute name=“Horiz Alignment” value=“Center” /&gt;" …<br/>
"                &lt;attribute name=“Vert Alignment” value=“Center” /&gt;" …<br/>
"                &lt;attribute name=“Color” value=“0 0 0 1” /&gt;" …<br/>
"                &lt;attribute name=“Text” value=“Spawn Jack” /&gt;" …<br/>
"            " …<br/>
"            &lt;element type=“Text”&gt;" …<br/>
"                &lt;attribute name=“Name” value=“KeyBinding” /&gt;" …<br/>
"                &lt;attribute name=“Text” value=“LSHIFT” /&gt;" …<br/>
"            " …<br/>
"            &lt;element type=“Text”&gt;" …<br/>
"                &lt;attribute name=“Name” value=“MouseButtonBinding” /&gt;" …<br/>
"                &lt;attribute name=“Text” value=“LEFT” /&gt;" …<br/>
"            " …<br/>
"        " …<br/>
"        &lt;element type=“Button”&gt;" …<br/>
"            &lt;attribute name=“Name” value=“Button4” /&gt;" …<br/>
"            &lt;attribute name=“Position” value="-120 -12" /&gt;" …<br/>
"            &lt;attribute name=“Size” value=“96 96” /&gt;" …<br/>
"            &lt;attribute name=“Horiz Alignment” value=“Right” /&gt;" …<br/>
"            &lt;attribute name=“Vert Alignment” value=“Bottom” /&gt;" …<br/>
"            &lt;attribute name=“Texture” value=“Texture2D;Textures/TouchInput.png” /&gt;" …<br/>
"            &lt;attribute name=“Image Rect” value=“96 0 192 96” /&gt;" …<br/>
"            &lt;attribute name=“Hover Image Offset” value=“0 0” /&gt;" …<br/>
"            &lt;attribute name=“Pressed Image Offset” value=“0 0” /&gt;" …<br/>
"            &lt;element type=“Text”&gt;" …<br/>
"                &lt;attribute name=“Name” value=“Label” /&gt;" …<br/>
"                &lt;attribute name=“Horiz Alignment” value=“Center” /&gt;" …<br/>
"                &lt;attribute name=“Vert Alignment” value=“Center” /&gt;" …<br/>
"                &lt;attribute name=“Color” value=“0 0 0 1” /&gt;" …<br/>
"                &lt;attribute name=“Text” value=“Obstacles” /&gt;" …<br/>
"            " …<br/>
"            &lt;element type=“Text”&gt;" …<br/>
"                &lt;attribute name=“Name” value=“MouseButtonBinding” /&gt;" …<br/>
"                &lt;attribute name=“Text” value=“MIDDLE” /&gt;" …<br/>
"            " …<br/>
"        " …<br/>
"    " …<br/>
"    &lt;remove sel="/element/element[./attribute[@name=‘Name’ and @value=‘Button0’]]/attribute[@name=‘Is Visible’]" /&gt;" …<br/>
"    &lt;replace sel="/element/element[./attribute[@name=‘Name’ and @value=‘Button0’]]/element[./attribute[@name=‘Name’ and @value=‘Label’]]/attribute[@name=‘Text’]/<span class="mention">@value</span>"&gt;Set" …<br/>
"    &lt;add sel="/element/element[./attribute[@name=‘Name’ and @value=‘Button0’]]"&gt;" …<br/>
"        &lt;element type=“Text”&gt;" …<br/>
"            &lt;attribute name=“Name” value=“MouseButtonBinding” /&gt;" …<br/>
"            &lt;attribute name=“Text” value=“LEFT” /&gt;" …<br/>
"        " …<br/>
"    " …<br/>
"    &lt;remove sel="/element/element[./attribute[@name=‘Name’ and @value=‘Button1’]]/attribute[@name=‘Is Visible’]" /&gt;" …<br/>
"    &lt;replace sel="/element/element[./attribute[@name=‘Name’ and @value=‘Button1’]]/element[./attribute[@name=‘Name’ and @value=‘Label’]]/attribute[@name=‘Text’]/<span class="mention">@value</span>"&gt;Debug" …<br/>
"    &lt;add sel="/element/element[./attribute[@name=‘Name’ and @value=‘Button1’]]"&gt;" …<br/>
"        &lt;element type=“Text”&gt;" …<br/>
"            &lt;attribute name=“Name” value=“KeyBinding” /&gt;" …<br/>
"            &lt;attribute name=“Text” value=“SPACE” /&gt;" …<br/>
"        " …<br/>
"    " …<br/>
""<br/>
end</p>
<p>[/code][/spoiler]</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Thanks Sinoid, I’ve just read your discussion with Mikko. I wasn’t aware of the neighbor tile limitation.</p>
<p>Do you think using Agents for moving obstacles, like I did, is a sound approach?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Perfect! I will clean the sample and push it to master.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Found the culprit for my issue with some connections unclimbable: as mask and areaID are not set to their default at creation, random values are assigned, making some connections non walkable. Enforcing to defaults, it never fails.</p>
<p>Is it OK to set mask and areaID to their default (1 and 0) at creation of the connection (I can fix this in OffMeshConnection.cpp), or is there a reason to not do so?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>No problem, I’ll fix this  <img alt=":wink:" class="emoji" src="../../../images2/95940790c23d98635b2a6d3f22657158.png" title=":wink:"/></p>
<p>Do you think it is possible to automate the tile(s) rebuild when removing a connection?</p>
<p>Not related, I noticed that after creating the DetourCrowdManager component, calling navMesh-&gt;Build() segfaults, which prevents from rebuilding the full scene.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>OK, thanks.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Currently, DetourCrowdManager assumes there’s only one navMesh, rooted to scene node (OnNodeSet()). Is this a limitation of DetourCrowd, or can we allow the use of multiple navMeshes that don’t belong directly to the scene root? I’ve tried to use SetNavigationMesh() just after creating the DetourCrowdManager but I still can’t add agents to it.</p>
<p>Also, the CreateCrowd() method is public and there exists some bindings for it. Not sure if this is good.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>What I’ve experimented is:</p>
<ul>
<li>create 2 independant navMeshes, not rooted to scene node</li>
<li>the goal is not to make them communicate, they are 2 separate worlds behaving on their own</li>
<li>creating a crowd manager fails, which is expected as it can’t pick a navMesh, so I used SetNavigationMesh() to ‘feed’ it with an already built navMesh</li>
<li>doing so, no agent get added to the crowd manager</li>
</ul>
<p>[spoiler][code]<br/>
require “LuaScripts/Utilities/Sample”</p>
<p>local crowdManager = nil<br/>
local agents = {}<br/>
local NUM_BARRELS = 0</p>
<p>function Start()<br/>
SampleStart()<br/>
CreateScene()<br/>
CreateUI()<br/>
SubscribeToEvents()<br/>
end</p>
<p>function CreateScene()<br/>
scene_ = Scene()<br/>
– Create octree, use default volume (-1000, -1000, -1000) to (1000, 1000, 1000)<br/>
– Also create a DebugRenderer component so that we can draw debug geometry<br/>
scene_:CreateComponent(“Octree”)<br/>
scene_:CreateComponent(“DebugRenderer”)</p>
<pre><code>-- ZONE
local zoneNode = scene_:CreateChild("Zone")
local zone = zoneNode:CreateComponent("Zone")
zone.boundingBox = BoundingBox(-1000, 1000)
zone.ambientColor = Color(0.15, 0.15, 0.15)
zone.fogColor = Color(0.5, 0.5, 0.7)
zone.fogStart = 100
zone.fogEnd = 300

-- LIGHT
local lightNode = scene_:CreateChild("DirectionalLight")
lightNode.direction = Vector3(0.6, -1, 0.8)
local light = lightNode:CreateComponent("Light")
light.lightType = LIGHT_DIRECTIONAL
light.castShadows = true
light.shadowBias = BiasParameters(0.00025, 0.5)
-- Set cascade splits at 10, 50 and 200 world units, fade shadows out at 80% of maximum shadow distance
light.shadowCascade = CascadeParameters(10, 50, 200, 0, 0.8)

-- CAMERA
cameraNode = Node()
local camera = cameraNode:CreateComponent("Camera")
camera.farClip = 300
cameraNode.position = Vector3(0, 5, 0)
renderer:SetViewport(0, Viewport:new(scene_, camera))
</code></pre>
<p>–====================  REGION <span class="hashtag">#1</span>  ==========================<br/>
local region1 = scene_:CreateChild(“Region1”)<br/>
region1:CreateComponent(“Navigable”)</p>
<pre><code>-- FLOOR
local planeNode = region1:CreateChild("Plane")
planeNode.scale = Vector3(50, 1, 100)
planeNode.position = Vector3(26, 0, 0)
local planeObject = planeNode:CreateComponent("StaticModel")
planeObject.model = cache:GetResource("Model", "Models/Plane.mdl")
planeObject.material = cache:GetResource("Material", "Materials/StoneTiled.xml")
planeNode:CreateComponent("Navigable")

-- BOX
local boxes = {}
for i = 1, 20 do
	local boxNode = region1:CreateChild("Box")
	local size = 1 + Random(8)
	boxNode.position = Vector3(26 + Random(40) - 20, size * 0.5, Random(80) - 40)
	boxNode:SetScale(size)
	local boxObject = boxNode:CreateComponent("StaticModel")
	boxObject.model = cache:GetResource("Model", "Models/Box.mdl")
	boxObject.material = cache:GetResource("Material", "Materials/Stone.xml")
	boxObject.castShadows = true
	if size &gt;= 3 then
		boxObject.occluder = true
		table.insert(boxes, boxNode)
	end
	boxNode:CreateComponent("Navigable")
end

-- DynamicNavigationMesh
local navMesh = region1:CreateComponent("DynamicNavigationMesh")
navMesh.drawObstacles = true
navMesh.drawOffMeshConnections = true
navMesh.agentHeight = 10
navMesh.cellHeight = 0.05
navMesh.padding = Vector3(0, 10, 0)
navMesh:Build()

-- DetourCrowdManager
crowdManager = scene_:CreateComponent("DetourCrowdManager")
crowdManager.navMesh = navMesh

-- CrowdAgent
SpawnJack(navMesh, Vector3(5, 0, 20))
</code></pre>
<p>–====================  REGION <span class="hashtag">#2</span>  ==========================<br/>
local region2 = scene_:CreateChild(“Region2”)<br/>
region2:CreateComponent(“Navigable”)</p>
<pre><code>-- FLOOR
local planeNode = region2:CreateChild("Plane")
planeNode.scale = Vector3(50, 1, 100)
planeNode.position = Vector3(-26, 0, 0)
local planeObject = planeNode:CreateComponent("StaticModel")
planeObject.model = cache:GetResource("Model", "Models/Plane.mdl")
planeObject.material = cache:GetResource("Material", "Materials/StoneTiled.xml")

-- BOX
local boxes = {}
for i = 1, 20 do
	local boxNode = region2:CreateChild("Box")
	local size = 1 + Random(8)
	boxNode.position = Vector3(-26 + Random(40) - 20, size * 0.5, Random(80) - 40)
	boxNode:SetScale(size)
	local boxObject = boxNode:CreateComponent("StaticModel")
	boxObject.model = cache:GetResource("Model", "Models/Box.mdl")
	boxObject.material = cache:GetResource("Material", "Materials/Stone.xml")
	boxObject.castShadows = true
	if size &gt;= 3 then
		boxObject.occluder = true
		table.insert(boxes, boxNode)
	end
end

-- DynamicNavigationMesh
local navMesh = region2:CreateComponent("DynamicNavigationMesh")
navMesh.drawObstacles = true
navMesh.drawOffMeshConnections = true
navMesh.agentHeight = 10
navMesh.cellHeight = 0.05
navMesh.padding = Vector3(0, 10, 0)
navMesh:Build()

-- DetourCrowdManager
</code></pre>
<p>–	local crowdManager2 = scene_:CreateComponent(“DetourCrowdManager”)<br/>
–	crowdManager2.navigationMesh = navMesh</p>
<pre><code>-- CrowdAgent
</code></pre>
<p>–	SpawnJack(navMesh, Vector3(-5, 0, 20))<br/>
end</p>
<p>function CreateUI()<br/>
– Create a Cursor UI element because we want to be able to hide and show it at will. When hidden, the mouse cursor will<br/>
– control the camera, and when visible, it will point the raycast target<br/>
local style = cache:GetResource(“XMLFile”, “UI/DefaultStyle.xml”)<br/>
local cursor = Cursor:new()<br/>
cursor:SetStyleAuto(style)<br/>
ui.cursor = cursor<br/>
– Set starting position of the cursor at the rendering window center<br/>
cursor:SetPosition(graphics.width / 2, graphics.height / 2)<br/>
end</p>
<p>function SubscribeToEvents()<br/>
SubscribeToEvent(“Update”, “HandleUpdate”)<br/>
end</p>
<p>function SpawnJack(navMesh, pos)<br/>
local jackNode = scene_:CreateChild(“Jack”)<br/>
jackNode.position = navMesh:FindNearestPoint(pos)<br/>
local modelObject = jackNode:CreateComponent(“AnimatedModel”)<br/>
modelObject.model = cache:GetResource(“Model”, “Models/Jack.mdl”)<br/>
modelObject.material = cache:GetResource(“Material”, “Materials/Jack.xml”)<br/>
modelObject.castShadows = true<br/>
jackNode:CreateComponent(“AnimationController”)</p>
<pre><code>-- Create a CrowdAgent component and set its height and realistic max speed/acceleration. Use default radius
local agent = jackNode:CreateComponent("CrowdAgent")
agent.height = 2
agent.maxSpeed = 4
agent.maxAccel = 100
agents = crowdManager:GetActiveAgents() -- Update agents container
print(#agents)
</code></pre>
<p>end</p>
<p>function SetPathPoint()<br/>
local hitPos, hitDrawable = Raycast(250.0)</p>
<pre><code>if hitDrawable then
	local region = hitDrawable.node.parent
	local navMesh = region:GetComponent("DynamicNavigationMesh")
    local pathPos = navMesh:FindNearestPoint(hitPos, Vector3.ONE)

    if input:GetQualifierDown(QUAL_SHIFT) then
        -- Spawn a Jack
        SpawnJack(navMesh, pathPos)

    elseif input:GetQualifierDown(QUAL_CTRL) and table.maxn(agents) &gt; NUM_BARRELS then
        -- Teleport
        local agent = agents[NUM_BARRELS + 1] -- Get first Jack agent
        local node = agent.node
        node:LookAt(pathPos) -- Face target
        agent:SetMoveVelocity(Vector3.ZERO) -- Stop agent
        node.position = pathPos

    else
        -- Set target position and init agents' move
        for i = NUM_BARRELS + 1, table.maxn(agents) do
            local agent = agents[i]
            if i == NUM_BARRELS + 1 then
                -- The first Jack agent will always move to the exact position and is strong enough to push barrels and his siblings (no avoidance)
                agent.navigationPushiness = PUSHINESS_HIGH
                agent:SetMoveTarget(pathPos)
            else
                -- Other Jack agents will move to a random point nearby
                local targetPos = navMesh:FindNearestPoint(pathPos + Vector3(Random(-4.5, 4.5), 0, Random(-4.5, 4.5)), Vector3.ONE)
                agent:SetMoveTarget(targetPos)
            end
        end
    end
end
</code></pre>
<p>end</p>
<p>function AddOrRemoveObject()<br/>
– Raycast and check if we hit a mushroom node. If yes, remove it, if no, create a new one<br/>
local hitPos, hitDrawable = Raycast(250)<br/>
if hitDrawable then</p>
<pre><code>	local hitNode = hitDrawable.node
	if hitNode.name == "Mushroom" then
		hitNode:Remove()
	elseif hitNode.name == "Jack" then
		hitNode:Remove()
		agents = crowdManager:GetActiveAgents() -- Update agents container
	else
		CreateMushroom(hitPos)
	end
end
</code></pre>
<p>end</p>
<p>function Raycast(maxDistance)<br/>
local pos = ui.cursorPosition<br/>
– Check the cursor is visible and there is no UI element in front of the cursor<br/>
if (not ui.cursor.visible) or (ui:GetElementAt(pos, true) ~= nil) then return nil, nil end</p>
<pre><code>local camera = cameraNode:GetComponent("Camera")
local cameraRay = camera:GetScreenRay(pos.x / graphics.width, pos.y / graphics.height)
-- Pick only geometry objects, not eg. zones or lights, only get the first (closest) hit
local octree = scene_:GetComponent("Octree")
local result = octree:RaycastSingle(cameraRay, RAY_TRIANGLE, maxDistance, DRAWABLE_GEOMETRY)
if result.drawable ~= nil then
	return result.position, result.drawable
end

return nil, nil
</code></pre>
<p>end</p>
<p>function MoveCamera(timeStep)<br/>
– Right mouse button controls mouse cursor visibility: hide when pressed<br/>
ui.cursor.visible = not input:GetMouseButtonDown(MOUSEB_RIGHT)</p>
<pre><code>-- Do not move if the UI has a focused element (the console)
if ui.focusElement ~= nil then
	return
end

-- Movement speed as world units per second
local MOVE_SPEED = 20
-- Mouse sensitivity as degrees per pixel
local MOUSE_SENSITIVITY = 0.1

-- Use this frame's mouse motion to adjust camera node yaw and pitch. Clamp the pitch between -90 and 90 degrees
-- Only move the camera when the cursor is hidden
if not ui.cursor.visible then
	local mouseMove = input.mouseMove
	yaw = yaw + MOUSE_SENSITIVITY * mouseMove.x
	pitch = pitch + MOUSE_SENSITIVITY * mouseMove.y
	pitch = Clamp(pitch, -90, 90)

	-- Construct new orientation for the camera scene node from yaw and pitch. Roll is fixed to zero
	cameraNode.rotation = Quaternion(pitch, yaw, 0)
end

-- Read WASD keys and move the camera scene node to the corresponding direction if they are pressed
if input:GetKeyDown(KEY_W) then cameraNode:Translate(Vector3(0, 0, 1) * MOVE_SPEED * timeStep) end
if input:GetKeyDown(KEY_S) then cameraNode:Translate(Vector3(0, 0, -1) * MOVE_SPEED * timeStep) end
if input:GetKeyDown(KEY_A) then cameraNode:Translate(Vector3(-1, 0, 0) * MOVE_SPEED * timeStep) end
if input:GetKeyDown(KEY_D) then cameraNode:Translate(Vector3(1, 0, 0) * MOVE_SPEED * timeStep) end

-- Set destination or spawn a jack with left mouse button
if input:GetMouseButtonPress(MOUSEB_LEFT) then
	SetPathPoint()
end
-- Add new obstacle or remove existing obstacle/agent with middle mouse button
if input:GetMouseButtonPress(MOUSEB_MIDDLE) then
	AddOrRemoveObject()
end

-- Check for loading/saving the scene from/to the file Data/Scenes/CrowdNavigation.xml relative to the executable directory
if input:GetKeyPress(KEY_F5) then
	scene_:SaveXML(fileSystem:GetProgramDir().."Data/Scenes/CrowdNavigation.xml")
end
if input:GetKeyPress(KEY_F7) then
	scene_:LoadXML(fileSystem:GetProgramDir().."Data/Scenes/CrowdNavigation.xml")
	-- After reload, reacquire crowd manager &amp; agents
	crowdManager = scene_:GetComponent("DetourCrowdManager")
	agents = crowdManager:GetActiveAgents()
end

-- Toggle debug geometry with space
if input:GetKeyPress(KEY_SPACE) then
	drawDebug = not drawDebug
end
</code></pre>
<p>end</p>
<p>function HandleUpdate(eventType, eventData)<br/>
– Move the camera, scale movement with time step<br/>
MoveCamera(eventData:GetFloat(“TimeStep”))</p>
<pre><code>-- Make the CrowdAgents face the direction of their velocity and update animation
for i, agent in ipairs(agents) do
	local node = agent.node
	if node.name == "Jack" then
		local animCtrl = node:GetComponent("AnimationController")
		local velocity = agent.actualVelocity
		if velocity:Length() &lt; 0.6 then
			animCtrl:Stop("Models/Jack_Walk.ani", 0.2)
		else
			node.worldDirection = velocity
			animCtrl:PlayExclusive("Models/Jack_Walk.ani", 0, true, 0.2)
			animCtrl:SetSpeed("Models/Jack_Walk.ani", velocity:Length() * 0.3)
		end
	end
end
</code></pre>
<p>end<br/>
[/code][/spoiler]</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Thanks, I must admit that this experiment is more to test the limits than for real-life practice, so it may not be worth investigating further.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>I am too experimenting with this sample lately. I have increased the number of “moving barrels” from 20 to 200 and spawned a few dozens of Jacks to walk around. In this scenario, one could observe easily a number of Jacks simply do not able to reach their targets due to the barrels on their paths. It is unexpected because they know how to walk around obstacles, yet they are easily stopped by the barrels as they are “too polite” to wait for barrels to clear the way which of course the barrels don’t. Currently only the pilot Jack is strong enough to throw its weight to push the barrels around. Long story short, setting the navigation pushiness to “high” to all the Jacks solves the problem so they can clear the paths by themselves. However, this creates yet another problem. The “high” setting makes Jacks do not play nice with each other. I have spent quite some time to tweak the settings but I could not get the result I desire. Basically, all jacks can push barrels but play nice by avoiding each other (instead of pushing each other). May be I have missed out some other settings. Anyone know how to achieve this?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<aside class="quote">
<div class="title">
<div class="quote-controls"></div>
 Sinoid:</div>
<blockquote>
<p>[quote]May be I have missed out some other settings.</p>
</blockquote>
</aside>
<p>Nope, there isn’t a whole lot there - big black box.</p>
<p>To explain pushiness: as pushiness increases the agent’s “pending collision range” and separation space it likes between itself and others decreases. A less pushy agent stays further away and avoids sooner. A pushier agent practically runs everyone over, forcing less pushy agents away because their separation space has been violated.[/quote]<br/>
Thanks for the reply. Yes, I have understood that much. I could almost conclude myself that it is not possible to achieve what I desire with the current crowd agent setup alone. As it is, the “pushiness” or “niceness” of the crowd agent is an absolute setting instead of relative one. That is, it does not know how to handle the other agents differently based on their own “weight”, which is a pity. To me, it appears that the only way to achieve my desired effect is to use the Physics proper.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">franck22000</div>
          <div class="post_content">
<p>In my old engine i was using recast and i was using navmesh obstacles for dealing wit obstacles. Why it is not possible on the current implementation ? <img alt=":slight_smile:" class="emoji" src="../../../images2/ab33f6c546ca85e7d84a4e3c32cd4034.png" title=":slight_smile:"/></p>
<p>[video]<a href="https://www.youtube.com/watch?v=EXQuJvMiY-o%5B/video%5D" rel="nofollow noopener">https://www.youtube.com/watch?v=EXQuJvMiY-o[/video]</a></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>I believe you have missed the point of what the barrel in the sample is trying to emulate. If we use the actual “obstacle” to implement the barrel and partially rebuild the nav mesh when it has moved then there should be also no problem with our current implementation. The sample intentionally uses the “crowd agent” to implement the barrel to simulate a “moving obstacle” to avoid the cost of rebuilding the nav mesh. And this is where the problem begins.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">franck22000</div>
          <div class="post_content">
<p>Alright weitjong now i see <img alt=":slight_smile:" class="emoji" src="../../../images2/ab33f6c546ca85e7d84a4e3c32cd4034.png" title=":slight_smile:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>@ weitjong, did you try with low pushiness (or medium) + low navigation quality for agents?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<aside class="quote no-group" data-username="Mike">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/ffc8d24cecba4d07683b8100d0de8b79.png" width="20"/> Mike:</div>
<blockquote>
<p>@ weitjong, did you try with low pushiness (or medium) + low navigation quality for agents?</p>
</blockquote>
</aside>
<p>I think I have tried all the combinations of pushiness setting that make sense but none work. I have not tried to modify the navigation quality though. However, as per explanation from Sinod and also from my experiment observation, it is simply not possible to do with crowd agent alone due to agent pushiness setting cannot be set relatively, say, Jack to another Jack is “medium” and Jack to another barrel is “high”, or something like that.</p>
<p>I have almost complete experimenting with the sample. I have also made changes and bug fixes in the DetourCrowd implementation classes along the way. There is one more thing I observed that looks strange to me. When an agent reaches its target, a target “arrived” state change event is fired. This is expected. However, somehow it will be followed by yet another agent reposition and target “valid” state change events before everything comes to a full stop. To me, these reposition and target “valid” state change event should not have occurred and that the target “arrived” should be the last event. <span class="mention">@Sinoid</span>, do you know why it happens and can it be prevented? In my revised sample, I plan to use the target “arrived” event to stop the walking animation. Currently it does not work well because the following “bogus” reposition event starts the animation again immediately after.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>Thanks for the quick reply. I will take a closer look at that GetTargetState() function again tomorrow. I was (still am) kind of lost with the “corner” thingy earlier. It is quite late here already. Stopping the animation correctly is the last thing I want to do before committing my patch. You can go ahead to push yours.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>I have just pushed my patch to master branch. <span class="mention">@Sinoid</span>, feel free to revert back any of the changes.</p>
<p>I am this close to remove the barrel agents for emulating the moving obstacles as they don’t work as expected with any combination of the pushiness I have tried. I also feel that it does not fit the purpose of the sample to demonstrate a proper usage of the CrowdAgent class. Anyway, that is only my opinion so in the end I just leave them untouched in the sample.</p>
<p>While refactoring the DetourCrowd implementation, I notice that a few setter methods call MarkNetworkUpdate(), however, there are no corresponding network attribute to be propagated remotely. I don’t have the time to clean up those yet. I think they should either have the network attribute added or just remove the call if the network attribute does not make sense for the specific setter method.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>Just a head up. I am still in refactoring mode or mood, so expect more changes to come. Although I agree with you that we have to be careful not to flood the network when agents are being updated, we should also at the same time keep all the crowd managers in the network to update the crowd agents in a deterministic way. So, IMHO, in order to achieve this then all the agent’s attributes and parameters must be in sync across the network.</p>
<p>I have a few questions (not related to the above). It looks to me there may be a copy-paste error here. <a >github.com/urho3d/Urho3D/blob/m … #L343-L373</a>. I have to admit I have no experience with DetourCrowd before so I don’t know what is the sensible settings for low, medium, and high navigation quality. I suppose the “obstacleAvoidanceType” setting should be different in each case. At the moment it always stays at 3 (because it is also initialized to 3 when the agent is added initially). Line 355 appears to be redundant. And with that line removed then the “updateFlags” is effectively the same between low and medium[?]</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>Thanks for your insight. It would be good to hear from the original author also. Aside from the apparently copy-paste error, there may be a good reason why the flags are being set as they are now. Why the DT_CROWD_SEPARATION flag is not set in the “high” setting, but effectively DT_CROWD_SEPARATION flag is the only remaining after the bitwise flip for the “low” and “medium”. If I could do it my way then I would probably set the flags for “low”, “medium”, and “high” based on the amount of CPU processing they require (see DetourCrowd::Update() implementation). Something like this.</p>
<pre><code class="lang-auto">        if (scope &amp; SCOPE_NAVIGATION_QUALITY_PARAMS)
        {
            switch (navQuality_)
            {
            case NAVIGATIONQUALITY_LOW:
                params.updateFlags = 0
                    | DT_CROWD_OPTIMIZE_VIS
                    | DT_CROWD_ANTICIPATE_TURNS;
                break;

            case NAVIGATIONQUALITY_MEDIUM:
                params.updateFlags = 0
                    | DT_CROWD_OPTIMIZE_TOPO
                    | DT_CROWD_OPTIMIZE_VIS
                    | DT_CROWD_ANTICIPATE_TURNS
                    | DT_CROWD_SEPARATION;
                break;

            case NAVIGATIONQUALITY_HIGH:
                params.obstacleAvoidanceType = 3;
                params.updateFlags = 0
                    // Path finding
                    | DT_CROWD_OPTIMIZE_TOPO
                    | DT_CROWD_OPTIMIZE_VIS
                    // Steering
                    | DT_CROWD_ANTICIPATE_TURNS
                    | DT_CROWD_SEPARATION
                    // Velocity planning
                    | DT_CROWD_OBSTACLE_AVOIDANCE;
                break;
            }
        }</code></pre>
<p>But then again, as I said I have no past experience to justify any of this. The “obstacleAvoidanceType” setting is really only required for the last case as only there the “DT_CROWD_OBSTACLE_AVOIDANCE” flag is set. I think it should be made as a standalone attribute/property so it can be set/get separately instead of always hardcoding it to type 3.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>I have created another branch for the refactoring work. Reason being, the changes break a few of the APIs. The params.updateFlags switch cases is now modified to what I have proposed in my earlier post. Please shout early when any of you don’t like where the new branch is heading.</p>
<p>Today I find yet another discrepancy between what is expected by NavigationMesh component class and (Detour)CrowdManager component class. From what I understand, the former expects to receive and return position in world coordinate, while the latter expects them in local coordinate. More precisely, the latter assumes the local and world coordinates are to be the same because it always assume the dtCrowd is initialized with navmesh parented to root scene node. I find it a little bit disturbing. Should we not making that assumption and always perform the world &lt;-&gt; local coordinate conversion in the CrowdManager/CrowdAgent components? It will make it easier should we later decide to support navmesh to be parented in any node. Actually this point has been brought up by Mike earlier. Are there any practicality in supporting multiple (disconnected) navmeshes in a single scene hierarchy?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">cadaver</div>
          <div class="post_content">
<p>I originally wrote the basic NavigationMesh to take into account that it might not be in the scene root, and might not have zero origin, so doing the same for CrowdManager would be logical. There may be an issue how the crowdmanager will find the navmesh if not in scene root, and likewise how the agents will find the crowdmanager if not in scene root, though.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">thebluefish</div>
          <div class="post_content">
<p>Well say I wanted 8 different, completely unrelated crowds. Right now it doesn’t seem like that would be possible because we’re limited to one CrowdManager.</p>
<p>Simplest idea is to have the agents check its parent, its parent’s parent, etc… up the tree until it finds a parent with a CrowdManager component, then use that. Alternatively have an Attribute with a Node ID or Component ID.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<aside class="quote no-group" data-username="Sinoid">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/364b15125065144cbdd62e2448806aa6.png" width="20"/> Sinoid:</div>
<blockquote>
<p>Ah, local/world space. NavAreas are wrong, both in debug visualization and marking in the navigation mesh. DebugDraw has to be relative to the space of the navmesh as the bounds has to be an AABB relative to the dtNavMesh.</p>
</blockquote>
</aside>
<p>I cannot decide which is more important to do first. Supporting navmesh in any node or fixing those coordinate space conversion first? If a navmesh can be made to attach to a transformed node then it will be easy to spot the coordinate space mistake. On the other hand, I am still not sure whether there is any valid use cases for (multiple) navmesh attached to any node, but probably it is easier to justify to have a single navmesh attached to a non-scene node. The problem of searching the correct navmesh (should we have more than one in the scene hierarchy) is a solvable one though. I think it is understandable that multiple navmesh support requires multiple dtCrowd objects (probably still being managed by one CrowdManager class).</p>
<aside class="quote no-group" data-username="Sinoid">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/364b15125065144cbdd62e2448806aa6.png" width="20"/> Sinoid:</div>
<blockquote>
<p>Who belongs to which NavigationMesh? As in navigables, obstacles, and navareas. Just those beneath it in the scene tree from the mesh?</p>
</blockquote>
</aside>
<p>Yes, that is the most sensible way to do it. So, if an application had chosen to attach the navmesh in the scene node then the navmesh would be built using all the components beneath the scene node similar to what we have now. No surprises.</p>
<aside class="quote no-group" data-username="thebluefish">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/bf1ad5330f9831ec6d82214e91751e5d.png" width="20"/> thebluefish:</div>
<blockquote>
<p>Well say I wanted 8 different, completely unrelated crowds. Right now it doesn’t seem like that would be possible because we’re limited to one CrowdManager.</p>
</blockquote>
</aside>
<p>Aside from memory footprint problem pointed by Sinoid, I don’t agree this is a valid reason or use case for having multiple navmesh. I could be wrong but from the context, I think you meant to say “8 crowds moving to 8 different target positions (from a same navmesh)”. If so then that is doable now with current implementation. The dtCrowd just simulates the crowd movement. It does not really care much where each agent is going or whether they are going in flock.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p><span class="mention">@Sinoid</span>. Thanks for the offer. My refactoring was abruptly disrupted by my attempt to switch IDE from Eclipse to CLion. In the process I had to side track to perform yet another refactoring to make our code base plays nice with CLion. I will attempt to rebase the refactor-crowd branch when I have time later to bring it up to speed. I am sorry that I could not give you any notes as I am not sure myself where I have left off last time.  <img alt=":wink:" class="emoji" src="../../../images2/95940790c23d98635b2a6d3f22657158.png" title=":wink:"/>  But I do have local commit that I haven’t pushed and some unfinished work in git stash.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>The refactor-crowd branch is now rebased and reformat to match what we have in the master branch. Be my guest to send PR against it (or you can probably write to Lasse to become Urho3D team member and grant you direct push privilege). I think I remember now where I left it. I think I want to make the navMesh to be auto-discovered in the scene hierarchy, i.e. freeing it from the assumption that it is direct child of root scene node. As such, the component(s) need to perform world &lt;–&gt; local coordinate space transformation as necessary. I also intend to clean up the classes as necessary and to make them better integrate with the Scene Editor. I think I am only done doing that for CrowdAgent and CrowdManager class. The changes are not necessarily backward compatible. I will continue to work on this branch when I have time.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p><span class="mention">@cadaver</span>, any objection to merge this branch in as it is? Although the refactoring work to make the navMesh auto-discovered in the scene hierarchy with world &lt;–&gt; local coordinate space transformation has not been completed yet, some of the work to improve the attribute editing for the CrowdAgent &amp; CrowdManager in Editor should be valuable enough to be merged for earlier testing. As mentioned before, some of the changes are not backward compatible. But at the very least, as it is now the branch is at a nice logical break point where early merge does not break the build and the crowd navigation demo still runs. This way, I don’t need to keep rebasing it.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">cadaver</div>
          <div class="post_content">
<p>No objections.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Seems that NavigationMesh::GetRandomPoint() no longer works in script (always returns a Vector3::ZERO).<br/>
This is certainly due to the Detour parameters of the function (dtQueryFilter and dtPolyRef).</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>I am not able to reproduce your problem using Lua script. Both the NavigationMesh::GetRandomPoint() and CrowdManager::GetRandomPoint() are tested. Are you mixing up the usage between these two? The latter requires a “queryFilterType” argument.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>Thanks, I’m using NavigationMesh::GetRandomPoint() with AngelScript.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/4_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">weitjong</div>
          <div class="post_content">
<p>I am using 39_CrowdNavigation.as to test. Replacing the GetRandomPointInCircle() with GetRandomPoint(). Also called the navmesh version instead of crowdmanager version. They work as expected. I am using the latest master branch revision. I am testing using Linux platform as always. Both the Lua and AngelScript bindings rely on the fact that dtQueryFilter* and dtPolyRef* parameters will be defaulted to 0. I think I have done enough regression test before making that change while the code were still in the refactoring branch. I would be surprised if the same code runs differently on other target platforms though.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">Mike</div>
          <div class="post_content">
<p>EDIT: has been fixed by this <a data-bbcode="true" >commit</a>.</p>
          </div>
        </div>
      </div>


    </div>
  </body>
</html>