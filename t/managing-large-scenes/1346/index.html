<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width">
    <title>Managing large scenes</title>
    <link rel="stylesheet" href="../../../archived.css" />
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']]}});
    </script>
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  </head>

  <body>
    <header class="header">
      <div class="title-span">
        <a href="../../../">
          <img src="../../../images/site-logo.png" height="40" alt="Urho3D" id="site-logo" />
        </a>
      </div>
    </header>

    <div class="main">
    <div class="archive-span">Archive 17/01/2023.</div>
    <h1 class="topic-title">Managing large scenes</h1>
            <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">gabdab</div>
          <div class="post_content">
<p>I am setting up a large forest scene .<br/>
Are node clone or clonecomponent viable strategies for like :<br/>
main:<br/>
Instantiate a minimum number of <span class="bbcode-b">base models</span> in main ,with static models.</p>
<p>update:<br/>
Search in a larger group of nodes for those (without component, just pos rot scale) inside a <span class="bbcode-b">sphere centered on player </span>, with the help of <span class="bbcode-b">kd trees</span> .</p>
<p><span class="bbcode-b">Clone</span> <span class="bbcode-i">base models</span> component (<span class="bbcode-i">static model</span>) for sphere contained nodes .</p>
<p><span class="bbcode-b">Remove</span> component for nodes outside sphere .</p>
<p>?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/55_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rasteron</div>
          <div class="post_content">
<p>Providing your scene models with LODs will definitely help with larger scenes like forest. Managing Draw Distances is also a must have. Having multiple zones is good but this will depend on your setup. I remember in Torque3D, the tree system have a lowest LOD set to billboard (autogenerated) which is kinda handy so with Urho3D, a script object that will handle it will be enough.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">gabdab</div>
          <div class="post_content">
<p>Is it possible to instanciate node’s component (as in Blender -linked duplicates-) instead of cloning ?<br/>
Is it frame safe to draw many transparent images on all platforms (Android) ?<br/>
Also , cloning/removing approximatively 100 (static model) components on update would be aggressive on memory usage ?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">cadaver</div>
          <div class="post_content">
<p>The update scheme you describe should be perfectly possible at least on desktop machines. For mobiles I don’t make promises, you’ll have to test. One StaticModel component + its node shouldn’t take more than about 0,5 KB of memory. Urho doesn’t support “linked” duplicate components at runtime, but the per-instance attributes are fairly lightweight (model reference, material reference, flags/variables like cast shadows and viewmask). If you want to optimize, doing things like SetModel() and SetMaterial() manually to the new component is probably faster than using the Clone() function, which goes through the generic attribute mechanism.</p>
<p>Another way is to instantiate and remove rectangular world “tiles” as the player moves around, though this can create some framerate hitching.</p>
<p>Heavy use of transparent images can be a blend/fillrate killer on mobiles, so again, you’ll need to test what is too much for your target hardware.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/55_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rasteron</div>
          <div class="post_content">
<p>Hey Lasse, since we’re in this subject, it’s already supported and I just remember to ask, how do you toggle hardware instancing on/off to compare performance results?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">cadaver</div>
          <div class="post_content">
<p>Renderer::SetDynamicInstancing(true/false) or renderer.dynamicInstancing</p>
<p>Note: GLES2 does not support instancing.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/55_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rasteron</div>
          <div class="post_content">
<p>[quote=“cadaver”]Renderer::SetDynamicInstancing(true/false) or renderer.dynamicInstancing</p>
<p>Note: GLES2 does not support instancing.[/quote]</p>
<p>great! thanks <img alt=":slight_smile:" class="emoji" src="../../../images2/ab33f6c546ca85e7d84a4e3c32cd4034.png" title=":slight_smile:"/></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">gabdab</div>
          <div class="post_content">
<aside class="quote">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/17ea6233fe86521c2e3179bd3849d219.png" width="20"/> cadaver:</div>
<blockquote>
<p>. Urho doesn’t support “linked” duplicate components at runtime.</p>
</blockquote>
</aside>
<p>…what would it be the quickest route to avoid duplication of loaded models on memory ,from the engine point of view ?<br/>
To be clear :<br/>
If I load a scene with 100 nodes (component - static model - ‘man.mdl’) , how many times is man.mdl read and how many copies of it are kept in memory ?</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">cadaver</div>
          <div class="post_content">
<p>Once. This is managed by ResourceCache. After the model is initially loaded (first SetModel() call by the first object) the subsequent SetModel() calls will just query the model from the resource cache and this will be rather fast.</p>
<p>What I meant with “linking not supported” is that component attributes (like model and material references, cast shadows flag etc.) cannot be referenced from a “source” component, but rather each object contains its own unique copies of these.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">gabdab</div>
          <div class="post_content">
<p>from a few tests I would say that this is the best option .<br/>
Cloning and removing static model’s components from the scene at runtime is too heavy on frames per second …<br/>
All new mobiles comes with at least 1 gb ram , I guess this would be enough to handle large scenes …</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/87_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">sabotage3d</div>
          <div class="post_content">
<p>Don’t want to hijack the thread but I am currently merging all the instances together for mobile to reduce the draw calls is that a good strategy ? For example I have a lot of trees and rocks scattered on terrain. I am merging the rocks, trees and terrain each separately into single mdl.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">gabdab</div>
          <div class="post_content">
<aside class="quote">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/db4c02596e658dc9102b66ceb5fb9d80.png" width="20"/> sabotage3d:</div>
<blockquote>
<p>Don’t want to hijack the thread but I am currently merging all the instances together for mobile to reduce the draw calls is that a good strategy ? For example I have a lot of trees and rocks scattered on terrain. I am merging the rocks, trees and terrain each separately into single mdl.</p>
</blockquote>
</aside>
<p>If I understood correctly , it is better to leave models separated .<br/>
If you merge them they collectively get drawn even if some are out of camera frustum .<br/>
Alternatively some get drawn some not , and you save memory .</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">gabdab</div>
          <div class="post_content">
<p>How do you retrieve a list of nodes that are currently inside frustum ?<br/>
FrustumOctreeQuery ,how do you invoke it exactly ?<br/>
It would speed up operations on nearby nodes …<br/>
I managed to use a kd tree for operations on nodes in a radius from the player , but it is redundant with the engine octree somehow .</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">gabdab</div>
          <div class="post_content">
<p>Working like a charm, thanks :</p>
<p>[code]//init:<br/>
PODVector&lt;Drawable*&gt; tempDrawables ;<br/>
Urho3D::Octree* octree_;		<br/>
octree_ = globals::instance()-&gt;scene-&gt;GetComponent();</p>
<p>//update:<br/>
const Frustum&amp; frustum = globals::instance()-&gt;camera-&gt;GetFrustum();		<br/>
FrustumOctreeQuery octreeQuery(tempDrawables, frustum,DRAWABLE_GEOMETRY);<br/>
octree_-&gt;GetDrawables(octreeQuery);<br/>
for (unsigned i = 0; i &lt; tempDrawables.Size(); ++i)<br/>
{<br/>
// if (tempDrawables[i]-&gt;IsInView() )<br/>
std::cout&lt;&lt;"d "&lt;&lt;tempDrawables[i]-&gt;GetNode()-&gt;GetName().CString()&lt;&lt;std::endl;<br/>
}[/code]</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">cadaver</div>
          <div class="post_content">
<p>You can also access a viewport’s View object and get the geometries (View::GetGeometries()) that were visible last frame, that avoids wasting time on double queries.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/119_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">codingmonkey</div>
          <div class="post_content">
<blockquote>
<p>for mobile to reduce the draw calls is that a good strategy</p>
</blockquote>
<p>also you may try to use clip planes with two scenes.<br/>
near scene to camera is detail scene and far scene is lowpoly scene with lowpoly trees and grass…<br/>
you render only half each of them, then merging these parts with post process shader to one frame</p>
<p><a data-bbcode="true" href="http://savepic.su/6124265.htm"><img alt="" height="" src="../../../images2/8dfc67128bba37d581f00d737838577c.jpg" width=""/></a></p>
<p><a data-bbcode="true" href="http://savepic.su/6157032.htm"><img alt="" height="" src="../../../images2/0a25b49751e946db81a731a662072cff.jpg" width=""/></a></p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">TikariSakari</div>
          <div class="post_content">
<p>Something that I’ve noticed, that might cause quite a high performance for mobile is the water shader in Urho. On my low performance android phone the shader itself, although I might use it wrongly, can use more than 10-15ms per frame. This is basically just setting plane and adding the water-material on it.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/3_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">cadaver</div>
          <div class="post_content">
<p>You probably should make your own lightweight water shader; the one that comes with Urho3D has been made and tested on desktops. It doesn’t look especially heavy, but it calculates UVs in the pixel shader (= dependent texture reads) which is performance hell on mobiles.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/55_2.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">rasteron</div>
          <div class="post_content">
<p>Found a water shader for mobile, apparently it is a Unity Shader/Asset but it looks complete…</p>
<p><a href="http://nevzatarman.com/2014/10/10/unity-water-shaders/" rel="nofollow noopener">nevzatarman.com/2014/10/10/unity-water-shaders/</a></p>
<p><img alt="" height="314" src="../../../images2/8d0e1c5bf281a3d4b5248ca0223ccc1a.gif" width="542"/></p>
<p>Github Repo:<br/>
<a href="https://github.com/paganini24/UnityWaterShadersTest" rel="nofollow noopener">github.com/paganini24/UnityWaterShadersTest</a></p>
<p>public domain license.</p>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">gabdab</div>
          <div class="post_content">
<aside class="quote">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/17ea6233fe86521c2e3179bd3849d219.png" width="20"/> cadaver:</div>
<blockquote>
<p>You can also access a viewport’s View object and get the geometries (View::GetGeometries()) that were visible last frame, that avoids wasting time on double queries.</p>
</blockquote>
</aside>
<pre><code class="lang-auto">SharedPtr&lt;Viewport&gt; viewport(new Viewport(context_,scene_,cameraNode_-&gt;GetComponent&lt;Camera&gt;()));

tempDrawables = viewport-&gt;GetView()-&gt;GetGeometries ();[/code]
Gives me 
[code] /home/gabriele/Programmi/Urho3D-1.4/Project_1.7_USP/main.cpp:198:36: error: invalid use of incomplete type ?class Urho3D::View?
   tempDrawables=viewport-&gt;GetView()-&gt;GetGeometries ();
                                    ^
In file included from /home/gabriele/Programmi/Urho3D-1.4/Project_1.7_USP/URHO3D/include/Urho3D/Graphics/Renderer.h:25:0,
                 from /home/gabriele/Programmi/Urho3D-1.4/Project_1.7_USP/main.cpp:29:
/home/gabriele/Programmi/Urho3D-1.4/Project_1.7_USP/URHO3D/include/Urho3D/Graphics/../Graphics/Batch.h:44:7: note: forward declaration of class Urho3D::View?
 class View;
</code></pre>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">thebluefish</div>
          <div class="post_content">
<aside class="quote no-group" data-username="gabdab">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="../../../images2/e29ba3433688cf677c49f9d98833423f.png" width="20"/> gabdab:</div>
<blockquote>
<p>[quote=“cadaver”]You can also access a viewport’s View object and get the geometries (View::GetGeometries()) that were visible last frame, that avoids wasting time on double queries.</p>
</blockquote>
</aside>
<p>[code]<br/>
SharedPtr viewport(new Viewport(context_,scene_,cameraNode_-&gt;GetComponent()));</p>
<p>tempDrawables = viewport-&gt;GetView()-&gt;GetGeometries ();[/code]<br/>
Gives me</p>
<p><code> error: invalid use of incomplete type ?class Urho3D::View?
   tempDrawables=globals::instance()-&gt;viewport-&gt;GetView()-&gt;GetGeometries ();
</code>[/quote]</p>
<pre><code class="lang-auto">#include &lt;Urho3D/Graphics/View.h&gt;</code></pre>
          </div>
        </div>
      </div>

      <div class="post_container">
        <div class="avatar_container">
          <img src="../../../images/{size}.png" class="avatar" />
        </div>
        <div class="post">
          <div class="user_name">gabdab</div>
          <div class="post_content">
<p>Perfect,thanks  <img alt=":smiley:" class="emoji" src="../../../images2/c16ddadcbd525aa6d219a1df596d362f.png" title=":smiley:"/></p>
<p>[code]		View* v = globals::instance()-&gt;viewport-&gt;GetView();<br/>
tempDrawables=v-&gt;GetGeometries ();</p>
<p>//const Frustum&amp; frustum1 = globals::instance()-&gt;camera-&gt;GetFrustum();		<br/>
//FrustumOctreeQuery octreeQuery(tempDrawables, frustum1,DRAWABLE_GEOMETRY);<br/>
//octree_-&gt;GetDrawables(octreeQuery);<br/>
for (unsigned i = 0; i &lt; tempDrawables.Size(); ++i)<br/>
{<br/>
//if (tempDrawables[i]-&gt;IsInView() )<br/>
std::cout&lt;&lt;"d "&lt;&lt;tempDrawables[i]-&gt;GetNode()-&gt;GetName().CString()&lt;&lt;std::endl;<br/>
}[/code]</p>
          </div>
        </div>
      </div>


    </div>
  </body>
</html>